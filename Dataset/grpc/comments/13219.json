[
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/341689097",
    "html_url": "https://github.com/grpc/grpc/issues/13219#issuecomment-341689097",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13219",
    "id": 341689097,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MTY4OTA5Nw==",
    "user": {
      "login": "jtattermusch",
      "id": 9939684,
      "node_id": "MDQ6VXNlcjk5Mzk2ODQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9939684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtattermusch",
      "html_url": "https://github.com/jtattermusch",
      "followers_url": "https://api.github.com/users/jtattermusch/followers",
      "following_url": "https://api.github.com/users/jtattermusch/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtattermusch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtattermusch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtattermusch/subscriptions",
      "organizations_url": "https://api.github.com/users/jtattermusch/orgs",
      "repos_url": "https://api.github.com/users/jtattermusch/repos",
      "events_url": "https://api.github.com/users/jtattermusch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtattermusch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-03T12:23:30Z",
    "updated_at": "2017-11-03T12:23:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "CC @jtattermusch"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/341694582",
    "html_url": "https://github.com/grpc/grpc/issues/13219#issuecomment-341694582",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13219",
    "id": 341694582,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MTY5NDU4Mg==",
    "user": {
      "login": "jtattermusch",
      "id": 9939684,
      "node_id": "MDQ6VXNlcjk5Mzk2ODQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9939684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtattermusch",
      "html_url": "https://github.com/jtattermusch",
      "followers_url": "https://api.github.com/users/jtattermusch/followers",
      "following_url": "https://api.github.com/users/jtattermusch/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtattermusch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtattermusch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtattermusch/subscriptions",
      "organizations_url": "https://api.github.com/users/jtattermusch/orgs",
      "repos_url": "https://api.github.com/users/jtattermusch/repos",
      "events_url": "https://api.github.com/users/jtattermusch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtattermusch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-03T12:50:36Z",
    "updated_at": "2017-11-03T12:50:36Z",
    "author_association": "CONTRIBUTOR",
    "body": "happening in ~50% of runs."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/341734755",
    "html_url": "https://github.com/grpc/grpc/issues/13219#issuecomment-341734755",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13219",
    "id": 341734755,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MTczNDc1NQ==",
    "user": {
      "login": "jtattermusch",
      "id": 9939684,
      "node_id": "MDQ6VXNlcjk5Mzk2ODQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9939684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtattermusch",
      "html_url": "https://github.com/jtattermusch",
      "followers_url": "https://api.github.com/users/jtattermusch/followers",
      "following_url": "https://api.github.com/users/jtattermusch/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtattermusch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtattermusch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtattermusch/subscriptions",
      "organizations_url": "https://api.github.com/users/jtattermusch/orgs",
      "repos_url": "https://api.github.com/users/jtattermusch/repos",
      "events_url": "https://api.github.com/users/jtattermusch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtattermusch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-03T15:21:48Z",
    "updated_at": "2017-11-04T17:06:39Z",
    "author_association": "CONTRIBUTOR",
    "body": "I analyzed in a debugger, and it's pretty similar to what we've been seeing in \r\nhttps://github.com/grpc/grpc/issues/13079.\r\n\r\nThe test hangs in (only for cq_polling_type=GRPC_CQ_NON_POLLING)\r\nhttps://github.com/grpc/grpc/blob/ef68fe7239a89095f1eaa89c1dd28b2b7be2a3c7/test/core/surface/completion_queue_test.c#L117\r\n(basically call cq_next on empty completion queue that should timeout immediately)\r\n\r\nhttps://github.com/grpc/grpc/blob/ef68fe7239a89095f1eaa89c1dd28b2b7be2a3c7/src/core/lib/surface/completion_queue.cc#L950\r\nIn the instance I debugged, grpc_exec_ctx_now() returns 7 and deadline_millis is 8, so the cq_next cycle never breaks (and it also explains why it's sometimes passing - if we get lucky and the two timestamps are equal, cq_next will return normally). All other instances where it hung I saw the difference in millis was 1.\r\n\r\nStill investigating.\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/341752644",
    "html_url": "https://github.com/grpc/grpc/issues/13219#issuecomment-341752644",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13219",
    "id": 341752644,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MTc1MjY0NA==",
    "user": {
      "login": "jtattermusch",
      "id": 9939684,
      "node_id": "MDQ6VXNlcjk5Mzk2ODQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9939684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtattermusch",
      "html_url": "https://github.com/jtattermusch",
      "followers_url": "https://api.github.com/users/jtattermusch/followers",
      "following_url": "https://api.github.com/users/jtattermusch/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtattermusch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtattermusch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtattermusch/subscriptions",
      "organizations_url": "https://api.github.com/users/jtattermusch/orgs",
      "repos_url": "https://api.github.com/users/jtattermusch/repos",
      "events_url": "https://api.github.com/users/jtattermusch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtattermusch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-03T16:18:33Z",
    "updated_at": "2017-11-03T16:20:03Z",
    "author_association": "CONTRIBUTOR",
    "body": "Ok, I think I found the problem:\r\n\r\nIn\r\nhttps://github.com/grpc/grpc/blob/ef68fe7239a89095f1eaa89c1dd28b2b7be2a3c7/src/core/lib/surface/completion_queue.cc#L950, exec_ctx->now_is_valid is false, so grpc_exec_ctx_now needs to refresh the timestamp here:\r\nhttps://github.com/grpc/grpc/blob/ef68fe7239a89095f1eaa89c1dd28b2b7be2a3c7/src/core/lib/surface/completion_queue.cc#L890\r\n\r\nit's done using `timespec_to_atm_round_down`.  But, when cq_next started, we set the deadline_millis and rounded up:\r\nhttps://github.com/grpc/grpc/blob/ef68fe7239a89095f1eaa89c1dd28b2b7be2a3c7/src/core/lib/surface/completion_queue.cc#L890\r\n\r\nSo if we get lucky and round_up = round_down, the test passes. Otherwise it hangs forever, as exec_ctx->now = deadline_millis - 1 and stays there forever as the cq is not doing work and we never invalidate the exec_ctx->now.\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/341762220",
    "html_url": "https://github.com/grpc/grpc/issues/13219#issuecomment-341762220",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13219",
    "id": 341762220,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MTc2MjIyMA==",
    "user": {
      "login": "jtattermusch",
      "id": 9939684,
      "node_id": "MDQ6VXNlcjk5Mzk2ODQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9939684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtattermusch",
      "html_url": "https://github.com/jtattermusch",
      "followers_url": "https://api.github.com/users/jtattermusch/followers",
      "following_url": "https://api.github.com/users/jtattermusch/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtattermusch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtattermusch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtattermusch/subscriptions",
      "organizations_url": "https://api.github.com/users/jtattermusch/orgs",
      "repos_url": "https://api.github.com/users/jtattermusch/repos",
      "events_url": "https://api.github.com/users/jtattermusch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtattermusch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-03T16:50:29Z",
    "updated_at": "2017-11-03T16:50:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "Btw, I think the issue exists on linux too, but we are not seeing it as the granularity of timestamp increments is much finer than on Windows (so we need to get really unlucky to hit the condition in the test)."
  }
]
