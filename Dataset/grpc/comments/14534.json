[
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/368717232",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-368717232",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 368717232,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2ODcxNzIzMg==",
    "user": {
      "login": "murgatroid99",
      "id": 961599,
      "node_id": "MDQ6VXNlcjk2MTU5OQ==",
      "avatar_url": "https://avatars3.githubusercontent.com/u/961599?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/murgatroid99",
      "html_url": "https://github.com/murgatroid99",
      "followers_url": "https://api.github.com/users/murgatroid99/followers",
      "following_url": "https://api.github.com/users/murgatroid99/following{/other_user}",
      "gists_url": "https://api.github.com/users/murgatroid99/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/murgatroid99/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/murgatroid99/subscriptions",
      "organizations_url": "https://api.github.com/users/murgatroid99/orgs",
      "repos_url": "https://api.github.com/users/murgatroid99/repos",
      "events_url": "https://api.github.com/users/murgatroid99/events{/privacy}",
      "received_events_url": "https://api.github.com/users/murgatroid99/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-02-27T01:45:56Z",
    "updated_at": "2018-02-27T01:45:56Z",
    "author_association": "MEMBER",
    "body": "That profile is misleading. The `Grpc\\Call::startBatch` function includes the call to `grpc_completion_queue_pluck`, which includes all of the time waiting for network events."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/368732033",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-368732033",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 368732033,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2ODczMjAzMw==",
    "user": {
      "login": "dwsupplee",
      "id": 2079879,
      "node_id": "MDQ6VXNlcjIwNzk4Nzk=",
      "avatar_url": "https://avatars2.githubusercontent.com/u/2079879?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dwsupplee",
      "html_url": "https://github.com/dwsupplee",
      "followers_url": "https://api.github.com/users/dwsupplee/followers",
      "following_url": "https://api.github.com/users/dwsupplee/following{/other_user}",
      "gists_url": "https://api.github.com/users/dwsupplee/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dwsupplee/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dwsupplee/subscriptions",
      "organizations_url": "https://api.github.com/users/dwsupplee/orgs",
      "repos_url": "https://api.github.com/users/dwsupplee/repos",
      "events_url": "https://api.github.com/users/dwsupplee/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dwsupplee/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-02-27T03:08:31Z",
    "updated_at": "2018-02-27T03:08:31Z",
    "author_association": "NONE",
    "body": "@murgatroid99 Could you please expand on why the fact the profile includes waiting for network events is misleading? Is there any other data I could help provide?"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/368963985",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-368963985",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 368963985,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2ODk2Mzk4NQ==",
    "user": {
      "login": "murgatroid99",
      "id": 961599,
      "node_id": "MDQ6VXNlcjk2MTU5OQ==",
      "avatar_url": "https://avatars3.githubusercontent.com/u/961599?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/murgatroid99",
      "html_url": "https://github.com/murgatroid99",
      "followers_url": "https://api.github.com/users/murgatroid99/followers",
      "following_url": "https://api.github.com/users/murgatroid99/following{/other_user}",
      "gists_url": "https://api.github.com/users/murgatroid99/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/murgatroid99/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/murgatroid99/subscriptions",
      "organizations_url": "https://api.github.com/users/murgatroid99/orgs",
      "repos_url": "https://api.github.com/users/murgatroid99/repos",
      "events_url": "https://api.github.com/users/murgatroid99/events{/privacy}",
      "received_events_url": "https://api.github.com/users/murgatroid99/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-02-27T17:44:14Z",
    "updated_at": "2018-02-27T17:44:14Z",
    "author_association": "MEMBER",
    "body": "What I mean, more specifically, is that a profile like that does not indicate that `startBatch` is a source of performance problems, because it adds together local run time and network latency. Honestly, though, I don't know what data would be more helpful."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/370627018",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-370627018",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 370627018,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3MDYyNzAxOA==",
    "user": {
      "login": "ZhouyihaiDing",
      "id": 28968539,
      "node_id": "MDQ6VXNlcjI4OTY4NTM5",
      "avatar_url": "https://avatars3.githubusercontent.com/u/28968539?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ZhouyihaiDing",
      "html_url": "https://github.com/ZhouyihaiDing",
      "followers_url": "https://api.github.com/users/ZhouyihaiDing/followers",
      "following_url": "https://api.github.com/users/ZhouyihaiDing/following{/other_user}",
      "gists_url": "https://api.github.com/users/ZhouyihaiDing/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ZhouyihaiDing/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ZhouyihaiDing/subscriptions",
      "organizations_url": "https://api.github.com/users/ZhouyihaiDing/orgs",
      "repos_url": "https://api.github.com/users/ZhouyihaiDing/repos",
      "events_url": "https://api.github.com/users/ZhouyihaiDing/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ZhouyihaiDing/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-06T01:20:34Z",
    "updated_at": "2018-03-10T02:34:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @dwsupplee ,\r\nI run the same script provided by the upstream issue in my GCE(us-west1) for 100 times with both grpc and rest transport:\r\n`for i in 'seq 1 100'; do php -q write-sub.php; done | tee result`\r\n```\r\nwrite-sub.php\r\n<?php\r\n$_num_inserts = 0;\r\n\r\nrequire('vendor/autoload.php');\r\nuse Google\\Cloud\\PubSub\\PubSubClient;\r\n\r\n$projectId = 'your_project_id';\r\n$pubSub = new PubSubClient([\r\n    'projectId' => $projectId,\r\n    'transport' => 'rest'\r\n]);\r\n$_topic = $pubSub->topic('test');\r\n$_start_time = microtime(true);\r\n$_topic->publish([\r\n    'data' => 'My new message. ('.time().')',\r\n    'attributes' => [\r\n        'location' => 'Test 123 - '.rand(1000,9999)\r\n    ]\r\n]);\r\n$_end_time = microtime(true);\r\nprint ($_end_time-$_start_time).\" \";\r\n\r\n$_start_time = microtime(true);\r\n$_topic->publish([\r\n    'data' => 'My new message. ('.time().')',\r\n    'attributes' => [\r\n        'location' => 'Test 456 - '.rand(1000,9999)\r\n    ]\r\n]);\r\n$_end_time = microtime(true);\r\nprint ($_end_time-$_start_time).\" \";\r\n\r\n$_start_time = microtime(true);\r\n$_topic->publish([\r\n    'data' => 'My new message. ('.time().')',\r\n    'attributes' => [\r\n        'location' => 'Test 789 - '.rand(1000,9999)\r\n    ]\r\n]);\r\n$_end_time = microtime(true);\r\nprint ($_end_time-$_start_time).\"\\n\";\r\n```\r\nI get the result like this:\r\nREST:\r\n```\r\n0.21846413612366 0.05851411819458 0.051126956939697\r\n0.14872694015503 0.070885896682739 0.10080695152283\r\n0.14297699928284 0.16884303092957 0.10953092575073\r\n0.16240119934082 0.056371212005615 0.055716037750244\r\n0.13611316680908 0.059178113937378 0.061942100524902\r\n0.13634896278381 0.10430002212524 0.067078828811646\r\n0.18685793876648 0.11610007286072 0.056571006774902\r\n0.22050094604492 0.067669153213501 0.069279909133911\r\n0.13619589805603 0.056427001953125 0.058426141738892\r\n0.25849318504333 0.11442804336548 0.14046382904053\r\n0.14135813713074 0.13725209236145 0.10124683380127\r\n0.14303994178772 0.055007934570312 0.10354804992676\r\n0.15602684020996 0.062564849853516 0.14339089393616\r\n0.15209603309631 0.058828830718994 0.055635929107666\r\n0.15268588066101 0.062503099441528 0.10451984405518\r\n0.14555191993713 0.054335117340088 0.057209968566895\r\n0.137531042099 0.058938026428223 0.059720993041992\r\n0.13925313949585 0.059509038925171 0.055071115493774\r\n0.14344215393066 0.057697057723999 0.075208902359009\r\n```\r\ngRPC with protobuf c_extension:\r\n```\r\n0.19986414909363 0.014701843261719 0.012382030487061\r\n0.17137289047241 0.012480020523071 0.011713981628418\r\n0.16966485977173 0.011740922927856 0.012115001678467\r\n0.1742959022522 0.0099990367889404 0.012738943099976\r\n0.16153693199158 0.011291980743408 0.013216018676758\r\n0.18629002571106 0.019361019134521 0.010370016098022\r\n0.16714787483215 0.012462854385376 0.011173009872437\r\n0.15705585479736 0.011788129806519 0.011378049850464\r\n0.17034602165222 0.0096969604492188 0.0078780651092529\r\n0.15086603164673 0.0075688362121582 0.016098976135254\r\n0.18133592605591 0.011151075363159 0.011448860168457\r\n0.17375707626343 0.012903928756714 0.0079920291900635\r\n0.17534399032593 0.012880086898804 0.013008117675781\r\n0.16156101226807 0.010257959365845 0.011096000671387\r\n0.15987086296082 0.013827085494995 0.010673999786377\r\n0.20808410644531 0.010999917984009 0.01102089881897\r\n0.15847492218018 0.01154899597168 0.012151002883911\r\n```\r\nBoth REST and gRPC transport have the same long latency for the initiate RPC. Although fetchAuthToken doesn't take much time as the discussion in the upstream issue, is it possible that the server do something time consuming like check the credentials or something else during the first RPC? Or the location of my GCE matters because the server may be somewhere else?\r\nAt the same time, I'll try to find what I can do to make the first RPC faster in the gRPC-PHP side."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/371239965",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-371239965",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 371239965,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3MTIzOTk2NQ==",
    "user": {
      "login": "ZhouyihaiDing",
      "id": 28968539,
      "node_id": "MDQ6VXNlcjI4OTY4NTM5",
      "avatar_url": "https://avatars3.githubusercontent.com/u/28968539?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ZhouyihaiDing",
      "html_url": "https://github.com/ZhouyihaiDing",
      "followers_url": "https://api.github.com/users/ZhouyihaiDing/followers",
      "following_url": "https://api.github.com/users/ZhouyihaiDing/following{/other_user}",
      "gists_url": "https://api.github.com/users/ZhouyihaiDing/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ZhouyihaiDing/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ZhouyihaiDing/subscriptions",
      "organizations_url": "https://api.github.com/users/ZhouyihaiDing/orgs",
      "repos_url": "https://api.github.com/users/ZhouyihaiDing/repos",
      "events_url": "https://api.github.com/users/ZhouyihaiDing/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ZhouyihaiDing/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-07T18:40:19Z",
    "updated_at": "2018-03-07T18:40:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "According to the upstream issue, startBatch latency is introduced on the server side, not caused by gRPC."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/371996357",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-371996357",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 371996357,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3MTk5NjM1Nw==",
    "user": {
      "login": "ZhouyihaiDing",
      "id": 28968539,
      "node_id": "MDQ6VXNlcjI4OTY4NTM5",
      "avatar_url": "https://avatars3.githubusercontent.com/u/28968539?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ZhouyihaiDing",
      "html_url": "https://github.com/ZhouyihaiDing",
      "followers_url": "https://api.github.com/users/ZhouyihaiDing/followers",
      "following_url": "https://api.github.com/users/ZhouyihaiDing/following{/other_user}",
      "gists_url": "https://api.github.com/users/ZhouyihaiDing/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ZhouyihaiDing/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ZhouyihaiDing/subscriptions",
      "organizations_url": "https://api.github.com/users/ZhouyihaiDing/orgs",
      "repos_url": "https://api.github.com/users/ZhouyihaiDing/repos",
      "events_url": "https://api.github.com/users/ZhouyihaiDing/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ZhouyihaiDing/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-10T02:42:42Z",
    "updated_at": "2018-03-10T02:51:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "Works above is for pubsub API.\r\nI am working on tracing the request from the Bigtable API - readRows to find where the latency are introduced."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/372662475",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-372662475",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 372662475,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3MjY2MjQ3NQ==",
    "user": {
      "login": "axot",
      "id": 611054,
      "node_id": "MDQ6VXNlcjYxMTA1NA==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/611054?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/axot",
      "html_url": "https://github.com/axot",
      "followers_url": "https://api.github.com/users/axot/followers",
      "following_url": "https://api.github.com/users/axot/following{/other_user}",
      "gists_url": "https://api.github.com/users/axot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/axot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/axot/subscriptions",
      "organizations_url": "https://api.github.com/users/axot/orgs",
      "repos_url": "https://api.github.com/users/axot/repos",
      "events_url": "https://api.github.com/users/axot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/axot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-13T13:20:35Z",
    "updated_at": "2018-03-13T13:24:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "I found pecl-grpc v1.10.0 is much slower than v1.8.5 for the first connection(Not the handshake, but when reusing persistent connection).\r\n(500ms vs 10ms)"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/372744146",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-372744146",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 372744146,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3Mjc0NDE0Ng==",
    "user": {
      "login": "ZhouyihaiDing",
      "id": 28968539,
      "node_id": "MDQ6VXNlcjI4OTY4NTM5",
      "avatar_url": "https://avatars3.githubusercontent.com/u/28968539?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ZhouyihaiDing",
      "html_url": "https://github.com/ZhouyihaiDing",
      "followers_url": "https://api.github.com/users/ZhouyihaiDing/followers",
      "following_url": "https://api.github.com/users/ZhouyihaiDing/following{/other_user}",
      "gists_url": "https://api.github.com/users/ZhouyihaiDing/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ZhouyihaiDing/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ZhouyihaiDing/subscriptions",
      "organizations_url": "https://api.github.com/users/ZhouyihaiDing/orgs",
      "repos_url": "https://api.github.com/users/ZhouyihaiDing/repos",
      "events_url": "https://api.github.com/users/ZhouyihaiDing/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ZhouyihaiDing/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-13T17:11:24Z",
    "updated_at": "2018-03-13T19:20:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hi @axot ,\r\nCan you please provide me more information about how to get the result?\r\nI was tracing the request and got some data. I haven't report the number yet, but in general, the BigTable readRows request latency for the first connection in \"europe-west1\" is about 200ms, which can be divided into 3 parts: \r\n1. fetch auth token. (50ms for the first connection, 0.1ms for the following rpc. I think it gets the help with cache)\r\n2. send request to the server + backend processes it + receive the response. (60ms-80ms for the first connection, 10ms-30ms for the following rpc)\r\n3. gRPC initiate and process, like compress, prepare things to be sent. (60ms-70ms for the fist connection, 1ms for the following rpc)\r\n\r\nI am verifying it with other cloud API like spanner. If it's correct, there are no more we can do for the 1 and 2 part, but to make 3 faster.\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/372878516",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-372878516",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 372878516,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3Mjg3ODUxNg==",
    "user": {
      "login": "axot",
      "id": 611054,
      "node_id": "MDQ6VXNlcjYxMTA1NA==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/611054?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/axot",
      "html_url": "https://github.com/axot",
      "followers_url": "https://api.github.com/users/axot/followers",
      "following_url": "https://api.github.com/users/axot/following{/other_user}",
      "gists_url": "https://api.github.com/users/axot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/axot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/axot/subscriptions",
      "organizations_url": "https://api.github.com/users/axot/orgs",
      "repos_url": "https://api.github.com/users/axot/repos",
      "events_url": "https://api.github.com/users/axot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/axot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-14T01:55:30Z",
    "updated_at": "2018-03-14T02:13:36Z",
    "author_association": "CONTRIBUTOR",
    "body": "@ZhouyihaiDing , I'm testing Spanner in Tokyo region, more details in here\r\nhttps://github.com/GoogleCloudPlatform/google-cloud-php/issues/819#issuecomment-372876349\r\n \r\nAnd I found different behavior in 1.10.0.\r\n```\r\nPID    COMM        LADDR              LPORT  RADDR                  RPORT  TX_KB  RX_KB  MS\r\n17287  grpc_execu  ::ffff:10.22.0.10  40944  ::ffff:172.217.31.138  443    6      5      195.23\r\n17288  grpc_execu  ::ffff:10.22.0.10  40414  ::ffff:172.217.31.170  443    6      5      168.02\r\n17289  grpc_execu  ::ffff:10.22.0.10  55504  ::ffff:216.58.220.234  443    6      5      191.55\r\n```\r\nI paste 3 samples here, this communication happens per request,\r\n\r\nin 1.8.5 it takes almost 200-300s !!!\r\n```\r\nPID   COMM     LADDR              LPORT  RADDR                  RPORT  TX_KB  RX_KB  MS\r\n3051  php-fpm  ::ffff:10.22.0.10  59618  ::ffff:216.58.197.234  443    18     8      246235.54\r\n3053  php-fpm  ::ffff:10.22.0.10  57662  ::ffff:172.217.24.138  443    25     10     356467.13\r\n3050  php-fpm  ::ffff:10.22.0.10  59574  ::ffff:216.58.197.234  443    25     10     265744.82\r\n```"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/372917635",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-372917635",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 372917635,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3MjkxNzYzNQ==",
    "user": {
      "login": "ZhouyihaiDing",
      "id": 28968539,
      "node_id": "MDQ6VXNlcjI4OTY4NTM5",
      "avatar_url": "https://avatars3.githubusercontent.com/u/28968539?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ZhouyihaiDing",
      "html_url": "https://github.com/ZhouyihaiDing",
      "followers_url": "https://api.github.com/users/ZhouyihaiDing/followers",
      "following_url": "https://api.github.com/users/ZhouyihaiDing/following{/other_user}",
      "gists_url": "https://api.github.com/users/ZhouyihaiDing/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ZhouyihaiDing/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ZhouyihaiDing/subscriptions",
      "organizations_url": "https://api.github.com/users/ZhouyihaiDing/orgs",
      "repos_url": "https://api.github.com/users/ZhouyihaiDing/repos",
      "events_url": "https://api.github.com/users/ZhouyihaiDing/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ZhouyihaiDing/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-14T06:24:39Z",
    "updated_at": "2018-03-14T06:24:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thank you for your help, @axot !\r\n\r\nI am running your code in GCE located in asia-northeast1-b with the spanner instance located in the same region. But I removed `APCu` cache part to focus tracing the latency. I already got some data and it doesn't show much difference like bigtable and pubsub, which gRPC initiation time takes 30-80ms for the first RPC and almost 0 for the following. I'll report the data together with bigtable after I double verify it. \r\n\r\nCan you please explain more about what `1.8.5 takes almost 200-300s` means? It's that the latency of a RPC or the total time this php-fpm process up?\r\n\r\nI am going to trace the \"`Persistent Connection`\" thing, can you please offer me more information? I tried to run the script like \r\n`for i in {1..30}; do php -q spanner.php; done`\r\nand it doesn't show much difference between `grpc-1.8.5` and `grpc-1.10.0`? So I guess you are running both grace versions in `php-fpm` mode, right? \r\nPersistent connection is supposed to work under php-fpm mode. I am not familiar with `APCu` and not sure will it conflict with the pool created by gRPC, I am going to check it. If after removing it the result remains the same, I'll check the changes between 1.8.5 and 1.10.0 which is [this PR](https://github.com/grpc/grpc/pull/14149/files).\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/372930285",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-372930285",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 372930285,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3MjkzMDI4NQ==",
    "user": {
      "login": "axot",
      "id": 611054,
      "node_id": "MDQ6VXNlcjYxMTA1NA==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/611054?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/axot",
      "html_url": "https://github.com/axot",
      "followers_url": "https://api.github.com/users/axot/followers",
      "following_url": "https://api.github.com/users/axot/following{/other_user}",
      "gists_url": "https://api.github.com/users/axot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/axot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/axot/subscriptions",
      "organizations_url": "https://api.github.com/users/axot/orgs",
      "repos_url": "https://api.github.com/users/axot/repos",
      "events_url": "https://api.github.com/users/axot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/axot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-14T07:37:07Z",
    "updated_at": "2018-03-14T07:40:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "@ZhouyihaiDing I changed `ApcuAdapter` to `FilesystemAdapter`, it gets similar results as `APCu` without php-fpm.\r\n\r\n```\r\n$ php test.php\r\nGRPC Version: 1.8.5\r\nWarmup: 0.102 milliseconds\r\n1 Query: 289.055 milliseconds\r\n2 Query: 44.550 milliseconds\r\n3 Query: 3.173 milliseconds\r\n4 Query: 2.805 milliseconds\r\n5 Query: 2.820 milliseconds\r\n6 Query: 3.742 milliseconds\r\n7 Query: 2.562 milliseconds\r\n8 Query: 3.440 milliseconds\r\n9 Query: 3.120 milliseconds\r\n10 Query: 2.640 milliseconds\r\n```\r\n\r\n```\r\n$ php test.php\r\nGRPC Version: 1.10.0\r\nWarmup: 0.142 milliseconds\r\n1 Query: 1,010.479 milliseconds\r\n2 Query: 40.580 milliseconds\r\n3 Query: 5.322 milliseconds\r\n4 Query: 5.111 milliseconds\r\n5 Query: 3.875 milliseconds\r\n6 Query: 3.675 milliseconds\r\n7 Query: 4.429 milliseconds\r\n8 Query: 4.414 milliseconds\r\n9 Query: 4.724 milliseconds\r\n10 Query: 5.713 milliseconds\r\n```\r\n\r\nAs you can see, with `v1.10.0` `1 Query` took 3-4x times than `v1.8.5`.\r\n\r\n> Can you please explain more about what 1.8.5 takes almost 200-300s means? It's that the latency of a RPC or the total time this php-fpm process up?\r\n\r\nThis is the total time of TCP session that open and close. I think it is a normal behavior if using  `Persistent Connection` mode in `php-fpm`. It shows in `1.10.0` `Persistent Connection` did not be reused between requests.\r\n\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/373013223",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-373013223",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 373013223,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3MzAxMzIyMw==",
    "user": {
      "login": "axot",
      "id": 611054,
      "node_id": "MDQ6VXNlcjYxMTA1NA==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/611054?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/axot",
      "html_url": "https://github.com/axot",
      "followers_url": "https://api.github.com/users/axot/followers",
      "following_url": "https://api.github.com/users/axot/following{/other_user}",
      "gists_url": "https://api.github.com/users/axot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/axot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/axot/subscriptions",
      "organizations_url": "https://api.github.com/users/axot/orgs",
      "repos_url": "https://api.github.com/users/axot/repos",
      "events_url": "https://api.github.com/users/axot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/axot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-14T13:04:20Z",
    "updated_at": "2018-03-14T13:34:38Z",
    "author_association": "CONTRIBUTOR",
    "body": "I made a on-cpu flame-graph for comparison. You can download the original svg format [here](https://github.com/grpc/grpc/files/1811136/on-cpu-flame-graph.zip), It seems `EVP_DecodeUpdate` has a big different. But the long response can also cause by off-cpu time like mutex, which I did analysis yet. @ZhouyihaiDing \r\n\r\n\r\nPreview is here.\r\n1.8.5\r\n![1 8 5 svg](https://user-images.githubusercontent.com/611054/37403878-91758372-27d3-11e8-9962-23cddba420c4.png)\r\n\r\n1.10.0\r\n![1 10 0 svg](https://user-images.githubusercontent.com/611054/37403884-9667c160-27d3-11e8-8595-9b68942003d0.png)"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/373066768",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-373066768",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 373066768,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3MzA2Njc2OA==",
    "user": {
      "login": "dwsupplee",
      "id": 2079879,
      "node_id": "MDQ6VXNlcjIwNzk4Nzk=",
      "avatar_url": "https://avatars2.githubusercontent.com/u/2079879?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dwsupplee",
      "html_url": "https://github.com/dwsupplee",
      "followers_url": "https://api.github.com/users/dwsupplee/followers",
      "following_url": "https://api.github.com/users/dwsupplee/following{/other_user}",
      "gists_url": "https://api.github.com/users/dwsupplee/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dwsupplee/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dwsupplee/subscriptions",
      "organizations_url": "https://api.github.com/users/dwsupplee/orgs",
      "repos_url": "https://api.github.com/users/dwsupplee/repos",
      "events_url": "https://api.github.com/users/dwsupplee/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dwsupplee/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-14T15:39:01Z",
    "updated_at": "2018-03-14T16:08:57Z",
    "author_association": "NONE",
    "body": "@ZhouyihaiDing sorry for the delayed response.\r\n\r\nWhen running on GCE I see similar results as you mentioned. However, when I run the script 20 times on my local development machine I see the following (with an already cached auth token):\r\n\r\nREST:\r\n```\r\n0.19489789009094 0.037225961685181 0.03973913192749\r\n0.20339512825012 0.040876865386963 0.043087959289551\r\n0.18250513076782 0.041792154312134 0.039877891540527\r\n0.18628120422363 0.039862871170044 0.043469190597534\r\n0.18130087852478 0.045254945755005 0.041988849639893\r\n0.18522906303406 0.048583030700684 0.041409969329834\r\n0.18882918357849 0.043915987014771 0.043264150619507\r\n0.19993305206299 0.040619850158691 0.042426824569702\r\n0.1882529258728 0.042854070663452 0.044863939285278\r\n0.18107891082764 0.03930401802063 0.044710159301758\r\n0.22000098228455 0.042585134506226 0.039599895477295\r\n0.19017601013184 0.037634134292603 0.039781093597412\r\n0.18644404411316 0.040591955184937 0.041887998580933\r\n0.1916491985321 0.079386949539185 0.047858953475952\r\n0.17888498306274 0.036967039108276 0.036783933639526\r\n0.1844208240509 0.04079008102417 0.039869070053101\r\n0.14662384986877 0.047139883041382 0.048990964889526\r\n0.1927638053894 0.040356874465942 0.049510955810547\r\n0.19094491004944 0.042094945907593 0.044947147369385\r\n0.18920302391052 0.038762092590332 0.039801120758057\r\n```\r\n\r\ngRPC v1.8.5\r\n```\r\n0.33104181289673 0.038801908493042 0.056406021118164\r\n0.31952714920044 0.050151109695435 0.059834003448486\r\n0.32298302650452 0.045830011367798 0.059325933456421\r\n0.35558605194092 0.046213865280151 0.058226108551025\r\n0.33616590499878 0.065206050872803 0.0591721534729\r\n0.31988501548767 0.07715106010437 0.055783033370972\r\n0.32758903503418 0.055761098861694 0.055678129196167\r\n0.35145688056946 0.057261943817139 0.045493125915527\r\n0.33373785018921 0.049771785736084 0.044853925704956\r\n0.34525799751282 0.057574987411499 0.047112941741943\r\n0.34258317947388 0.064590930938721 0.048111200332642\r\n0.32757592201233 0.053658008575439 0.062611103057861\r\n0.33687496185303 0.04616904258728 0.071362972259521\r\n0.34099984169006 0.064764022827148 0.038785219192505\r\n0.3466169834137 0.05119800567627 0.048923015594482\r\n0.33255505561829 0.057765007019043 0.046075105667114\r\n0.33456301689148 0.053205966949463 0.043113946914673\r\n0.32750296592712 0.047332048416138 0.059146881103516\r\n0.33643794059753 0.044345855712891 0.052647113800049\r\n0.37080717086792 0.054423093795776 0.044103860855103\r\n```\r\n\r\nThere seems to be a considerable addition to latency on the first gRPC call in this case.  I have traced the code and from what I can tell an auth token is not being fetched. I will look a bit deeper to see what I can find."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/373189082",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-373189082",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 373189082,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3MzE4OTA4Mg==",
    "user": {
      "login": "ZhouyihaiDing",
      "id": 28968539,
      "node_id": "MDQ6VXNlcjI4OTY4NTM5",
      "avatar_url": "https://avatars3.githubusercontent.com/u/28968539?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ZhouyihaiDing",
      "html_url": "https://github.com/ZhouyihaiDing",
      "followers_url": "https://api.github.com/users/ZhouyihaiDing/followers",
      "following_url": "https://api.github.com/users/ZhouyihaiDing/following{/other_user}",
      "gists_url": "https://api.github.com/users/ZhouyihaiDing/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ZhouyihaiDing/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ZhouyihaiDing/subscriptions",
      "organizations_url": "https://api.github.com/users/ZhouyihaiDing/orgs",
      "repos_url": "https://api.github.com/users/ZhouyihaiDing/repos",
      "events_url": "https://api.github.com/users/ZhouyihaiDing/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ZhouyihaiDing/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-14T21:59:40Z",
    "updated_at": "2018-03-14T21:59:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks @axot !\r\nYou are right, it seems there are regressions after gRPC-v1.9.0 and I am working on locating where the problem is.\r\nSo, to make it clear, in spanner, even in gRPC-v1.8.5, the first RPC(warm up) will take ~1000ms, right? Since the channel is persistent correctly, it saves latency to `289.055ms` later.  Your question is that the current gRPC-PHP has problem with persistent channel, right? Most time cost with '1000'ms warm up are waiting for the network events, which we can not do anything in gRPC part. I'll try to fix the persistent channel part so it will be saved to 289ms as like in 1.8.5."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/374377657",
    "html_url": "https://github.com/grpc/grpc/issues/14534#issuecomment-374377657",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/14534",
    "id": 374377657,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM3NDM3NzY1Nw==",
    "user": {
      "login": "ZhouyihaiDing",
      "id": 28968539,
      "node_id": "MDQ6VXNlcjI4OTY4NTM5",
      "avatar_url": "https://avatars3.githubusercontent.com/u/28968539?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ZhouyihaiDing",
      "html_url": "https://github.com/ZhouyihaiDing",
      "followers_url": "https://api.github.com/users/ZhouyihaiDing/followers",
      "following_url": "https://api.github.com/users/ZhouyihaiDing/following{/other_user}",
      "gists_url": "https://api.github.com/users/ZhouyihaiDing/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ZhouyihaiDing/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ZhouyihaiDing/subscriptions",
      "organizations_url": "https://api.github.com/users/ZhouyihaiDing/orgs",
      "repos_url": "https://api.github.com/users/ZhouyihaiDing/repos",
      "events_url": "https://api.github.com/users/ZhouyihaiDing/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ZhouyihaiDing/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-03-19T21:07:56Z",
    "updated_at": "2018-03-19T21:07:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "Duplicate of #14713. Close this issue in order to make the progress clear.\r\nBy tracing the request, startBatch latency for the first RPC is mostly caused by waiting the network event.\r\nThe new issue is that the persistent channel which should be cached to make the following rpc faster, doesn't work. I am working on adding the persistent channel management."
  }
]
