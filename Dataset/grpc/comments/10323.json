[
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/289593894",
    "html_url": "https://github.com/grpc/grpc/pull/10323#issuecomment-289593894",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/10323",
    "id": 289593894,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI4OTU5Mzg5NA==",
    "user": {
      "login": "kpayson64",
      "id": 18316330,
      "node_id": "MDQ6VXNlcjE4MzE2MzMw",
      "avatar_url": "https://avatars2.githubusercontent.com/u/18316330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kpayson64",
      "html_url": "https://github.com/kpayson64",
      "followers_url": "https://api.github.com/users/kpayson64/followers",
      "following_url": "https://api.github.com/users/kpayson64/following{/other_user}",
      "gists_url": "https://api.github.com/users/kpayson64/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kpayson64/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kpayson64/subscriptions",
      "organizations_url": "https://api.github.com/users/kpayson64/orgs",
      "repos_url": "https://api.github.com/users/kpayson64/repos",
      "events_url": "https://api.github.com/users/kpayson64/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kpayson64/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-03-27T21:37:33Z",
    "updated_at": "2017-03-27T21:37:33Z",
    "author_association": "CONTRIBUTOR",
    "body": "Fixes #9688"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/289598901",
    "html_url": "https://github.com/grpc/grpc/pull/10323#issuecomment-289598901",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/10323",
    "id": 289598901,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI4OTU5ODkwMQ==",
    "user": {
      "login": "sreecha",
      "id": 2754995,
      "node_id": "MDQ6VXNlcjI3NTQ5OTU=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/2754995?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sreecha",
      "html_url": "https://github.com/sreecha",
      "followers_url": "https://api.github.com/users/sreecha/followers",
      "following_url": "https://api.github.com/users/sreecha/following{/other_user}",
      "gists_url": "https://api.github.com/users/sreecha/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sreecha/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sreecha/subscriptions",
      "organizations_url": "https://api.github.com/users/sreecha/orgs",
      "repos_url": "https://api.github.com/users/sreecha/repos",
      "events_url": "https://api.github.com/users/sreecha/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sreecha/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-03-27T21:58:46Z",
    "updated_at": "2017-03-27T21:58:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "@kpayson64 - Is there a reason why `fd_orphan` was not called on that fd ? (because calling `fd_orphan` would ensure that the fd is removed from the pollset)"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/289601482",
    "html_url": "https://github.com/grpc/grpc/pull/10323#issuecomment-289601482",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/10323",
    "id": 289601482,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI4OTYwMTQ4Mg==",
    "user": {
      "login": "kpayson64",
      "id": 18316330,
      "node_id": "MDQ6VXNlcjE4MzE2MzMw",
      "avatar_url": "https://avatars2.githubusercontent.com/u/18316330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kpayson64",
      "html_url": "https://github.com/kpayson64",
      "followers_url": "https://api.github.com/users/kpayson64/followers",
      "following_url": "https://api.github.com/users/kpayson64/following{/other_user}",
      "gists_url": "https://api.github.com/users/kpayson64/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kpayson64/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kpayson64/subscriptions",
      "organizations_url": "https://api.github.com/users/kpayson64/orgs",
      "repos_url": "https://api.github.com/users/kpayson64/repos",
      "events_url": "https://api.github.com/users/kpayson64/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kpayson64/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-03-27T22:10:31Z",
    "updated_at": "2017-03-27T22:10:31Z",
    "author_association": "CONTRIBUTOR",
    "body": "@sreecha \r\nI'm not sure where fd_orphan should be called.  AFAICT, in order to actually do the pollset removal, we would need to pass in a closure that does that work, and I didn't see any functions capable of removing an fd from a pollset."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/289607030",
    "html_url": "https://github.com/grpc/grpc/pull/10323#issuecomment-289607030",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/10323",
    "id": 289607030,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI4OTYwNzAzMA==",
    "user": {
      "login": "sreecha",
      "id": 2754995,
      "node_id": "MDQ6VXNlcjI3NTQ5OTU=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/2754995?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sreecha",
      "html_url": "https://github.com/sreecha",
      "followers_url": "https://api.github.com/users/sreecha/followers",
      "following_url": "https://api.github.com/users/sreecha/following{/other_user}",
      "gists_url": "https://api.github.com/users/sreecha/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sreecha/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sreecha/subscriptions",
      "organizations_url": "https://api.github.com/users/sreecha/orgs",
      "repos_url": "https://api.github.com/users/sreecha/repos",
      "events_url": "https://api.github.com/users/sreecha/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sreecha/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-03-27T22:38:36Z",
    "updated_at": "2017-03-27T22:38:36Z",
    "author_association": "CONTRIBUTOR",
    "body": "@kpayson64: \r\nI am also not very clear when `grpc_fd_orphan` should be called. I always thought it should be called whenever the user of that fd wants to \"close\" the fd (currently if you look at the code, tcp server / client call this).. I don't know when we expect the caller to call `grpc_fd_shutdown` versus `grpc_fd_orphan` (I am clear what they do..I just don't know what expectation the polling engine has from its callers). This is a @ctiller question!\r\n\r\nHowever, when this is called, the FD is removed from the pollset:\r\nCalling `grpc_fd_orphan` marks the fd as orphaned (on the `grpc_fd` struct) and in the `pollset_work()` function, when constructing the list of fds to poll, we do check if an fd is orphaned and NOT add it to the pollset (see below)\r\n\r\n``` C\r\n\r\n      fd_count = 0;\r\n      pfd_count = 2;\r\n      pfds[0].fd = GRPC_WAKEUP_FD_GET_READ_FD(&global_wakeup_fd);\r\n      pfds[0].events = POLLIN;\r\n      pfds[0].revents = 0;\r\n      pfds[1].fd = GRPC_WAKEUP_FD_GET_READ_FD(&worker.wakeup_fd->fd);\r\n      pfds[1].events = POLLIN;\r\n      pfds[1].revents = 0;\r\n      for (i = 0; i < pollset->fd_count; i++) {\r\n        if (fd_is_orphaned(pollset->fds[i])) { // <<<Sree:  Skip adding orphaned fds\r\n          GRPC_FD_UNREF(pollset->fds[i], \"multipoller\");\r\n        } else {\r\n          pollset->fds[fd_count++] = pollset->fds[i];\r\n          watchers[pfd_count].fd = pollset->fds[i];\r\n          GRPC_FD_REF(watchers[pfd_count].fd, \"multipoller_start\");\r\n          pfds[pfd_count].fd = pollset->fds[i]->fd;\r\n          pfds[pfd_count].revents = 0;\r\n          pfd_count++;\r\n        }\r\n      }\r\n      pollset->fd_count = fd_count;   // <<<Sree: Updating the fd_count \r\n      gpr_mu_unlock(&pollset->mu);\r\n...\r\n```\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/289932336",
    "html_url": "https://github.com/grpc/grpc/pull/10323#issuecomment-289932336",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/10323",
    "id": 289932336,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI4OTkzMjMzNg==",
    "user": {
      "login": "kpayson64",
      "id": 18316330,
      "node_id": "MDQ6VXNlcjE4MzE2MzMw",
      "avatar_url": "https://avatars2.githubusercontent.com/u/18316330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kpayson64",
      "html_url": "https://github.com/kpayson64",
      "followers_url": "https://api.github.com/users/kpayson64/followers",
      "following_url": "https://api.github.com/users/kpayson64/following{/other_user}",
      "gists_url": "https://api.github.com/users/kpayson64/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kpayson64/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kpayson64/subscriptions",
      "organizations_url": "https://api.github.com/users/kpayson64/orgs",
      "repos_url": "https://api.github.com/users/kpayson64/repos",
      "events_url": "https://api.github.com/users/kpayson64/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kpayson64/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-03-28T23:07:51Z",
    "updated_at": "2017-03-28T23:07:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "Summarizing the outcome here:\r\n\r\nThe real cause of the error was calling ```grpc_completion_queue_next()``` after a ```grpc_call``` had completed, but not been destroyed.  The call's fd will only be removed from the pollset after destruction.\r\n\r\nThis restriction only applies to the poll() engine.\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/289935325",
    "html_url": "https://github.com/grpc/grpc/pull/10323#issuecomment-289935325",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/10323",
    "id": 289935325,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI4OTkzNTMyNQ==",
    "user": {
      "login": "sreecha",
      "id": 2754995,
      "node_id": "MDQ6VXNlcjI3NTQ5OTU=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/2754995?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sreecha",
      "html_url": "https://github.com/sreecha",
      "followers_url": "https://api.github.com/users/sreecha/followers",
      "following_url": "https://api.github.com/users/sreecha/following{/other_user}",
      "gists_url": "https://api.github.com/users/sreecha/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sreecha/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sreecha/subscriptions",
      "organizations_url": "https://api.github.com/users/sreecha/orgs",
      "repos_url": "https://api.github.com/users/sreecha/repos",
      "events_url": "https://api.github.com/users/sreecha/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sreecha/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-03-28T23:24:51Z",
    "updated_at": "2017-03-28T23:24:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks @kpayson64. \r\n\r\nTo summarize the other open question we had regarding `fd_orphan` versus `fd_shutdown`:\r\n- The layers using the polling engine MUST call `grpc_fd_orphan` when they are done with the fd. Once `grpc_fd_orphan` is called, the fd MUST not be used anymore.  \r\n\r\n- `grpc_fd_shutdown` MAY be called on the fd if the layers using the polling engine want to cancel any pending read/write closures on the fd (i.e the closures would be called with a failure) AND to prevent any new read/write closures from being added to the fd. "
  }
]
