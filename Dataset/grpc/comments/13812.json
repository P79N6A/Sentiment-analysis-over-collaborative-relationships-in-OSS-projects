[
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/352574553",
    "html_url": "https://github.com/grpc/grpc/issues/13812#issuecomment-352574553",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13812",
    "id": 352574553,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1MjU3NDU1Mw==",
    "user": {
      "login": "AspirinSJL",
      "id": 3314176,
      "node_id": "MDQ6VXNlcjMzMTQxNzY=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/3314176?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AspirinSJL",
      "html_url": "https://github.com/AspirinSJL",
      "followers_url": "https://api.github.com/users/AspirinSJL/followers",
      "following_url": "https://api.github.com/users/AspirinSJL/following{/other_user}",
      "gists_url": "https://api.github.com/users/AspirinSJL/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AspirinSJL/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AspirinSJL/subscriptions",
      "organizations_url": "https://api.github.com/users/AspirinSJL/orgs",
      "repos_url": "https://api.github.com/users/AspirinSJL/repos",
      "events_url": "https://api.github.com/users/AspirinSJL/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AspirinSJL/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-12-18T22:12:46Z",
    "updated_at": "2017-12-18T22:12:46Z",
    "author_association": "MEMBER",
    "body": "@y-zeng , do you think this is similar to the bug you fixed in #12137? \r\n\r\n```\r\nI1218 11:28:45.048041496  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:5503'. The empty token will be used instead\r\nI1218 11:28:45.048056183  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:14886'. The empty token will be used instead\r\nI1218 11:28:45.048070660  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:2276'. The empty token will be used instead\r\nI1218 11:28:45.048084405  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:5503'. The empty token will be used instead\r\nI1218 11:28:45.048097958  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:27080'. The empty token will be used instead\r\nI1218 11:28:45.048111879  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:3559'. The empty token will be used instead\r\nI1218 11:28:45.048125480  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:3559'. The empty token will be used instead\r\nI1218 11:28:45.048138899  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:2276'. The empty token will be used instead\r\nI1218 11:28:45.048152259  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:5141'. The empty token will be used instead\r\nI1218 11:28:45.048165422  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:14886'. The empty token will be used instead\r\nI1218 11:28:45.089759612  102159 client_channel_stress_test.cc:198] balancer shutdown completed\r\nI1218 11:28:45.089810233  102159 client_channel_stress_test.cc:195] balancer about to shutdown\r\nI1218 11:28:45.091466713  102159 client_channel_stress_test.cc:198] balancer shutdown completed\r\nI1218 11:28:45.091497669  102159 client_channel_stress_test.cc:195] balancer about to shutdown\r\nI1218 11:28:45.099596432  102414 client_channel_stress_test.cc:80] LB[0x7d140000e6f0]: Finish BalanceLoad.\r\nI1218 11:28:45.107873785  102159 client_channel_stress_test.cc:198] balancer shutdown completed\r\nI1218 11:28:45.107919367  102159 client_channel_stress_test.cc:195] balancer about to shutdown\r\nI1218 11:28:45.109864974  102159 client_channel_stress_test.cc:198] balancer shutdown completed\r\nI1218 11:28:45.109905288  102159 client_channel_stress_test.cc:195] balancer about to shutdown\r\nI1218 11:28:45.114015298  102159 client_channel_stress_test.cc:198] balancer shutdown completed\r\nI1218 11:28:45.114054201  102159 client_channel_stress_test.cc:195] backend about to shutdown\r\nI1218 11:28:45.115639116  102159 client_channel_stress_test.cc:198] backend shutdown completed\r\nI1218 11:28:45.115668877  102159 client_channel_stress_test.cc:195] backend about to shutdown\r\nI1218 11:28:45.117152794  102159 client_channel_stress_test.cc:198] backend shutdown completed\r\nI1218 11:28:45.117183119  102159 client_channel_stress_test.cc:195] backend about to shutdown\r\nI1218 11:28:45.118176912  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:22503'. The empty token will be used instead\r\nI1218 11:28:45.118203895  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:3559'. The empty token will be used instead\r\nI1218 11:28:45.118218575  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:2276'. The empty token will be used instead\r\nI1218 11:28:45.118232146  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:5503'. The empty token will be used instead\r\nI1218 11:28:45.118254872  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:5503'. The empty token will be used instead\r\nI1218 11:28:45.118269850  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:27080'. The empty token will be used instead\r\nI1218 11:28:45.118282887  102914 grpclb.cc:547]              Missing LB token for backend address 'ipv4:127.0.0.1:20719'. The empty token will be used instead\r\nI1218 11:28:45.139447967  102159 client_channel_stress_test.cc:198] backend shutdown completed\r\nI1218 11:28:45.139486521  102159 client_channel_stress_test.cc:195] backend about to shutdown\r\nI1218 11:28:45.153751829  103228 subchannel.cc:660]          Connect failed: {\"created\":\"@1513625325.153490795\",\"description\":\"Failed to connect to remote host: OS Error\",\"errno\":111,\"file\":\"src/core/lib/iomgr/tcp_client_posix.cc\",\"file_line\":198,\"os_error\":\"Connection refused\",\"syscall\":\"connect\",\"target_address\":\"ipv4:127.0.0.1:18107\"}\r\nI1218 11:28:45.154363941  102285 subchannel.cc:660]          Connect failed: {\"created\":\"@1513625325.154111234\",\"description\":\"Failed to connect to remote host: OS Error\",\"errno\":111,\"file\":\"src/core/lib/iomgr/tcp_client_posix.cc\",\"file_line\":198,\"os_error\":\"Connection refused\",\"syscall\":\"connect\",\"target_address\":\"ipv4:127.0.0.1:8509\"}\r\nI1218 11:28:45.154868818  103228 subchannel.cc:660]          Connect failed: {\"created\":\"@1513625325.154667281\",\"description\":\"Failed to connect to remote host: OS Error\",\"errno\":111,\"file\":\"src/core/lib/iomgr/tcp_client_posix.cc\",\"file_line\":198,\"os_error\":\"Connection refused\",\"syscall\":\"connect\",\"target_address\":\"ipv4:127.0.0.1:16399\"}\r\nI1218 11:28:45.155376447  102285 subchannel.cc:660]          Connect failed: {\"created\":\"@1513625325.155164597\",\"description\":\"Failed to connect to remote host: OS Error\",\"errno\":111,\"file\":\"src/core/lib/iomgr/tcp_client_posix.cc\",\"file_line\":198,\"os_error\":\"Connection refused\",\"syscall\":\"connect\",\"target_address\":\"ipv4:127.0.0.1:8385\"}\r\nI1218 11:28:45.156556645  103228 subchannel.cc:660]          Connect failed: {\"created\":\"@1513625325.156303563\",\"description\":\"Failed to connect to remote host: OS Error\",\"errno\":111,\"file\":\"src/core/lib/iomgr/tcp_client_posix.cc\",\"file_line\":198,\"os_error\":\"Connection refused\",\"syscall\":\"connect\",\"target_address\":\"ipv4:127.0.0.1:14689\"}\r\nI1218 11:28:45.156614086  103228 subchannel.cc:466]          Retry in 997 milliseconds\r\n==================\r\nWARNING: ThreadSanitizer: data race (pid=102159)\r\n  Write of size 8 at 0x7d600000fa90 by thread T140:\r\n    #0 process_data_after_md(batch_control*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/surface/call.cc:1422:29 (client_channel_stress_test+0x00000060717a)\r\n    #1 receiving_stream_ready(void*, grpc_error*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/surface/call.cc:1456:5 (client_channel_stress_test+0x000000606011)\r\n    #2 receiving_stream_ready_in_call_combiner(void*, grpc_error*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/surface/call.cc:1468:3 (client_channel_stress_test+0x000000604b4e)\r\n    #3 exec_ctx_run(grpc_closure*, grpc_error*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/iomgr/exec_ctx.cc:38:3 (client_channel_stress_test+0x000000556f69)\r\n    #4 grpc_closure_run(char const*, int, grpc_closure*, grpc_error*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/./src/core/lib/iomgr/closure.h:259:5 (client_channel_stress_test+0x000000560043)\r\n    #5 recv_message_ready(void*, grpc_error*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/ext/filters/message_size/message_size_filter.cc:133:3 (client_channel_stress_test+0x0000006a4538)\r\n    #6 exec_ctx_run(grpc_closure*, grpc_error*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/iomgr/exec_ctx.cc:38:3 (client_channel_stress_test+0x000000556f69)\r\n    #7 grpc_core::ExecCtx::Flush() /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/iomgr/exec_ctx.cc:125:9 (client_channel_stress_test+0x000000556cf3)\r\n    #8 end_worker(grpc_pollset*, grpc_pollset_worker*, grpc_pollset_worker**) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/iomgr/ev_epoll1_linux.cc:866:9 (client_channel_stress_test+0x000000587db9)\r\n    #9 pollset_work(grpc_pollset*, grpc_pollset_worker**, long) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/iomgr/ev_epoll1_linux.cc:968:3 (client_channel_stress_test+0x0000005846e1)\r\n    #10 grpc_pollset_work(grpc_pollset*, grpc_pollset_worker**, long) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/iomgr/ev_posix.cc:225:10 (client_channel_stress_test+0x000000555cb1)\r\n    #11 cq_next(grpc_completion_queue*, gpr_timespec, void*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/surface/completion_queue.cc:932:23 (client_channel_stress_test+0x00000060f8b9)\r\n    #12 grpc_completion_queue_next /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/surface/completion_queue.cc:1010:10 (client_channel_stress_test+0x00000060e476)\r\n    #13 grpc::CompletionQueue::AsyncNextInternal(void**, bool*, gpr_timespec) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/cpp/common/completion_queue_cc.cc:56:15 (client_channel_stress_test+0x0000005ee8d9)\r\n    #14 grpc::CompletionQueue::NextStatus grpc::CompletionQueue::AsyncNext<gpr_timespec>(void**, bool*, gpr_timespec const&) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/include/grpc++/impl/codegen/completion_queue.h:157:12 (client_channel_stress_test+0x0000005cc675)\r\n    #15 grpc::Server::SyncRequestThreadManager::PollForWork(void**, bool*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/cpp/server/server_cc.cc:276:13 (client_channel_stress_test+0x0000005ce45d)\r\n    #16 grpc::ThreadManager::MainWorkLoop() /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/cpp/thread_manager/thread_manager.cc:122:30 (client_channel_stress_test+0x0000005dcab8)\r\n    #17 grpc::ThreadManager::WorkerThread::Run() /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/cpp/thread_manager/thread_manager.cc:38:3 (client_channel_stress_test+0x0000005dca3e)\r\n    #18 void std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()>::operator()<, void>(grpc::ThreadManager::WorkerThread*) const /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/functional:601:11 (client_channel_stress_test+0x0000005dfbdb)\r\n    #19 void std::_Bind_simple<std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()> (grpc::ThreadManager::WorkerThread*)>::_M_invoke<0ul>(std::_Index_tuple<0ul>) /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/functional:1731:18 (client_channel_stress_test+0x0000005dfac5)\r\n    #20 std::_Bind_simple<std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()> (grpc::ThreadManager::WorkerThread*)>::operator()() /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/functional:1720:16 (client_channel_stress_test+0x0000005dfa48)\r\n    #21 std::thread::_Impl<std::_Bind_simple<std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()> (grpc::ThreadManager::WorkerThread*)> >::_M_run() /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/thread:115:13 (client_channel_stress_test+0x0000005df59c)\r\n    #22 execute_native_thread_routine /build/gcc-4.8-mW1ufQ/gcc-4.8-4.8.4/build/x86_64-linux-gnu/libstdc++-v3/src/c++11/../../../../../src/libstdc++-v3/src/c++11/thread.cc:84 (libstdc++.so.6+0x0000000b1a5f)\r\n\r\n  Previous write of size 8 at 0x7d600000fa90 by thread T145:\r\n    #0 process_data_after_md(batch_control*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/surface/call.cc:1422:29 (client_channel_stress_test+0x00000060717a)\r\n    #1 receiving_stream_ready(void*, grpc_error*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/surface/call.cc:1456:5 (client_channel_stress_test+0x000000606011)\r\n    #2 receiving_stream_ready_in_call_combiner(void*, grpc_error*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/surface/call.cc:1468:3 (client_channel_stress_test+0x000000604b4e)\r\n    #3 exec_ctx_run(grpc_closure*, grpc_error*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/iomgr/exec_ctx.cc:38:3 (client_channel_stress_test+0x000000556f69)\r\n    #4 grpc_core::ExecCtx::Flush() /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/iomgr/exec_ctx.cc:125:9 (client_channel_stress_test+0x000000556cf3)\r\n    #5 end_worker(grpc_pollset*, grpc_pollset_worker*, grpc_pollset_worker**) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/iomgr/ev_epoll1_linux.cc:866:9 (client_channel_stress_test+0x000000587db9)\r\n    #6 pollset_work(grpc_pollset*, grpc_pollset_worker**, long) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/iomgr/ev_epoll1_linux.cc:968:3 (client_channel_stress_test+0x0000005846e1)\r\n    #7 grpc_pollset_work(grpc_pollset*, grpc_pollset_worker**, long) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/iomgr/ev_posix.cc:225:10 (client_channel_stress_test+0x000000555cb1)\r\n    #8 cq_next(grpc_completion_queue*, gpr_timespec, void*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/surface/completion_queue.cc:932:23 (client_channel_stress_test+0x00000060f8b9)\r\n    #9 grpc_completion_queue_next /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/surface/completion_queue.cc:1010:10 (client_channel_stress_test+0x00000060e476)\r\n    #10 grpc::CompletionQueue::AsyncNextInternal(void**, bool*, gpr_timespec) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/cpp/common/completion_queue_cc.cc:56:15 (client_channel_stress_test+0x0000005ee8d9)\r\n    #11 grpc::CompletionQueue::NextStatus grpc::CompletionQueue::AsyncNext<gpr_timespec>(void**, bool*, gpr_timespec const&) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/include/grpc++/impl/codegen/completion_queue.h:157:12 (client_channel_stress_test+0x0000005cc675)\r\n    #12 grpc::Server::SyncRequestThreadManager::PollForWork(void**, bool*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/cpp/server/server_cc.cc:276:13 (client_channel_stress_test+0x0000005ce45d)\r\n    #13 grpc::ThreadManager::MainWorkLoop() /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/cpp/thread_manager/thread_manager.cc:122:30 (client_channel_stress_test+0x0000005dcab8)\r\n    #14 grpc::ThreadManager::WorkerThread::Run() /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/cpp/thread_manager/thread_manager.cc:38:3 (client_channel_stress_test+0x0000005dca3e)\r\n    #15 void std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()>::operator()<, void>(grpc::ThreadManager::WorkerThread*) const /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/functional:601:11 (client_channel_stress_test+0x0000005dfbdb)\r\n    #16 void std::_Bind_simple<std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()> (grpc::ThreadManager::WorkerThread*)>::_M_invoke<0ul>(std::_Index_tuple<0ul>) /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/functional:1731:18 (client_channel_stress_test+0x0000005dfac5)\r\n    #17 std::_Bind_simple<std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()> (grpc::ThreadManager::WorkerThread*)>::operator()() /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/functional:1720:16 (client_channel_stress_test+0x0000005dfa48)\r\n    #18 std::thread::_Impl<std::_Bind_simple<std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()> (grpc::ThreadManager::WorkerThread*)> >::_M_run() /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/thread:115:13 (client_channel_stress_test+0x0000005df59c)\r\n    #19 execute_native_thread_routine /build/gcc-4.8-mW1ufQ/gcc-4.8-4.8.4/build/x86_64-linux-gnu/libstdc++-v3/src/c++11/../../../../../src/libstdc++-v3/src/c++11/thread.cc:84 (libstdc++.so.6+0x0000000b1a5f)\r\n\r\n  Location is heap block of size 1024 at 0x7d600000f800 allocated by main thread:\r\n    #0 calloc /home/development/llvm/3.8.1/final/llvm.src/projects/compiler-rt/lib/tsan/rtl/tsan_interceptors.cc:612:5 (client_channel_stress_test+0x00000042b84c)\r\n    #1 zalloc_with_calloc(unsigned long) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/support/alloc.cc:27:53 (client_channel_stress_test+0x0000005e378f)\r\n    #2 gpr_zalloc /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/support/alloc.cc:68:7 (client_channel_stress_test+0x0000005e34f1)\r\n    #3 glb_create(grpc_lb_policy_factory*, grpc_lb_policy_args*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/ext/filters/client_channel/lb_policy/grpclb/grpclb.cc:1908:47 (client_channel_stress_test+0x0000006821df)\r\n    #4 grpc_lb_policy_factory_create_lb_policy(grpc_lb_policy_factory*, grpc_lb_policy_args*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/ext/filters/client_channel/lb_policy_factory.cc:165:10 (client_channel_stress_test+0x00000057b54f)\r\n    #5 grpc_lb_policy_create(char const*, grpc_lb_policy_args*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/ext/filters/client_channel/lb_policy_registry.cc:68:7 (client_channel_stress_test+0x0000006377a5)\r\n    #6 on_resolver_result_changed_locked(void*, grpc_error*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/ext/filters/client_channel/client_channel.cc:456:25 (client_channel_stress_test+0x000000633888)\r\n    #7 grpc_combiner_continue_exec_ctx() /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/iomgr/combiner.cc:261:5 (client_channel_stress_test+0x00000054ef9d)\r\n    #8 grpc_core::ExecCtx::Flush() /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/iomgr/exec_ctx.cc:128:17 (client_channel_stress_test+0x000000556d0a)\r\n    #9 grpc_core::ExecCtx::~ExecCtx() /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/./src/core/lib/iomgr/exec_ctx.h:85:5 (client_channel_stress_test+0x00000050811d)\r\n    #10 grpc::testing::(anonymous namespace)::ClientChannelStressTest::SetNextResolution(std::vector<grpc::testing::(anonymous namespace)::ClientChannelStressTest::AddressData, std::allocator<grpc::testing::(anonymous namespace)::ClientChannelStressTest::AddressData> > const&) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/test/cpp/client/client_channel_stress_test.cc:234:3 (client_channel_stress_test+0x0000004ebf96)\r\n    #11 grpc::testing::(anonymous namespace)::ClientChannelStressTest::Run() /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/test/cpp/client/client_channel_stress_test.cc:153:7 (client_channel_stress_test+0x0000004e96fa)\r\n    #12 main /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/test/cpp/client/client_channel_stress_test.cc:323:3 (client_channel_stress_test+0x0000004e9211)\r\n\r\n  Thread T140 (tid=102914, running) created by thread T10 at:\r\n    #0 pthread_create /home/development/llvm/3.8.1/final/llvm.src/projects/compiler-rt/lib/tsan/rtl/tsan_interceptors.cc:954:3 (client_channel_stress_test+0x00000042e511)\r\n    #1 __gthread_create /build/gcc-4.8-mW1ufQ/gcc-4.8-4.8.4/build/x86_64-linux-gnu/libstdc++-v3/include/x86_64-linux-gnu/bits/gthr-default.h:662 (libstdc++.so.6+0x0000000b1cae)\r\n    #2 std::thread::_M_start_thread(std::shared_ptr<std::thread::_Impl_base>) /build/gcc-4.8-mW1ufQ/gcc-4.8-4.8.4/build/x86_64-linux-gnu/libstdc++-v3/src/c++11/../../../../../src/libstdc++-v3/src/c++11/thread.cc:142 (libstdc++.so.6+0x0000000b1cae)\r\n    #3 grpc::ThreadManager::WorkerThread::WorkerThread(grpc::ThreadManager*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/cpp/thread_manager/thread_manager.cc:34:10 (client_channel_stress_test+0x0000005dc98a)\r\n    #4 grpc::ThreadManager::MainWorkLoop() /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/cpp/thread_manager/thread_manager.cc:146:15 (client_channel_stress_test+0x0000005dcc66)\r\n    #5 grpc::ThreadManager::WorkerThread::Run() /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/cpp/thread_manager/thread_manager.cc:38:3 (client_channel_stress_test+0x0000005dca3e)\r\n    #6 void std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()>::operator()<, void>(grpc::ThreadManager::WorkerThread*) const /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/functional:601:11 (client_channel_stress_test+0x0000005dfbdb)\r\n    #7 void std::_Bind_simple<std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()> (grpc::ThreadManager::WorkerThread*)>::_M_invoke<0ul>(std::_Index_tuple<0ul>) /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/functional:1731:18 (client_channel_stress_test+0x0000005dfac5)\r\n    #8 std::_Bind_simple<std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()> (grpc::ThreadManager::WorkerThread*)>::operator()() /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/functional:1720:16 (client_channel_stress_test+0x0000005dfa48)\r\n    #9 std::thread::_Impl<std::_Bind_simple<std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()> (grpc::ThreadManager::WorkerThread*)> >::_M_run() /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/thread:115:13 (client_channel_stress_test+0x0000005df59c)\r\n    #10 execute_native_thread_routine /build/gcc-4.8-mW1ufQ/gcc-4.8-4.8.4/build/x86_64-linux-gnu/libstdc++-v3/src/c++11/../../../../../src/libstdc++-v3/src/c++11/thread.cc:84 (libstdc++.so.6+0x0000000b1a5f)\r\n\r\n  Thread T145 (tid=103228, running) created by thread T16 at:\r\n    #0 pthread_create /home/development/llvm/3.8.1/final/llvm.src/projects/compiler-rt/lib/tsan/rtl/tsan_interceptors.cc:954:3 (client_channel_stress_test+0x00000042e511)\r\n    #1 __gthread_create /build/gcc-4.8-mW1ufQ/gcc-4.8-4.8.4/build/x86_64-linux-gnu/libstdc++-v3/include/x86_64-linux-gnu/bits/gthr-default.h:662 (libstdc++.so.6+0x0000000b1cae)\r\n    #2 std::thread::_M_start_thread(std::shared_ptr<std::thread::_Impl_base>) /build/gcc-4.8-mW1ufQ/gcc-4.8-4.8.4/build/x86_64-linux-gnu/libstdc++-v3/src/c++11/../../../../../src/libstdc++-v3/src/c++11/thread.cc:142 (libstdc++.so.6+0x0000000b1cae)\r\n    #3 grpc::ThreadManager::WorkerThread::WorkerThread(grpc::ThreadManager*) /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/cpp/thread_manager/thread_manager.cc:34:10 (client_channel_stress_test+0x0000005dc98a)\r\n    #4 grpc::ThreadManager::MainWorkLoop() /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/cpp/thread_manager/thread_manager.cc:146:15 (client_channel_stress_test+0x0000005dcc66)\r\n    #5 grpc::ThreadManager::WorkerThread::Run() /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/cpp/thread_manager/thread_manager.cc:38:3 (client_channel_stress_test+0x0000005dca3e)\r\n    #6 void std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()>::operator()<, void>(grpc::ThreadManager::WorkerThread*) const /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/functional:601:11 (client_channel_stress_test+0x0000005dfbdb)\r\n    #7 void std::_Bind_simple<std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()> (grpc::ThreadManager::WorkerThread*)>::_M_invoke<0ul>(std::_Index_tuple<0ul>) /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/functional:1731:18 (client_channel_stress_test+0x0000005dfac5)\r\n    #8 std::_Bind_simple<std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()> (grpc::ThreadManager::WorkerThread*)>::operator()() /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/functional:1720:16 (client_channel_stress_test+0x0000005dfa48)\r\n    #9 std::thread::_Impl<std::_Bind_simple<std::_Mem_fn<void (grpc::ThreadManager::WorkerThread::*)()> (grpc::ThreadManager::WorkerThread*)> >::_M_run() /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../include/c++/4.8/thread:115:13 (client_channel_stress_test+0x0000005df59c)\r\n    #10 execute_native_thread_routine /build/gcc-4.8-mW1ufQ/gcc-4.8-4.8.4/build/x86_64-linux-gnu/libstdc++-v3/src/c++11/../../../../../src/libstdc++-v3/src/c++11/thread.cc:84 (libstdc++.so.6+0x0000000b1a5f)\r\n\r\nSUMMARY: ThreadSanitizer: data race /usr/local/google/home/juanlishen/wip/stress_test_tsan_bug/grpc/src/core/lib/surface/call.cc:1422:29 in process_data_after_md(batch_control*)\r\n==================\r\n\r\n2017-12-18 11:28:45,441 FAILED: bins/tsan/client_channel_stress_test GRPC_POLL_STRATEGY=epoll1 [ret=66, pid=102159, time=45.3sec]\r\n2017-12-18 11:28:45,442 FLAKE: bins/tsan/client_channel_stress_test GRPC_POLL_STRATEGY=epoll1 [1/35 runs flaked]\r\n\r\n```\r\n\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/352587296",
    "html_url": "https://github.com/grpc/grpc/issues/13812#issuecomment-352587296",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13812",
    "id": 352587296,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1MjU4NzI5Ng==",
    "user": {
      "login": "AspirinSJL",
      "id": 3314176,
      "node_id": "MDQ6VXNlcjMzMTQxNzY=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/3314176?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AspirinSJL",
      "html_url": "https://github.com/AspirinSJL",
      "followers_url": "https://api.github.com/users/AspirinSJL/followers",
      "following_url": "https://api.github.com/users/AspirinSJL/following{/other_user}",
      "gists_url": "https://api.github.com/users/AspirinSJL/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AspirinSJL/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AspirinSJL/subscriptions",
      "organizations_url": "https://api.github.com/users/AspirinSJL/orgs",
      "repos_url": "https://api.github.com/users/AspirinSJL/repos",
      "events_url": "https://api.github.com/users/AspirinSJL/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AspirinSJL/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-12-18T23:09:47Z",
    "updated_at": "2017-12-18T23:09:47Z",
    "author_association": "MEMBER",
    "body": "@markdroth , this bug occurs when I'm trying to fix another tsan problem in the stress test. "
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/353162023",
    "html_url": "https://github.com/grpc/grpc/issues/13812#issuecomment-353162023",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13812",
    "id": 353162023,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1MzE2MjAyMw==",
    "user": {
      "login": "markdroth",
      "id": 18664614,
      "node_id": "MDQ6VXNlcjE4NjY0NjE0",
      "avatar_url": "https://avatars2.githubusercontent.com/u/18664614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/markdroth",
      "html_url": "https://github.com/markdroth",
      "followers_url": "https://api.github.com/users/markdroth/followers",
      "following_url": "https://api.github.com/users/markdroth/following{/other_user}",
      "gists_url": "https://api.github.com/users/markdroth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/markdroth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/markdroth/subscriptions",
      "organizations_url": "https://api.github.com/users/markdroth/orgs",
      "repos_url": "https://api.github.com/users/markdroth/repos",
      "events_url": "https://api.github.com/users/markdroth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/markdroth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-12-20T19:37:21Z",
    "updated_at": "2017-12-20T19:37:21Z",
    "author_association": "MEMBER",
    "body": "It looks to me like this is caused by the grpclb code reusing `glb_policy->lb_response_payload` for two different pending ops at once.  One possible way this could happen is if the LB call fails while it has a pending recv_message op, and we create a new LB call and start a recv_message op on the new call before we've gotten the on_complete callback from the recv_message op on the original call.\r\n\r\nI think we can fix this by moving the per-call data to its own struct and allocating a new one for each LB call, so that we're not at risk of reusing the data if the old call still has pending callbacks when we create the new call."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/360264810",
    "html_url": "https://github.com/grpc/grpc/issues/13812#issuecomment-360264810",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13812",
    "id": 360264810,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDI2NDgxMA==",
    "user": {
      "login": "AspirinSJL",
      "id": 3314176,
      "node_id": "MDQ6VXNlcjMzMTQxNzY=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/3314176?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AspirinSJL",
      "html_url": "https://github.com/AspirinSJL",
      "followers_url": "https://api.github.com/users/AspirinSJL/followers",
      "following_url": "https://api.github.com/users/AspirinSJL/following{/other_user}",
      "gists_url": "https://api.github.com/users/AspirinSJL/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AspirinSJL/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AspirinSJL/subscriptions",
      "organizations_url": "https://api.github.com/users/AspirinSJL/orgs",
      "repos_url": "https://api.github.com/users/AspirinSJL/repos",
      "events_url": "https://api.github.com/users/AspirinSJL/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AspirinSJL/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-24T20:34:51Z",
    "updated_at": "2018-01-24T20:34:51Z",
    "author_association": "MEMBER",
    "body": "Fixed via #13911."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/380586507",
    "html_url": "https://github.com/grpc/grpc/issues/13812#issuecomment-380586507",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13812",
    "id": 380586507,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MDU4NjUwNw==",
    "user": {
      "login": "matt-kwong",
      "id": 22083734,
      "node_id": "MDQ6VXNlcjIyMDgzNzM0",
      "avatar_url": "https://avatars1.githubusercontent.com/u/22083734?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/matt-kwong",
      "html_url": "https://github.com/matt-kwong",
      "followers_url": "https://api.github.com/users/matt-kwong/followers",
      "following_url": "https://api.github.com/users/matt-kwong/following{/other_user}",
      "gists_url": "https://api.github.com/users/matt-kwong/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/matt-kwong/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/matt-kwong/subscriptions",
      "organizations_url": "https://api.github.com/users/matt-kwong/orgs",
      "repos_url": "https://api.github.com/users/matt-kwong/repos",
      "events_url": "https://api.github.com/users/matt-kwong/events{/privacy}",
      "received_events_url": "https://api.github.com/users/matt-kwong/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-04-11T20:33:06Z",
    "updated_at": "2018-04-11T20:33:06Z",
    "author_association": "CONTRIBUTOR",
    "body": "This happened again recently on [master](https://sponge.corp.google.com/invocation?tab=Build+Log&id=d1314476-e200-493f-8acf-9fb9c1c7acec&searchFor&page=1):\r\n\r\n```\r\nI0408 22:22:42.588260515    6799 grpclb.cc:477]              Missing LB token for backend address 'ipv4:127.0.0.1:21091'. The empty token will be used instead\r\nI0408 22:22:42.588275305    6799 grpclb.cc:477]              Missing LB token for backend address 'ipv4:127.0.0.1:8618'. The empty token will be used instead\r\nI0408 22:22:42.588293222    6799 grpclb.cc:477]              Missing LB token for backend address 'ipv4:127.0.0.1:5231'. The empty token will be used instead\r\nI0408 22:22:42.588308368    6799 grpclb.cc:477]              Missing LB token for backend address 'ipv4:127.0.0.1:17536'. The empty token will be used instead\r\nI0408 22:22:42.588327002    6799 grpclb.cc:477]              Missing LB token for backend address 'ipv4:127.0.0.1:8595'. The empty token will be used instead\r\nI0408 22:22:42.588340466    6799 grpclb.cc:477]              Missing LB token for backend address 'ipv4:127.0.0.1:8595'. The empty token will be used instead\r\nI0408 22:22:42.588355168    6799 grpclb.cc:477]              Missing LB token for backend address 'ipv4:127.0.0.1:21091'. The empty token will be used instead\r\nI0408 22:22:42.588370525    6799 grpclb.cc:477]              Missing LB token for backend address 'ipv4:127.0.0.1:17536'. The empty token will be used instead\r\n==================\r\nWARNING: ThreadSanitizer: data race (pid=1219)\r\n  Atomic write of size 8 at 0x7d2c002f6ea0 by thread T94 (mutexes: write M3154):\r\n    #0 __tsan_atomic64_fetch_add /llvm/projects/compiler-rt/lib/tsan/rtl/tsan_interface_atomic.cc:619 (client_channel_stress_test+0x000000478320)\r\n    #1 gpr_ref /var/local/git/grpc/src/core/lib/gpr/sync.cc:88:33 (client_channel_stress_test+0x0000005fd4d6)\r\n    #2 grpc_error_ref(grpc_error*, char const*, int) /var/local/git/grpc/src/core/lib/iomgr/error.cc:137:3 (client_channel_stress_test+0x00000055e607)\r\n    #3 grpc_error_create(char const*, int, grpc_slice, grpc_error**, unsigned long) /var/local/git/grpc/src/core/lib/iomgr/error.cc:352:9 (client_channel_stress_test+0x00000055ebd5)\r\n    #4 grpc_core::LockfreeEvent::NotifyOn(grpc_closure*) /var/local/git/grpc/src/core/lib/iomgr/lockfree_event.cc:136:84 (client_channel_stress_test+0x0000005be524)\r\n    #5 fd_notify_on_read(grpc_fd*, grpc_closure*) /var/local/git/grpc/src/core/lib/iomgr/ev_epollsig_linux.cc:941:3 (client_channel_stress_test+0x0000005adf04)\r\n    #6 grpc_fd_notify_on_read(grpc_fd*, grpc_closure*) /var/local/git/grpc/src/core/lib/iomgr/ev_posix.cc:220:3 (client_channel_stress_test+0x000000599611)\r\n    #7 notify_on_read((anonymous namespace)::grpc_tcp*) /var/local/git/grpc/src/core/lib/iomgr/tcp_posix.cc:218:3 (client_channel_stress_test+0x000000573d6e)\r\n    #8 tcp_do_read((anonymous namespace)::grpc_tcp*) /var/local/git/grpc/src/core/lib/iomgr/tcp_posix.cc:411:7 (client_channel_stress_test+0x000000574e92)\r\n    #9 tcp_read_allocation_done(void*, grpc_error*) /var/local/git/grpc/src/core/lib/iomgr/tcp_posix.cc:453:5 (client_channel_stress_test+0x000000572e5b)\r\n    #10 exec_ctx_run(grpc_closure*, grpc_error*) /var/local/git/grpc/src/core/lib/iomgr/exec_ctx.cc:40:3 (client_channel_stress_test+0x000000563589)\r\n    #11 grpc_closure_run(char const*, int, grpc_closure*, grpc_error*) /var/local/git/grpc/./src/core/lib/iomgr/closure.h:258:5 (client_channel_stress_test+0x00000056d773)\r\n    #12 ru_allocated_slices(void*, grpc_error*) /var/local/git/grpc/src/core/lib/iomgr/resource_quota.cc:553:3 (client_channel_stress_test+0x00000056ad75)\r\n    #13 exec_ctx_run(grpc_closure*, grpc_error*) /var/local/git/grpc/src/core/lib/iomgr/exec_ctx.cc:40:3 (client_channel_stress_test+0x000000563589)\r\n    #14 grpc_core::ExecCtx::Flush() /var/local/git/grpc/src/core/lib/iomgr/exec_ctx.cc:128:9 (client_channel_stress_test+0x000000563323)\r\n    #15 pollset_work(grpc_pollset*, grpc_pollset_worker**, long) /var/local/git/grpc/src/core/lib/iomgr/ev_epollsig_linux.cc:1352:5 (client_channel_stress_test+0x0000005ae6e4)\r\n    #16 pollset_work(grpc_pollset*, grpc_pollset_worker**, long) /var/local/git/grpc/src/core/lib/iomgr/ev_posix.cc:249:21 (client_channel_stress_test+0x000000599a7b)\r\n    #17 grpc_pollset_work(grpc_pollset*, grpc_pollset_worker**, long) /var/local/git/grpc/src/core/lib/iomgr/pollset.cc:48:10 (client_channel_stress_test+0x000000566e04)\r\n    #18 cq_pluck(grpc_completion_queue*, void*, gpr_timespec, void*) /var/local/git/grpc/src/core/lib/surface/completion_queue.cc:1172:9 (client_channel_stress_test+0x0000006275ee)\r\n    #19 grpc_completion_queue_pluck /var/local/git/grpc/src/core/lib/surface/completion_queue.cc:1199:10 (client_channel_stress_test+0x000000624c00)\r\n    #20 grpc::CoreCodegen::grpc_completion_queue_pluck(grpc_completion_queue*, void*, gpr_timespec, void*) /var/local/git/grpc/src/cpp/common/core_codegen.cc:70:10 (client_channel_stress_test+0x0000005caa96)\r\n    #21 grpc::CompletionQueue::Pluck(grpc::internal::CompletionQueueTag*) /var/local/git/grpc/include/grpcpp/impl/codegen/completion_queue.h:296:15 (client_channel_stress_test+0x0000004de6c1)\r\n    #22 grpc::internal::BlockingUnaryCallImpl<grpc::testing::EchoRequest, grpc::testing::EchoResponse>::BlockingUnaryCallImpl(grpc::ChannelInterface*, grpc::internal::RpcMethod const&, grpc::ClientContext*, grpc::testing::EchoRequest const&, grpc::testing::EchoResponse*) /var/local/git/grpc/include/grpcpp/impl/codegen/client_unary_call.h:72:9 (client_channel_stress_test+0x00000052a72d)\r\n    #23 grpc::Status grpc::internal::BlockingUnaryCall<grpc::testing::EchoRequest, grpc::testing::EchoResponse>(grpc::ChannelInterface*, grpc::internal::RpcMethod const&, grpc::ClientContext*, grpc::testing::EchoRequest const&, grpc::testing::EchoResponse*) /var/local/git/grpc/include/grpcpp/impl/codegen/client_unary_call.h:41:10 (client_channel_stress_test+0x0000005282bd)\r\n    #24 grpc::testing::EchoTestService::Stub::Echo(grpc::ClientContext*, grpc::testing::EchoRequest const&, grpc::testing::EchoResponse*) /var/local/git/grpc/gens/src/proto/grpc/testing/echo.grpc.pb.cc:42:10 (client_channel_stress_test+0x000000525e60)\r\n    #25 grpc::testing::(anonymous namespace)::ClientChannelStressTest::KeepSendingRequests() /var/local/git/grpc/test/cpp/client/client_channel_stress_test.cc:248:9 (client_channel_stress_test+0x0000004f6d1c)\r\n    #26 void std::_Mem_fn<void (grpc::testing::(anonymous namespace)::ClientChannelStressTest::*)()>::operator()<, void>(grpc::testing::(anonymous namespace)::ClientChannelStressTest*) const /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/functional:569:11 (client_channel_stress_test+0x00000050340b)\r\n    #27 void std::_Bind_simple<std::_Mem_fn<void (grpc::testing::(anonymous namespace)::ClientChannelStressTest::*)()> (grpc::testing::(anonymous namespace)::ClientChannelStressTest*)>::_M_invoke<0ul>(std::_Index_tuple<0ul>) /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/functional:1699:18 (client_channel_stress_test+0x0000005032f5)\r\n    #28 std::_Bind_simple<std::_Mem_fn<void (grpc::testing::(anonymous namespace)::ClientChannelStressTest::*)()> (grpc::testing::(anonymous namespace)::ClientChannelStressTest*)>::operator()() /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/functional:1688:16 (client_channel_stress_test+0x000000503278)\r\n    #29 std::thread::_Impl<std::_Bind_simple<std::_Mem_fn<void (grpc::testing::(anonymous namespace)::ClientChannelStressTest::*)()> (grpc::testing::(anonymous namespace)::ClientChannelStressTest*)> >::_M_run() /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/thread:115:13 (client_channel_stress_test+0x000000502dcc)\r\n    #30 <null> <null> (libstdc++.so.6+0x0000000b696f)\r\n\r\n  Previous write of size 8 at 0x7d2c002f6ea0 by thread T148:\r\n    #0 malloc /llvm/projects/compiler-rt/lib/tsan/rtl/tsan_interceptors.cc:595 (client_channel_stress_test+0x000000450458)\r\n    #1 gpr_malloc /var/local/git/grpc/src/core/lib/gpr/alloc.cc:57:7 (client_channel_stress_test+0x0000005f9218)\r\n    #2 grpc_error_create(char const*, int, grpc_slice, grpc_error**, unsigned long) /var/local/git/grpc/src/core/lib/iomgr/error.cc:324:7 (client_channel_stress_test+0x00000055e88d)\r\n    #3 close_transport_locked(grpc_chttp2_transport*, grpc_error*) /var/local/git/grpc/src/core/ext/transport/chttp2/transport/chttp2_transport.cc:588:13 (client_channel_stress_test+0x00000068d09c)\r\n    #4 destroy_transport_locked(void*, grpc_error*) /var/local/git/grpc/src/core/ext/transport/chttp2/transport/chttp2_transport.cc:562:3 (client_channel_stress_test+0x0000006a1f3b)\r\n    #5 closure_impl::closure_wrapper(void*, grpc_error*) /var/local/git/grpc/./src/core/lib/iomgr/closure.h:150:3 (client_channel_stress_test+0x00000054f42e)\r\n    #6 grpc_combiner_continue_exec_ctx() /var/local/git/grpc/src/core/lib/iomgr/combiner.cc:259:5 (client_channel_stress_test+0x00000055cc19)\r\n    #7 grpc_core::ExecCtx::Flush() /var/local/git/grpc/src/core/lib/iomgr/exec_ctx.cc:131:17 (client_channel_stress_test+0x00000056333a)\r\n    #8 run_closures(grpc_closure_list) /var/local/git/grpc/src/core/lib/iomgr/executor.cc:82:5 (client_channel_stress_test+0x0000005645e9)\r\n    #9 executor_thread(void*) /var/local/git/grpc/src/core/lib/iomgr/executor.cc:180:22 (client_channel_stress_test+0x00000056435e)\r\n    #10 grpc_core::(anonymous namespace)::ThreadInternalsPosix::ThreadInternalsPosix(char const*, void (*)(void*), void*, bool*)::{lambda(void*)#1}::operator()(void*) const /var/local/git/grpc/src/core/lib/gprpp/thd_posix.cc:105:27 (client_channel_stress_test+0x00000060071c)\r\n    #11 grpc_core::(anonymous namespace)::ThreadInternalsPosix::ThreadInternalsPosix(char const*, void (*)(void*), void*, bool*)::{lambda(void*)#1}::__invoke(void*) /var/local/git/grpc/src/core/lib/gprpp/thd_posix.cc:79:25 (client_channel_stress_test+0x0000006005b8)\r\n\r\n  Location is heap block of size 168 at 0x7d2c002f6ea0 allocated by thread T148:\r\n    #0 malloc /llvm/projects/compiler-rt/lib/tsan/rtl/tsan_interceptors.cc:595 (client_channel_stress_test+0x000000450458)\r\n    #1 gpr_malloc /var/local/git/grpc/src/core/lib/gpr/alloc.cc:57:7 (client_channel_stress_test+0x0000005f9218)\r\n    #2 grpc_error_create(char const*, int, grpc_slice, grpc_error**, unsigned long) /var/local/git/grpc/src/core/lib/iomgr/error.cc:324:7 (client_channel_stress_test+0x00000055e88d)\r\n    #3 close_transport_locked(grpc_chttp2_transport*, grpc_error*) /var/local/git/grpc/src/core/ext/transport/chttp2/transport/chttp2_transport.cc:588:13 (client_channel_stress_test+0x00000068d09c)\r\n    #4 destroy_transport_locked(void*, grpc_error*) /var/local/git/grpc/src/core/ext/transport/chttp2/transport/chttp2_transport.cc:562:3 (client_channel_stress_test+0x0000006a1f3b)\r\n    #5 closure_impl::closure_wrapper(void*, grpc_error*) /var/local/git/grpc/./src/core/lib/iomgr/closure.h:150:3 (client_channel_stress_test+0x00000054f42e)\r\n    #6 grpc_combiner_continue_exec_ctx() /var/local/git/grpc/src/core/lib/iomgr/combiner.cc:259:5 (client_channel_stress_test+0x00000055cc19)\r\n    #7 grpc_core::ExecCtx::Flush() /var/local/git/grpc/src/core/lib/iomgr/exec_ctx.cc:131:17 (client_channel_stress_test+0x00000056333a)\r\n    #8 run_closures(grpc_closure_list) /var/local/git/grpc/src/core/lib/iomgr/executor.cc:82:5 (client_channel_stress_test+0x0000005645e9)\r\n    #9 executor_thread(void*) /var/local/git/grpc/src/core/lib/iomgr/executor.cc:180:22 (client_channel_stress_test+0x00000056435e)\r\n    #10 grpc_core::(anonymous namespace)::ThreadInternalsPosix::ThreadInternalsPosix(char const*, void (*)(void*), void*, bool*)::{lambda(void*)#1}::operator()(void*) const /var/local/git/grpc/src/core/lib/gprpp/thd_posix.cc:105:27 (client_channel_stress_test+0x00000060071c)\r\n    #11 grpc_core::(anonymous namespace)::ThreadInternalsPosix::ThreadInternalsPosix(char const*, void (*)(void*), void*, bool*)::{lambda(void*)#1}::__invoke(void*) /var/local/git/grpc/src/core/lib/gprpp/thd_posix.cc:79:25 (client_channel_stress_test+0x0000006005b8)\r\n\r\n  Mutex M3154 (0x7fffa7716178) created at:\r\n    #0 pthread_mutex_lock /llvm/projects/compiler-rt/lib/tsan/../sanitizer_common/sanitizer_common_interceptors.inc:3319 (client_channel_stress_test+0x000000440780)\r\n    #1 __gthread_mutex_lock(pthread_mutex_t*) /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/x86_64-linux-gnu/c++/4.9/bits/gthr-default.h:748:12 (client_channel_stress_test+0x0000004f86e6)\r\n    #2 std::mutex::lock() /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/mutex:135:17 (client_channel_stress_test+0x00000050b0a8)\r\n    #3 std::lock_guard<std::mutex>::lock_guard(std::mutex&) /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/mutex:377:9 (client_channel_stress_test+0x00000050b695)\r\n    #4 grpc::testing::(anonymous namespace)::ClientChannelStressTest::KeepSendingRequests() /var/local/git/grpc/test/cpp/client/client_channel_stress_test.cc:247:37 (client_channel_stress_test+0x0000004f6ce0)\r\n    #5 void std::_Mem_fn<void (grpc::testing::(anonymous namespace)::ClientChannelStressTest::*)()>::operator()<, void>(grpc::testing::(anonymous namespace)::ClientChannelStressTest*) const /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/functional:569:11 (client_channel_stress_test+0x00000050340b)\r\n    #6 void std::_Bind_simple<std::_Mem_fn<void (grpc::testing::(anonymous namespace)::ClientChannelStressTest::*)()> (grpc::testing::(anonymous namespace)::ClientChannelStressTest*)>::_M_invoke<0ul>(std::_Index_tuple<0ul>) /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/functional:1699:18 (client_channel_stress_test+0x0000005032f5)\r\n    #7 std::_Bind_simple<std::_Mem_fn<void (grpc::testing::(anonymous namespace)::ClientChannelStressTest::*)()> (grpc::testing::(anonymous namespace)::ClientChannelStressTest*)>::operator()() /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/functional:1688:16 (client_channel_stress_test+0x000000503278)\r\n    #8 std::thread::_Impl<std::_Bind_simple<std::_Mem_fn<void (grpc::testing::(anonymous namespace)::ClientChannelStressTest::*)()> (grpc::testing::(anonymous namespace)::ClientChannelStressTest*)> >::_M_run() /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/thread:115:13 (client_channel_stress_test+0x000000502dcc)\r\n    #9 <null> <null> (libstdc++.so.6+0x0000000b696f)\r\n\r\n  Thread T94 (tid=1354, running) created by main thread at:\r\n    #0 pthread_create /llvm/projects/compiler-rt/lib/tsan/rtl/tsan_interceptors.cc:954 (client_channel_stress_test+0x000000459b33)\r\n    #1 std::thread::_M_start_thread(std::shared_ptr<std::thread::_Impl_base>) <null> (libstdc++.so.6+0x0000000b6a90)\r\n    #2 grpc::testing::(anonymous namespace)::ClientChannelStressTest::Start() /var/local/git/grpc/test/cpp/client/client_channel_stress_test.cc:286:11 (client_channel_stress_test+0x0000004f4fd0)\r\n    #3 grpc::testing::(anonymous namespace)::ClientChannelStressTest::Run() /var/local/git/grpc/test/cpp/client/client_channel_stress_test.cc:133:5 (client_channel_stress_test+0x0000004f2c68)\r\n    #4 main /var/local/git/grpc/test/cpp/client/client_channel_stress_test.cc:326:3 (client_channel_stress_test+0x0000004f2a41)\r\n\r\n  Thread T148 'grpc_executor' (tid=9213, running) created by thread T114 at:\r\n    #0 pthread_create /llvm/projects/compiler-rt/lib/tsan/rtl/tsan_interceptors.cc:954 (client_channel_stress_test+0x000000459b33)\r\n    #1 grpc_core::(anonymous namespace)::ThreadInternalsPosix::ThreadInternalsPosix(char const*, void (*)(void*), void*, bool*) /var/local/git/grpc/src/core/lib/gprpp/thd_posix.cc:78:10 (client_channel_stress_test+0x0000006001be)\r\n    #2 grpc_core::(anonymous namespace)::ThreadInternalsPosix* grpc_core::New<grpc_core::(anonymous namespace)::ThreadInternalsPosix, char const*&, void (*&)(void*), void*&, bool*>(char const*&, void (*&)(void*), void*&, bool*&&) /var/local/git/grpc/./src/core/lib/gprpp/memory.h:41:18 (client_channel_stress_test+0x0000005ffcd3)\r\n    #3 grpc_core::Thread::Thread(char const*, void (*)(void*), void*, bool*) /var/local/git/grpc/src/core/lib/gprpp/thd_posix.cc:170:7 (client_channel_stress_test+0x0000005ffaf4)\r\n    #4 executor_push(grpc_closure*, grpc_error*, bool) /var/local/git/grpc/src/core/lib/iomgr/executor.cc:268:13 (client_channel_stress_test+0x000000564fa8)\r\n    #5 executor_push_short(grpc_closure*, grpc_error*) /var/local/git/grpc/src/core/lib/iomgr/executor.cc:281:3 (client_channel_stress_test+0x00000056470d)\r\n    #6 grpc_closure_sched(char const*, int, grpc_closure*, grpc_error*) /var/local/git/grpc/./src/core/lib/iomgr/closure.h:297:5 (client_channel_stress_test+0x00000054ec52)\r\n    #7 queue_offload(grpc_combiner*) /var/local/git/grpc/src/core/lib/iomgr/combiner.cc:207:3 (client_channel_stress_test+0x00000055d126)\r\n    #8 grpc_combiner_continue_exec_ctx() /var/local/git/grpc/src/core/lib/iomgr/combiner.cc:235:5 (client_channel_stress_test+0x00000055ca46)\r\n    #9 grpc_core::ExecCtx::Flush() /var/local/git/grpc/src/core/lib/iomgr/exec_ctx.cc:131:17 (client_channel_stress_test+0x00000056333a)\r\n    #10 pollset_work(grpc_pollset*, grpc_pollset_worker**, long) /var/local/git/grpc/src/core/lib/iomgr/ev_epollsig_linux.cc:1352:5 (client_channel_stress_test+0x0000005ae6e4)\r\n    #11 pollset_work(grpc_pollset*, grpc_pollset_worker**, long) /var/local/git/grpc/src/core/lib/iomgr/ev_posix.cc:249:21 (client_channel_stress_test+0x000000599a7b)\r\n    #12 grpc_pollset_work(grpc_pollset*, grpc_pollset_worker**, long) /var/local/git/grpc/src/core/lib/iomgr/pollset.cc:48:10 (client_channel_stress_test+0x000000566e04)\r\n    #13 cq_pluck(grpc_completion_queue*, void*, gpr_timespec, void*) /var/local/git/grpc/src/core/lib/surface/completion_queue.cc:1172:9 (client_channel_stress_test+0x0000006275ee)\r\n    #14 grpc_completion_queue_pluck /var/local/git/grpc/src/core/lib/surface/completion_queue.cc:1199:10 (client_channel_stress_test+0x000000624c00)\r\n    #15 grpc::CoreCodegen::grpc_completion_queue_pluck(grpc_completion_queue*, void*, gpr_timespec, void*) /var/local/git/grpc/src/cpp/common/core_codegen.cc:70:10 (client_channel_stress_test+0x0000005caa96)\r\n    #16 grpc::CompletionQueue::Pluck(grpc::internal::CompletionQueueTag*) /var/local/git/grpc/include/grpcpp/impl/codegen/completion_queue.h:296:15 (client_channel_stress_test+0x0000004de6c1)\r\n    #17 grpc::internal::BlockingUnaryCallImpl<grpc::testing::EchoRequest, grpc::testing::EchoResponse>::BlockingUnaryCallImpl(grpc::ChannelInterface*, grpc::internal::RpcMethod const&, grpc::ClientContext*, grpc::testing::EchoRequest const&, grpc::testing::EchoResponse*) /var/local/git/grpc/include/grpcpp/impl/codegen/client_unary_call.h:72:9 (client_channel_stress_test+0x00000052a72d)\r\n    #18 grpc::Status grpc::internal::BlockingUnaryCall<grpc::testing::EchoRequest, grpc::testing::EchoResponse>(grpc::ChannelInterface*, grpc::internal::RpcMethod const&, grpc::ClientContext*, grpc::testing::EchoRequest const&, grpc::testing::EchoResponse*) /var/local/git/grpc/include/grpcpp/impl/codegen/client_unary_call.h:41:10 (client_channel_stress_test+0x0000005282bd)\r\n    #19 grpc::testing::EchoTestService::Stub::Echo(grpc::ClientContext*, grpc::testing::EchoRequest const&, grpc::testing::EchoResponse*) /var/local/git/grpc/gens/src/proto/grpc/testing/echo.grpc.pb.cc:42:10 (client_channel_stress_test+0x000000525e60)\r\n    #20 grpc::testing::(anonymous namespace)::ClientChannelStressTest::KeepSendingRequests() /var/local/git/grpc/test/cpp/client/client_channel_stress_test.cc:248:9 (client_channel_stress_test+0x0000004f6d1c)\r\n    #21 void std::_Mem_fn<void (grpc::testing::(anonymous namespace)::ClientChannelStressTest::*)()>::operator()<, void>(grpc::testing::(anonymous namespace)::ClientChannelStressTest*) const /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/functional:569:11 (client_channel_stress_test+0x00000050340b)\r\n    #22 void std::_Bind_simple<std::_Mem_fn<void (grpc::testing::(anonymous namespace)::ClientChannelStressTest::*)()> (grpc::testing::(anonymous namespace)::ClientChannelStressTest*)>::_M_invoke<0ul>(std::_Index_tuple<0ul>) /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/functional:1699:18 (client_channel_stress_test+0x0000005032f5)\r\n    #23 std::_Bind_simple<std::_Mem_fn<void (grpc::testing::(anonymous namespace)::ClientChannelStressTest::*)()> (grpc::testing::(anonymous namespace)::ClientChannelStressTest*)>::operator()() /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/functional:1688:16 (client_channel_stress_test+0x000000503278)\r\n    #24 std::thread::_Impl<std::_Bind_simple<std::_Mem_fn<void (grpc::testing::(anonymous namespace)::ClientChannelStressTest::*)()> (grpc::testing::(anonymous namespace)::ClientChannelStressTest*)> >::_M_run() /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/thread:115:13 (client_channel_stress_test+0x000000502dcc)\r\n    #25 <null> <null> (libstdc++.so.6+0x0000000b696f)\r\n\r\nSUMMARY: ThreadSanitizer: data race /var/local/git/grpc/src/core/lib/gpr/sync.cc:88:33 in gpr_ref\r\n==================\r\nCommand exited with non-zero status 66\r\nreal 27.77\r\nuser 43.44\r\nsys 4.05\r\n\r\n2018-04-08 22:22:42,859 FAILED: bins/tsan/client_channel_stress_test GRPC_POLL_STRATEGY=epollsig [ret=66, pid=1217, time=27.8sec]\r\n```"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/413989166",
    "html_url": "https://github.com/grpc/grpc/issues/13812#issuecomment-413989166",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13812",
    "id": 413989166,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxMzk4OTE2Ng==",
    "user": {
      "login": "AspirinSJL",
      "id": 3314176,
      "node_id": "MDQ6VXNlcjMzMTQxNzY=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/3314176?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/AspirinSJL",
      "html_url": "https://github.com/AspirinSJL",
      "followers_url": "https://api.github.com/users/AspirinSJL/followers",
      "following_url": "https://api.github.com/users/AspirinSJL/following{/other_user}",
      "gists_url": "https://api.github.com/users/AspirinSJL/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/AspirinSJL/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/AspirinSJL/subscriptions",
      "organizations_url": "https://api.github.com/users/AspirinSJL/orgs",
      "repos_url": "https://api.github.com/users/AspirinSJL/repos",
      "events_url": "https://api.github.com/users/AspirinSJL/events{/privacy}",
      "received_events_url": "https://api.github.com/users/AspirinSJL/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-17T21:10:13Z",
    "updated_at": "2018-08-17T21:10:13Z",
    "author_association": "MEMBER",
    "body": "The above is actually a different tsan issue in `grpc_error_ref()`. "
  }
]
