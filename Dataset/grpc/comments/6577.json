[
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/219101563",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-219101563",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 219101563,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxOTEwMTU2Mw==",
    "user": {
      "login": "murgatroid99",
      "id": 961599,
      "node_id": "MDQ6VXNlcjk2MTU5OQ==",
      "avatar_url": "https://avatars3.githubusercontent.com/u/961599?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/murgatroid99",
      "html_url": "https://github.com/murgatroid99",
      "followers_url": "https://api.github.com/users/murgatroid99/followers",
      "following_url": "https://api.github.com/users/murgatroid99/following{/other_user}",
      "gists_url": "https://api.github.com/users/murgatroid99/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/murgatroid99/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/murgatroid99/subscriptions",
      "organizations_url": "https://api.github.com/users/murgatroid99/orgs",
      "repos_url": "https://api.github.com/users/murgatroid99/repos",
      "events_url": "https://api.github.com/users/murgatroid99/events{/privacy}",
      "received_events_url": "https://api.github.com/users/murgatroid99/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-13T17:03:59Z",
    "updated_at": "2016-05-13T17:03:59Z",
    "author_association": "MEMBER",
    "body": "My initial guess from seeing the trace is that Puma and Phusion Passenger may do something to outgoing requests that prevents HTTP2 streams from working. I'll have to investigate more to verify that, though.\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/219878066",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-219878066",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 219878066,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxOTg3ODA2Ng==",
    "user": {
      "login": "bmclean",
      "id": 622145,
      "node_id": "MDQ6VXNlcjYyMjE0NQ==",
      "avatar_url": "https://avatars1.githubusercontent.com/u/622145?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bmclean",
      "html_url": "https://github.com/bmclean",
      "followers_url": "https://api.github.com/users/bmclean/followers",
      "following_url": "https://api.github.com/users/bmclean/following{/other_user}",
      "gists_url": "https://api.github.com/users/bmclean/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bmclean/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bmclean/subscriptions",
      "organizations_url": "https://api.github.com/users/bmclean/orgs",
      "repos_url": "https://api.github.com/users/bmclean/repos",
      "events_url": "https://api.github.com/users/bmclean/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bmclean/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-17T22:53:26Z",
    "updated_at": "2016-05-17T22:53:26Z",
    "author_association": "NONE",
    "body": "This [Rails app](https://github.com/Agrimatics/active-model-cloud-datastore) that can be used to recreate the problem. It can be run locally connected to an actual datastore to see the problem. To run it locally in development mode comment out the `ENV['DATASTORE_EMULATOR_HOST']` line and add the desired cloud datastore project in config/initializers/cloud_datastore.rb:\n\nExample:\n\n```\nmodule CloudDatastore\n  if Rails.env.development?\n    # ENV['DATASTORE_EMULATOR_HOST'] = 'localhost:8180'\n  elsif Rails.env.test?\n    ENV['DATASTORE_EMULATOR_HOST'] = 'localhost:8181'\n  else\n    ENV['GCLOUD_KEYFILE_JSON'] = '{\"private_key\": \"' + ENV['SERVICE_ACCOUNT_PRIVATE_KEY'] + '\",\n      \"client_email\": \"' + ENV['SERVICE_ACCOUNT_CLIENT_EMAIL'] + '\"}'\n  end\n\n  def self.dataset\n    config = Rails.application.config.database_configuration[Rails.env]['dataset_id']\n    @dataset ||= Gcloud.datastore('datastore-project-name-here')\n  end\n\n  def self.reset_dataset\n    @dataset = nil\n  end\nend\n```\n\nI worked through the code and got to here:\n\nIt starts with a dataset.run(query).\n\nThe method 'run' in Gcloud::Datastore::Dataset calls service.run_query.\n\nThe method 'run_query' in Gcloud::Datastore::Service calls datastore.run_query.\n\nThe method 'run_query' is created with a define_method in GRPC::GenericService::Dsl.rpc_stub_class.\n\nThe defined method run_query calls GRPC::ClientStub.request_response, which builds a new_active_call object and calls request_response on it. That method then calls GRPC:ActiveCall.start_call which in turn calls ActiveCall.client_invoke which has a call.run_batch method which fails to return anything and hangs.\n\nThe ActiveCall.client_invoke does have the following comment:\nFlow Control note: this blocks until flow control accepts that client request can go ahead.\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/219880054",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-219880054",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 219880054,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxOTg4MDA1NA==",
    "user": {
      "login": "murgatroid99",
      "id": 961599,
      "node_id": "MDQ6VXNlcjk2MTU5OQ==",
      "avatar_url": "https://avatars3.githubusercontent.com/u/961599?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/murgatroid99",
      "html_url": "https://github.com/murgatroid99",
      "followers_url": "https://api.github.com/users/murgatroid99/followers",
      "following_url": "https://api.github.com/users/murgatroid99/following{/other_user}",
      "gists_url": "https://api.github.com/users/murgatroid99/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/murgatroid99/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/murgatroid99/subscriptions",
      "organizations_url": "https://api.github.com/users/murgatroid99/orgs",
      "repos_url": "https://api.github.com/users/murgatroid99/repos",
      "events_url": "https://api.github.com/users/murgatroid99/events{/privacy}",
      "received_events_url": "https://api.github.com/users/murgatroid99/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-17T23:04:30Z",
    "updated_at": "2016-05-17T23:04:30Z",
    "author_association": "MEMBER",
    "body": "To be clear, are you saying that this problem reproduces locally using the datastore emulator, or only using an actual datastore?\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/219880941",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-219880941",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 219880941,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxOTg4MDk0MQ==",
    "user": {
      "login": "bmclean",
      "id": 622145,
      "node_id": "MDQ6VXNlcjYyMjE0NQ==",
      "avatar_url": "https://avatars1.githubusercontent.com/u/622145?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bmclean",
      "html_url": "https://github.com/bmclean",
      "followers_url": "https://api.github.com/users/bmclean/followers",
      "following_url": "https://api.github.com/users/bmclean/following{/other_user}",
      "gists_url": "https://api.github.com/users/bmclean/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bmclean/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bmclean/subscriptions",
      "organizations_url": "https://api.github.com/users/bmclean/orgs",
      "repos_url": "https://api.github.com/users/bmclean/repos",
      "events_url": "https://api.github.com/users/bmclean/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bmclean/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-17T23:09:38Z",
    "updated_at": "2016-05-17T23:17:48Z",
    "author_association": "NONE",
    "body": "@murgatroid99 Only when connecting to an actual datastore. You can run the Rails app locally while connecting to an actual datastore to see the problem though. You need to comment out the `ENV['DATASTORE_EMULATOR_HOST']` so it will connect to an actual datastore.\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/219882067",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-219882067",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 219882067,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxOTg4MjA2Nw==",
    "user": {
      "login": "bmclean",
      "id": 622145,
      "node_id": "MDQ6VXNlcjYyMjE0NQ==",
      "avatar_url": "https://avatars1.githubusercontent.com/u/622145?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bmclean",
      "html_url": "https://github.com/bmclean",
      "followers_url": "https://api.github.com/users/bmclean/followers",
      "following_url": "https://api.github.com/users/bmclean/following{/other_user}",
      "gists_url": "https://api.github.com/users/bmclean/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bmclean/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bmclean/subscriptions",
      "organizations_url": "https://api.github.com/users/bmclean/orgs",
      "repos_url": "https://api.github.com/users/bmclean/repos",
      "events_url": "https://api.github.com/users/bmclean/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bmclean/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-17T23:16:04Z",
    "updated_at": "2016-05-17T23:16:26Z",
    "author_association": "NONE",
    "body": "The demo Rails app is configured to use Puma (which hangs). If you comment out the puma line from the Gemfile, run `bundle` and delete (or rename) the Procfile then starting the server with `rails s` will use WEBrick  (which seems to work).\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/219889094",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-219889094",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 219889094,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxOTg4OTA5NA==",
    "user": {
      "login": "obieq",
      "id": 357716,
      "node_id": "MDQ6VXNlcjM1NzcxNg==",
      "avatar_url": "https://avatars1.githubusercontent.com/u/357716?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/obieq",
      "html_url": "https://github.com/obieq",
      "followers_url": "https://api.github.com/users/obieq/followers",
      "following_url": "https://api.github.com/users/obieq/following{/other_user}",
      "gists_url": "https://api.github.com/users/obieq/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/obieq/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/obieq/subscriptions",
      "organizations_url": "https://api.github.com/users/obieq/orgs",
      "repos_url": "https://api.github.com/users/obieq/repos",
      "events_url": "https://api.github.com/users/obieq/events{/privacy}",
      "received_events_url": "https://api.github.com/users/obieq/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-17T23:59:38Z",
    "updated_at": "2016-05-18T00:00:18Z",
    "author_association": "NONE",
    "body": "Don't know if this helps or not... My project has this issue when running Heroku/Puma (after upgrading to google datastore v1beta3).  However, Heroku/Thin works.\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/220175064",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-220175064",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 220175064,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMDE3NTA2NA==",
    "user": {
      "login": "bmclean",
      "id": 622145,
      "node_id": "MDQ6VXNlcjYyMjE0NQ==",
      "avatar_url": "https://avatars1.githubusercontent.com/u/622145?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bmclean",
      "html_url": "https://github.com/bmclean",
      "followers_url": "https://api.github.com/users/bmclean/followers",
      "following_url": "https://api.github.com/users/bmclean/following{/other_user}",
      "gists_url": "https://api.github.com/users/bmclean/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bmclean/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bmclean/subscriptions",
      "organizations_url": "https://api.github.com/users/bmclean/orgs",
      "repos_url": "https://api.github.com/users/bmclean/repos",
      "events_url": "https://api.github.com/users/bmclean/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bmclean/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-18T22:17:53Z",
    "updated_at": "2016-05-18T22:18:53Z",
    "author_association": "NONE",
    "body": "As the problem seems to occur with web servers that fork multiple processes, I tried disabling Puma's clustered mode (which forks processes) by configuring `workers 0`. This did allow a localhost Rails app connected to an actual datastore to function properly. As I was creating the Gcloud.datastore dataset object in a Rails initializer, I moved it elsewhere which then allowed a localhost Rails app with multiple Puma processes (`workers 2`) connected to an actual datastore to function properly.\n\nHowever, this still did not work when deployed to Heroku and running in production mode. One difference between development and production environments is that eager loading is enabled at boot for production environments. I set `config.eager_load = false` in the config/environments/production.rb and deployed to Heroku which does work.\n\nAny idea why the Gcloud.datastore dataset object can't be instantiated in a Rails initializer when using multiple processes or with eager_load enabled?\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/220176489",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-220176489",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 220176489,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMDE3NjQ4OQ==",
    "user": {
      "login": "murgatroid99",
      "id": 961599,
      "node_id": "MDQ6VXNlcjk2MTU5OQ==",
      "avatar_url": "https://avatars3.githubusercontent.com/u/961599?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/murgatroid99",
      "html_url": "https://github.com/murgatroid99",
      "followers_url": "https://api.github.com/users/murgatroid99/followers",
      "following_url": "https://api.github.com/users/murgatroid99/following{/other_user}",
      "gists_url": "https://api.github.com/users/murgatroid99/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/murgatroid99/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/murgatroid99/subscriptions",
      "organizations_url": "https://api.github.com/users/murgatroid99/orgs",
      "repos_url": "https://api.github.com/users/murgatroid99/repos",
      "events_url": "https://api.github.com/users/murgatroid99/events{/privacy}",
      "received_events_url": "https://api.github.com/users/murgatroid99/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-18T22:25:04Z",
    "updated_at": "2016-05-18T22:25:04Z",
    "author_association": "MEMBER",
    "body": "OK, that makes sense, and I think we've actually run into this problem before (but I didn't recognize it). I'm not exactly sure why, but the way that the gRPC library initializes does not persist properly across forks. If you load it eagerly, you load it and then fork, so the subprocesses don't have correct initialization. But if you fork and then load it in each worker, everything initializes correctly.\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/220228074",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-220228074",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 220228074,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMDIyODA3NA==",
    "user": {
      "login": "blowmage",
      "id": 730,
      "node_id": "MDQ6VXNlcjczMA==",
      "avatar_url": "https://avatars0.githubusercontent.com/u/730?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/blowmage",
      "html_url": "https://github.com/blowmage",
      "followers_url": "https://api.github.com/users/blowmage/followers",
      "following_url": "https://api.github.com/users/blowmage/following{/other_user}",
      "gists_url": "https://api.github.com/users/blowmage/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/blowmage/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/blowmage/subscriptions",
      "organizations_url": "https://api.github.com/users/blowmage/orgs",
      "repos_url": "https://api.github.com/users/blowmage/repos",
      "events_url": "https://api.github.com/users/blowmage/events{/privacy}",
      "received_events_url": "https://api.github.com/users/blowmage/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-19T05:00:23Z",
    "updated_at": "2016-05-19T05:00:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "@bmclean Try setting the datastore object in `Thread.current` instead of an instance variable.\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/220228194",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-220228194",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 220228194,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMDIyODE5NA==",
    "user": {
      "login": "blowmage",
      "id": 730,
      "node_id": "MDQ6VXNlcjczMA==",
      "avatar_url": "https://avatars0.githubusercontent.com/u/730?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/blowmage",
      "html_url": "https://github.com/blowmage",
      "followers_url": "https://api.github.com/users/blowmage/followers",
      "following_url": "https://api.github.com/users/blowmage/following{/other_user}",
      "gists_url": "https://api.github.com/users/blowmage/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/blowmage/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/blowmage/subscriptions",
      "organizations_url": "https://api.github.com/users/blowmage/orgs",
      "repos_url": "https://api.github.com/users/blowmage/repos",
      "events_url": "https://api.github.com/users/blowmage/events{/privacy}",
      "received_events_url": "https://api.github.com/users/blowmage/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-19T05:01:40Z",
    "updated_at": "2016-05-19T05:01:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "``` ruby\nmodule CloudDatastore\n  if Rails.env.development?\n    # ENV['DATASTORE_EMULATOR_HOST'] = 'localhost:8180'\n  elsif Rails.env.test?\n    ENV['DATASTORE_EMULATOR_HOST'] = 'localhost:8181'\n  else\n    ENV['GCLOUD_KEYFILE_JSON'] = '{\"private_key\": \"' + ENV['SERVICE_ACCOUNT_PRIVATE_KEY'] + '\",\n      \"client_email\": \"' + ENV['SERVICE_ACCOUNT_CLIENT_EMAIL'] + '\"}'\n  end\n\n  def self.dataset\n    config = Rails.application.config.database_configuration[Rails.env]['dataset_id']\n    Thread.current[:dataset] ||= Gcloud.datastore('datastore-project-name-here')\n  end\n\n  def self.reset_dataset\n    Thread.current[:dataset] = nil\n  end\nend\n```\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/220361405",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-220361405",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 220361405,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMDM2MTQwNQ==",
    "user": {
      "login": "bmclean",
      "id": 622145,
      "node_id": "MDQ6VXNlcjYyMjE0NQ==",
      "avatar_url": "https://avatars1.githubusercontent.com/u/622145?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bmclean",
      "html_url": "https://github.com/bmclean",
      "followers_url": "https://api.github.com/users/bmclean/followers",
      "following_url": "https://api.github.com/users/bmclean/following{/other_user}",
      "gists_url": "https://api.github.com/users/bmclean/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bmclean/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bmclean/subscriptions",
      "organizations_url": "https://api.github.com/users/bmclean/orgs",
      "repos_url": "https://api.github.com/users/bmclean/repos",
      "events_url": "https://api.github.com/users/bmclean/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bmclean/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-19T15:30:29Z",
    "updated_at": "2016-05-19T15:30:29Z",
    "author_association": "NONE",
    "body": "@blowmage I tried `Thread.current` but it doesn't  help in this scenario.\n\nThe trick that does work is to make sure the gRPC library is initialized after the process forks. So for example, my CloudDatastore module is in a Rails initializer and the previous version looked like this:\n\n```\nrequire 'gcloud/datastore'\n\nmodule CloudDatastore\n  if Rails.env.development?\n    ENV['DATASTORE_EMULATOR_HOST'] = 'localhost:8180'\n  elsif Rails.env.test?\n    ENV['DATASTORE_EMULATOR_HOST'] = 'localhost:8181'\n  else\n    ENV['GCLOUD_KEYFILE_JSON'] = '{\"private_key\": \"' + ENV['SERVICE_ACCOUNT_PRIVATE_KEY'] + '\",\n      \"client_email\": \"' + ENV['SERVICE_ACCOUNT_CLIENT_EMAIL'] + '\"}'\n  end\n\n  def self.dataset\n    config = Rails.application.config.database_configuration[Rails.env]['dataset_id']\n    @dataset ||= Gcloud.datastore(config)\n  end\n\n  def self.reset_dataset\n    @dataset = nil\n  end\nend\n```\n\nI changed it so that `require 'gcloud/datastore'` is inside the dataset method like this:\n\n```\nmodule CloudDatastore\n  if Rails.env.development?\n    ENV['DATASTORE_EMULATOR_HOST'] = 'localhost:8180'\n  elsif Rails.env.test?\n    ENV['DATASTORE_EMULATOR_HOST'] = 'localhost:8181'\n  else\n    ENV['GCLOUD_KEYFILE_JSON'] = '{\"private_key\": \"' + ENV['SERVICE_ACCOUNT_PRIVATE_KEY'] + '\",\n      \"client_email\": \"' + ENV['SERVICE_ACCOUNT_CLIENT_EMAIL'] + '\"}'\n  end\n\n  def self.dataset\n    require 'gcloud/datastore'\n    config = Rails.application.config.database_configuration[Rails.env]['dataset_id']\n    @dataset ||= Gcloud.datastore(config)\n  end\n\n  def self.reset_dataset\n    @dataset = nil\n  end\nend\n```\n\nWith some puts debugging added to the GRPC::GenericService::Dsl rpc `name` variable Puma now starts like this:\n\n```\n[99383] Puma starting in cluster mode...\n[99383] * Version 3.4.0 (ruby 2.3.0-p0), codename: Owl Bowl Brawl\n[99383] * Min threads: 5, max threads: 5\n[99383] * Environment: production\n[99383] * Process workers: 2\n[99383] * Preloading application\n[99383] * Listening on tcp://localhost:3000\n[99383] Use Ctrl-C to stop\nPuma Worker 99407 booted at 2016-05-19 09:27:55 -0600\nPuma Worker 99408 booted at 2016-05-19 09:27:55 -0600\n*****************************\nLookup\n*****************************\nRunQuery\n*****************************\nBeginTransaction\n*****************************\nCommit\n*****************************\nRollback\n*****************************\nLookup\n*****************************\nAllocateIds\n*****************************\nRunQuery\n*****************************\nBeginTransaction\n*****************************\nCommit\n*****************************\nRollback\n*****************************\nAllocateIds\n```\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/220396255",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-220396255",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 220396255,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMDM5NjI1NQ==",
    "user": {
      "login": "blowmage",
      "id": 730,
      "node_id": "MDQ6VXNlcjczMA==",
      "avatar_url": "https://avatars0.githubusercontent.com/u/730?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/blowmage",
      "html_url": "https://github.com/blowmage",
      "followers_url": "https://api.github.com/users/blowmage/followers",
      "following_url": "https://api.github.com/users/blowmage/following{/other_user}",
      "gists_url": "https://api.github.com/users/blowmage/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/blowmage/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/blowmage/subscriptions",
      "organizations_url": "https://api.github.com/users/blowmage/orgs",
      "repos_url": "https://api.github.com/users/blowmage/repos",
      "events_url": "https://api.github.com/users/blowmage/events{/privacy}",
      "received_events_url": "https://api.github.com/users/blowmage/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-19T17:32:16Z",
    "updated_at": "2016-05-19T17:32:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "Okay, so the problem is loading GRPC before forking, not instantiating a GRPC object before forking?\n\nSounds like this is fixed in newer releases. Can't wait to move to it. (Currently blocked by grpc/grpc#6571)\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/220398214",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-220398214",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 220398214,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMDM5ODIxNA==",
    "user": {
      "login": "murgatroid99",
      "id": 961599,
      "node_id": "MDQ6VXNlcjk2MTU5OQ==",
      "avatar_url": "https://avatars3.githubusercontent.com/u/961599?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/murgatroid99",
      "html_url": "https://github.com/murgatroid99",
      "followers_url": "https://api.github.com/users/murgatroid99/followers",
      "following_url": "https://api.github.com/users/murgatroid99/following{/other_user}",
      "gists_url": "https://api.github.com/users/murgatroid99/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/murgatroid99/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/murgatroid99/subscriptions",
      "organizations_url": "https://api.github.com/users/murgatroid99/orgs",
      "repos_url": "https://api.github.com/users/murgatroid99/repos",
      "events_url": "https://api.github.com/users/murgatroid99/events{/privacy}",
      "received_events_url": "https://api.github.com/users/murgatroid99/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-19T17:39:30Z",
    "updated_at": "2016-05-19T17:39:30Z",
    "author_association": "MEMBER",
    "body": "That problem with loading grpc before forking is not fixed in the newer release, and I do not expect it to be fixed any time soon.\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/220398571",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-220398571",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 220398571,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMDM5ODU3MQ==",
    "user": {
      "login": "blowmage",
      "id": 730,
      "node_id": "MDQ6VXNlcjczMA==",
      "avatar_url": "https://avatars0.githubusercontent.com/u/730?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/blowmage",
      "html_url": "https://github.com/blowmage",
      "followers_url": "https://api.github.com/users/blowmage/followers",
      "following_url": "https://api.github.com/users/blowmage/following{/other_user}",
      "gists_url": "https://api.github.com/users/blowmage/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/blowmage/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/blowmage/subscriptions",
      "organizations_url": "https://api.github.com/users/blowmage/orgs",
      "repos_url": "https://api.github.com/users/blowmage/repos",
      "events_url": "https://api.github.com/users/blowmage/events{/privacy}",
      "received_events_url": "https://api.github.com/users/blowmage/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-19T17:40:43Z",
    "updated_at": "2016-05-19T17:40:43Z",
    "author_association": "CONTRIBUTOR",
    "body": "Gotcha. Thanks for the clarification!\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/220469908",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-220469908",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 220469908,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMDQ2OTkwOA==",
    "user": {
      "login": "bmclean",
      "id": 622145,
      "node_id": "MDQ6VXNlcjYyMjE0NQ==",
      "avatar_url": "https://avatars1.githubusercontent.com/u/622145?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bmclean",
      "html_url": "https://github.com/bmclean",
      "followers_url": "https://api.github.com/users/bmclean/followers",
      "following_url": "https://api.github.com/users/bmclean/following{/other_user}",
      "gists_url": "https://api.github.com/users/bmclean/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bmclean/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bmclean/subscriptions",
      "organizations_url": "https://api.github.com/users/bmclean/orgs",
      "repos_url": "https://api.github.com/users/bmclean/repos",
      "events_url": "https://api.github.com/users/bmclean/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bmclean/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-19T22:28:49Z",
    "updated_at": "2016-05-19T22:28:49Z",
    "author_association": "NONE",
    "body": "@murgatroid99 Do you want this issue left open? \n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/220480013",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-220480013",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 220480013,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMDQ4MDAxMw==",
    "user": {
      "login": "murgatroid99",
      "id": 961599,
      "node_id": "MDQ6VXNlcjk2MTU5OQ==",
      "avatar_url": "https://avatars3.githubusercontent.com/u/961599?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/murgatroid99",
      "html_url": "https://github.com/murgatroid99",
      "followers_url": "https://api.github.com/users/murgatroid99/followers",
      "following_url": "https://api.github.com/users/murgatroid99/following{/other_user}",
      "gists_url": "https://api.github.com/users/murgatroid99/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/murgatroid99/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/murgatroid99/subscriptions",
      "organizations_url": "https://api.github.com/users/murgatroid99/orgs",
      "repos_url": "https://api.github.com/users/murgatroid99/repos",
      "events_url": "https://api.github.com/users/murgatroid99/events{/privacy}",
      "received_events_url": "https://api.github.com/users/murgatroid99/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-19T23:31:27Z",
    "updated_at": "2016-05-19T23:31:27Z",
    "author_association": "MEMBER",
    "body": "I think it's worth leaving open, as long as that problem still exists.\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/281670798",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-281670798",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 281670798,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI4MTY3MDc5OA==",
    "user": {
      "login": "jrun",
      "id": 328,
      "node_id": "MDQ6VXNlcjMyOA==",
      "avatar_url": "https://avatars3.githubusercontent.com/u/328?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jrun",
      "html_url": "https://github.com/jrun",
      "followers_url": "https://api.github.com/users/jrun/followers",
      "following_url": "https://api.github.com/users/jrun/following{/other_user}",
      "gists_url": "https://api.github.com/users/jrun/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jrun/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jrun/subscriptions",
      "organizations_url": "https://api.github.com/users/jrun/orgs",
      "repos_url": "https://api.github.com/users/jrun/repos",
      "events_url": "https://api.github.com/users/jrun/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jrun/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-02-22T13:36:30Z",
    "updated_at": "2017-02-22T13:36:30Z",
    "author_association": "NONE",
    "body": "#8798\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/350877420",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-350877420",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 350877420,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1MDg3NzQyMA==",
    "user": {
      "login": "muxi",
      "id": 1054404,
      "node_id": "MDQ6VXNlcjEwNTQ0MDQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/1054404?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/muxi",
      "html_url": "https://github.com/muxi",
      "followers_url": "https://api.github.com/users/muxi/followers",
      "following_url": "https://api.github.com/users/muxi/following{/other_user}",
      "gists_url": "https://api.github.com/users/muxi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/muxi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/muxi/subscriptions",
      "organizations_url": "https://api.github.com/users/muxi/orgs",
      "repos_url": "https://api.github.com/users/muxi/repos",
      "events_url": "https://api.github.com/users/muxi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/muxi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-12-11T22:20:30Z",
    "updated_at": "2017-12-11T22:20:30Z",
    "author_association": "MEMBER",
    "body": "ping"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/389344401",
    "html_url": "https://github.com/grpc/grpc/issues/6577#issuecomment-389344401",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/6577",
    "id": 389344401,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4OTM0NDQwMQ==",
    "user": {
      "login": "apolcyn",
      "id": 9566254,
      "node_id": "MDQ6VXNlcjk1NjYyNTQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9566254?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apolcyn",
      "html_url": "https://github.com/apolcyn",
      "followers_url": "https://api.github.com/users/apolcyn/followers",
      "following_url": "https://api.github.com/users/apolcyn/following{/other_user}",
      "gists_url": "https://api.github.com/users/apolcyn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apolcyn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apolcyn/subscriptions",
      "organizations_url": "https://api.github.com/users/apolcyn/orgs",
      "repos_url": "https://api.github.com/users/apolcyn/repos",
      "events_url": "https://api.github.com/users/apolcyn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apolcyn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-15T23:17:22Z",
    "updated_at": "2018-05-15T23:17:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "closing as dupe of https://github.com/grpc/grpc/issues/7951"
  }
]
