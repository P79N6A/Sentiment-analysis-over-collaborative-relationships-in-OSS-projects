[
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/199931070",
    "html_url": "https://github.com/grpc/grpc/issues/5913#issuecomment-199931070",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/5913",
    "id": 199931070,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5OTkzMTA3MA==",
    "user": {
      "login": "therc",
      "id": 13481082,
      "node_id": "MDQ6VXNlcjEzNDgxMDgy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/13481082?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/therc",
      "html_url": "https://github.com/therc",
      "followers_url": "https://api.github.com/users/therc/followers",
      "following_url": "https://api.github.com/users/therc/following{/other_user}",
      "gists_url": "https://api.github.com/users/therc/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/therc/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/therc/subscriptions",
      "organizations_url": "https://api.github.com/users/therc/orgs",
      "repos_url": "https://api.github.com/users/therc/repos",
      "events_url": "https://api.github.com/users/therc/events{/privacy}",
      "received_events_url": "https://api.github.com/users/therc/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-03-22T17:44:34Z",
    "updated_at": "2016-03-22T17:44:34Z",
    "author_association": "NONE",
    "body": "Running under memcheck, among others there's this:\n\n```\n==22433== 9,875,632 (9,867,416 direct, 8,216 indirect) bytes in 1,201 blocks are definitely lost in loss record 1,107 of 1,107\n==22433==    at 0x4C2BBCF: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)\n==22433==    by 0x900B589: gpr_malloc (alloc.c:57)\n==22433==    by 0x900DE78: gpr_slice_malloc (slice.c:193)\n==22433==    by 0x8FEE613: tcp_continue_read (tcp_posix.c:189)\n==22433==    by 0x8FEE613: tcp_handle_read (tcp_posix.c:259)\n==22433==    by 0x8FE91E6: grpc_exec_ctx_flush (exec_ctx.c:51)\n==22433==    by 0x8FEBCC7: grpc_pollset_work (pollset_posix.c:328)\n==22433==    by 0x8FF77C9: grpc_completion_queue_next (completion_queue.c:326)\n==22433==    by 0x8FC56EC: __pyx_pf_4grpc_7_cython_6cygrpc_15CompletionQueue_2poll (cygrpc.c:9154)\n==22433==    by 0x8FC56EC: __pyx_pw_4grpc_7_cython_6cygrpc_15CompletionQueue_3poll (cygrpc.c:8848)\n==22433==    by 0x4BA149: PyEval_EvalFrameEx (in /home/rudi/virtualenv/v1/bin/python)\n==22433==    by 0x4B7985: PyEval_EvalCodeEx (in /home/rudi/virtualenv/v1/bin/python)\n==22433==    by 0x4BF4E8: PyEval_EvalFrameEx (in /home/rudi/virtualenv/v1/bin/python)\n==22433==    by 0x4B7985: PyEval_EvalCodeEx (in /home/rudi/virtualenv/v1/bin/python)\n```\n\nThe last frames in the stack trace are not very helpful, but it seems to be something that calls CompletionQueue.poll(). Although the allocation was done by C code, it looks like it's the Python side that is leaking.\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/199934867",
    "html_url": "https://github.com/grpc/grpc/issues/5913#issuecomment-199934867",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/5913",
    "id": 199934867,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE5OTkzNDg2Nw==",
    "user": {
      "login": "therc",
      "id": 13481082,
      "node_id": "MDQ6VXNlcjEzNDgxMDgy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/13481082?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/therc",
      "html_url": "https://github.com/therc",
      "followers_url": "https://api.github.com/users/therc/followers",
      "following_url": "https://api.github.com/users/therc/following{/other_user}",
      "gists_url": "https://api.github.com/users/therc/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/therc/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/therc/subscriptions",
      "organizations_url": "https://api.github.com/users/therc/orgs",
      "repos_url": "https://api.github.com/users/therc/repos",
      "events_url": "https://api.github.com/users/therc/events{/privacy}",
      "received_events_url": "https://api.github.com/users/therc/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-03-22T17:49:45Z",
    "updated_at": "2016-03-22T17:49:45Z",
    "author_association": "NONE",
    "body": "Looking around, maybe it's somewhere near https://github.com/grpc/grpc/blob/master/src/python/grpcio/grpc/beta/_connectivity_channel.py#L92\n\nA comment there by  @nathanielmanistaatgoogle points to #3064.\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/200907927",
    "html_url": "https://github.com/grpc/grpc/issues/5913#issuecomment-200907927",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/5913",
    "id": 200907927,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIwMDkwNzkyNw==",
    "user": {
      "login": "zeiler",
      "id": 2138258,
      "node_id": "MDQ6VXNlcjIxMzgyNTg=",
      "avatar_url": "https://avatars3.githubusercontent.com/u/2138258?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zeiler",
      "html_url": "https://github.com/zeiler",
      "followers_url": "https://api.github.com/users/zeiler/followers",
      "following_url": "https://api.github.com/users/zeiler/following{/other_user}",
      "gists_url": "https://api.github.com/users/zeiler/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zeiler/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zeiler/subscriptions",
      "organizations_url": "https://api.github.com/users/zeiler/orgs",
      "repos_url": "https://api.github.com/users/zeiler/repos",
      "events_url": "https://api.github.com/users/zeiler/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zeiler/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-03-24T16:19:33Z",
    "updated_at": "2016-03-24T16:19:33Z",
    "author_association": "NONE",
    "body": "Hey @nathanielmanistaatgoogle thanks for taking this on. Any luck reproducing? Any more info you need from this end? \n\nWe have reproduced it by multiple users now and both linux and OSX. We're using python 2.7 as well if that helps (both 2.7.6 and 2.7.10 have the issue). Let me know what else could be helpful!\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/207814796",
    "html_url": "https://github.com/grpc/grpc/issues/5913#issuecomment-207814796",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/5913",
    "id": 207814796,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIwNzgxNDc5Ng==",
    "user": {
      "login": "zeiler",
      "id": 2138258,
      "node_id": "MDQ6VXNlcjIxMzgyNTg=",
      "avatar_url": "https://avatars3.githubusercontent.com/u/2138258?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zeiler",
      "html_url": "https://github.com/zeiler",
      "followers_url": "https://api.github.com/users/zeiler/followers",
      "following_url": "https://api.github.com/users/zeiler/following{/other_user}",
      "gists_url": "https://api.github.com/users/zeiler/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zeiler/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zeiler/subscriptions",
      "organizations_url": "https://api.github.com/users/zeiler/orgs",
      "repos_url": "https://api.github.com/users/zeiler/repos",
      "events_url": "https://api.github.com/users/zeiler/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zeiler/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-04-09T16:21:03Z",
    "updated_at": "2016-04-09T16:21:03Z",
    "author_association": "NONE",
    "body": "Quick update. Tested out \n`pip install grpcio==0.13.1`\nwith the hope that some c-core memory leaks have been fixed. But didn't help the issue unfortunately. You can see in this memory plot below from Datadog that those climbing spikes are services that are using grpc and leaking then get restarted which makes this very scary for production use.\n\n![image](https://cloud.githubusercontent.com/assets/2138258/14404809/3b2b4d78-fe4d-11e5-863f-0fe639ffdffb.png)\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/217115128",
    "html_url": "https://github.com/grpc/grpc/issues/5913#issuecomment-217115128",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/5913",
    "id": 217115128,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIxNzExNTEyOA==",
    "user": {
      "login": "sunwangme",
      "id": 1357031,
      "node_id": "MDQ6VXNlcjEzNTcwMzE=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/1357031?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sunwangme",
      "html_url": "https://github.com/sunwangme",
      "followers_url": "https://api.github.com/users/sunwangme/followers",
      "following_url": "https://api.github.com/users/sunwangme/following{/other_user}",
      "gists_url": "https://api.github.com/users/sunwangme/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sunwangme/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sunwangme/subscriptions",
      "organizations_url": "https://api.github.com/users/sunwangme/orgs",
      "repos_url": "https://api.github.com/users/sunwangme/repos",
      "events_url": "https://api.github.com/users/sunwangme/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sunwangme/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-05T09:52:07Z",
    "updated_at": "2016-05-05T09:52:07Z",
    "author_association": "NONE",
    "body": "nobody want to fix it?\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/221259536",
    "html_url": "https://github.com/grpc/grpc/issues/5913#issuecomment-221259536",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/5913",
    "id": 221259536,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMTI1OTUzNg==",
    "user": {
      "login": "alamaison",
      "id": 596743,
      "node_id": "MDQ6VXNlcjU5Njc0Mw==",
      "avatar_url": "https://avatars3.githubusercontent.com/u/596743?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alamaison",
      "html_url": "https://github.com/alamaison",
      "followers_url": "https://api.github.com/users/alamaison/followers",
      "following_url": "https://api.github.com/users/alamaison/following{/other_user}",
      "gists_url": "https://api.github.com/users/alamaison/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alamaison/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alamaison/subscriptions",
      "organizations_url": "https://api.github.com/users/alamaison/orgs",
      "repos_url": "https://api.github.com/users/alamaison/repos",
      "events_url": "https://api.github.com/users/alamaison/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alamaison/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-24T12:54:46Z",
    "updated_at": "2016-05-24T12:54:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "I did some investigation using [this client](https://github.com/thought-machine/grpc/blob/handy_benchmark/examples/python/benchmark/greeter_client_mem.py) and [this server](https://github.com/thought-machine/grpc/blob/handy_benchmark/examples/python/benchmark/greeter_server.py).  The leak in the server is related to the size of the request (i.e. reading) and does is not affected by the size of the response (i.e. not writing).\n\nIn the following, the x axis is the number of identical requests made from the client to the server, and the y axis is the server's memory usage in MB.  (The differences between the psutil and resource results are garbage collection.  psutil notices garbage collection earlier than the resource module)\n\nWhen the response size is small but the request size is large, the memory leak is clearly visible:\n![large_request](https://cloud.githubusercontent.com/assets/596743/15504137/66a39a88-21b5-11e6-861d-9ad72628e55c.png)\n\nWhen that is reversed so that the responses are large but the requests are small, the memory leak doesn't occur.\n![large_response](https://cloud.githubusercontent.com/assets/596743/15504142/6b434c32-21b5-11e6-83c9-41ec93c4a2fc.png)\n\nValgrind gives me the same stack trace that @zeiler posted above.  I've scoured the source but I can't find anywhere that fails to free memory nor any obvious circular references.  However, my understanding of the source is still sketchy.\n\nI would be very interested to hear any comments/advice from @nathanielmanistaatgoogle or other googlers.  Perhaps a brief explanation of how the lifecycle is _supposed_ to work?  I can see that the server maintains a CompletionQueue until it is shutdown so that isn't going to clean up memory after a request.  Are slices that are stored in the completion queue meant to be cleaned up by reference-counting once a request is finished?  Where does that happen?\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/221266038",
    "html_url": "https://github.com/grpc/grpc/issues/5913#issuecomment-221266038",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/5913",
    "id": 221266038,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMTI2NjAzOA==",
    "user": {
      "login": "nathanielmanistaatgoogle",
      "id": 10131044,
      "node_id": "MDQ6VXNlcjEwMTMxMDQ0",
      "avatar_url": "https://avatars0.githubusercontent.com/u/10131044?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nathanielmanistaatgoogle",
      "html_url": "https://github.com/nathanielmanistaatgoogle",
      "followers_url": "https://api.github.com/users/nathanielmanistaatgoogle/followers",
      "following_url": "https://api.github.com/users/nathanielmanistaatgoogle/following{/other_user}",
      "gists_url": "https://api.github.com/users/nathanielmanistaatgoogle/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nathanielmanistaatgoogle/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nathanielmanistaatgoogle/subscriptions",
      "organizations_url": "https://api.github.com/users/nathanielmanistaatgoogle/orgs",
      "repos_url": "https://api.github.com/users/nathanielmanistaatgoogle/repos",
      "events_url": "https://api.github.com/users/nathanielmanistaatgoogle/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nathanielmanistaatgoogle/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-24T13:20:38Z",
    "updated_at": "2016-05-24T13:20:38Z",
    "author_association": "MEMBER",
    "body": "@alamaison: thank you for the investigation!\n\n@soltanmm: please attempt to replicate this result at the Cython layer?\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/221350833",
    "html_url": "https://github.com/grpc/grpc/issues/5913#issuecomment-221350833",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/5913",
    "id": 221350833,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMTM1MDgzMw==",
    "user": {
      "login": "soltanmm",
      "id": 4889063,
      "node_id": "MDQ6VXNlcjQ4ODkwNjM=",
      "avatar_url": "https://avatars3.githubusercontent.com/u/4889063?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/soltanmm",
      "html_url": "https://github.com/soltanmm",
      "followers_url": "https://api.github.com/users/soltanmm/followers",
      "following_url": "https://api.github.com/users/soltanmm/following{/other_user}",
      "gists_url": "https://api.github.com/users/soltanmm/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/soltanmm/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/soltanmm/subscriptions",
      "organizations_url": "https://api.github.com/users/soltanmm/orgs",
      "repos_url": "https://api.github.com/users/soltanmm/repos",
      "events_url": "https://api.github.com/users/soltanmm/events{/privacy}",
      "received_events_url": "https://api.github.com/users/soltanmm/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-24T17:50:27Z",
    "updated_at": "2016-05-24T17:50:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "@therc I see the same thing, and am inclined to think that this isn't in the Python layers (or if it is, it's not straightforward and probably in Cython). The `malloc`'s result _should_ be managed by the C core and tied to a byte buffer. AFAIK, we always destroy our byte buffers in Python because it's guaranteed by our `ByteBuffer` wrapper's `__dealloc__`. So, for @alamaison's question, yes the memory allocations use reference counting, and we basically have a DAG of references where we occasionally add/remove roots in the form of completion queue tags as they escape-into/emerge-from the C core.\n\nThis suggests that either we're _using_ core wrong (so there's some nontrivial semantics that's not being handled properly), or that core has a bug.\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/221542232",
    "html_url": "https://github.com/grpc/grpc/issues/5913#issuecomment-221542232",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/5913",
    "id": 221542232,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMTU0MjIzMg==",
    "user": {
      "login": "alamaison",
      "id": 596743,
      "node_id": "MDQ6VXNlcjU5Njc0Mw==",
      "avatar_url": "https://avatars3.githubusercontent.com/u/596743?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alamaison",
      "html_url": "https://github.com/alamaison",
      "followers_url": "https://api.github.com/users/alamaison/followers",
      "following_url": "https://api.github.com/users/alamaison/following{/other_user}",
      "gists_url": "https://api.github.com/users/alamaison/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alamaison/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alamaison/subscriptions",
      "organizations_url": "https://api.github.com/users/alamaison/orgs",
      "repos_url": "https://api.github.com/users/alamaison/repos",
      "events_url": "https://api.github.com/users/alamaison/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alamaison/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-05-25T11:09:33Z",
    "updated_at": "2016-05-25T11:09:33Z",
    "author_association": "CONTRIBUTOR",
    "body": "I've made a PR (#6711) that fixes the leak, at least as far as our test script reproduces it. \n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/222882541",
    "html_url": "https://github.com/grpc/grpc/issues/5913#issuecomment-222882541",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/5913",
    "id": 222882541,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMjg4MjU0MQ==",
    "user": {
      "login": "zeiler",
      "id": 2138258,
      "node_id": "MDQ6VXNlcjIxMzgyNTg=",
      "avatar_url": "https://avatars3.githubusercontent.com/u/2138258?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zeiler",
      "html_url": "https://github.com/zeiler",
      "followers_url": "https://api.github.com/users/zeiler/followers",
      "following_url": "https://api.github.com/users/zeiler/following{/other_user}",
      "gists_url": "https://api.github.com/users/zeiler/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zeiler/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zeiler/subscriptions",
      "organizations_url": "https://api.github.com/users/zeiler/orgs",
      "repos_url": "https://api.github.com/users/zeiler/repos",
      "events_url": "https://api.github.com/users/zeiler/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zeiler/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-06-01T03:20:54Z",
    "updated_at": "2016-06-01T03:20:54Z",
    "author_association": "NONE",
    "body": "Great! Confirmed this fixes the issue. Hopefully this gets merged ASAP. \n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/222908291",
    "html_url": "https://github.com/grpc/grpc/issues/5913#issuecomment-222908291",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/5913",
    "id": 222908291,
    "node_id": "MDEyOklzc3VlQ29tbWVudDIyMjkwODI5MQ==",
    "user": {
      "login": "sunwangme",
      "id": 1357031,
      "node_id": "MDQ6VXNlcjEzNTcwMzE=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/1357031?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sunwangme",
      "html_url": "https://github.com/sunwangme",
      "followers_url": "https://api.github.com/users/sunwangme/followers",
      "following_url": "https://api.github.com/users/sunwangme/following{/other_user}",
      "gists_url": "https://api.github.com/users/sunwangme/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sunwangme/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sunwangme/subscriptions",
      "organizations_url": "https://api.github.com/users/sunwangme/orgs",
      "repos_url": "https://api.github.com/users/sunwangme/repos",
      "events_url": "https://api.github.com/users/sunwangme/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sunwangme/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-06-01T06:52:24Z",
    "updated_at": "2016-06-01T06:52:24Z",
    "author_association": "NONE",
    "body": "when to merge？ my god！2 months......\n"
  }
]
