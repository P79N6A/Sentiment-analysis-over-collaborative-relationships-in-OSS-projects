[
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/394348725",
    "html_url": "https://github.com/grpc/grpc/issues/15628#issuecomment-394348725",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/15628",
    "id": 394348725,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NDM0ODcyNQ==",
    "user": {
      "login": "jtattermusch",
      "id": 9939684,
      "node_id": "MDQ6VXNlcjk5Mzk2ODQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9939684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtattermusch",
      "html_url": "https://github.com/jtattermusch",
      "followers_url": "https://api.github.com/users/jtattermusch/followers",
      "following_url": "https://api.github.com/users/jtattermusch/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtattermusch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtattermusch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtattermusch/subscriptions",
      "organizations_url": "https://api.github.com/users/jtattermusch/orgs",
      "repos_url": "https://api.github.com/users/jtattermusch/repos",
      "events_url": "https://api.github.com/users/jtattermusch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtattermusch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-04T13:10:09Z",
    "updated_at": "2018-06-04T13:12:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "Also found this in the logs (in multiple independent runs), and it's probably the rootcause:\r\n\r\n```\r\n+ ruby src/ruby/qps/worker.rb --driver_port=10300\r\nE0604 05:59:06.714226484   26305 ev_epollex_linux.cc:1387]   pollset_set_add_pollset: {\"created\":\"@1528091946.714195777\",\"description\":\"OS Error\",\"errno\":24,\"file\":\"src/core/lib/iomgr/wakeup_fd_eventfd.cc\",\"file_line\":37,\"os_error\":\"Too many open files\",\"syscall\":\"eventfd\"}\r\nE0604 05:59:06.714402224   26306 ev_epollex_linux.cc:1387]   pollset_set_add_pollset: {\"created\":\"@1528091946.714386997\",\"description\":\"OS Error\",\"errno\":24,\"file\":\"src/core/lib/iomgr/wakeup_fd_eventfd.cc\",\"file_line\":37,\"os_error\":\"Too many open files\",\"syscall\":\"eventfd\"}\r\nE0604 05:59:06.714888714   25778 ev_epollex_linux.cc:1337]   assertion failed: i != pss->pollset_count\r\ntools/run_tests/performance/run_worker_ruby.sh: line 21: 25776 Aborted                 (core dumped) ruby src/ruby/qps/worker.rb \"$@\"\r\n\r\n2018-06-04 06:02:42,306 FAILED: qps_worker_ruby_1 [ret=134, pid=25677, time=216.9sec]\r\n```\r\n\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/398434089",
    "html_url": "https://github.com/grpc/grpc/issues/15628#issuecomment-398434089",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/15628",
    "id": 398434089,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5ODQzNDA4OQ==",
    "user": {
      "login": "jtattermusch",
      "id": 9939684,
      "node_id": "MDQ6VXNlcjk5Mzk2ODQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9939684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtattermusch",
      "html_url": "https://github.com/jtattermusch",
      "followers_url": "https://api.github.com/users/jtattermusch/followers",
      "following_url": "https://api.github.com/users/jtattermusch/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtattermusch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtattermusch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtattermusch/subscriptions",
      "organizations_url": "https://api.github.com/users/jtattermusch/orgs",
      "repos_url": "https://api.github.com/users/jtattermusch/repos",
      "events_url": "https://api.github.com/users/jtattermusch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtattermusch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-19T15:08:29Z",
    "updated_at": "2018-06-19T15:08:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "@apolcyn  any ideas?"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/398645675",
    "html_url": "https://github.com/grpc/grpc/issues/15628#issuecomment-398645675",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/15628",
    "id": 398645675,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5ODY0NTY3NQ==",
    "user": {
      "login": "apolcyn",
      "id": 9566254,
      "node_id": "MDQ6VXNlcjk1NjYyNTQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9566254?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apolcyn",
      "html_url": "https://github.com/apolcyn",
      "followers_url": "https://api.github.com/users/apolcyn/followers",
      "following_url": "https://api.github.com/users/apolcyn/following{/other_user}",
      "gists_url": "https://api.github.com/users/apolcyn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apolcyn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apolcyn/subscriptions",
      "organizations_url": "https://api.github.com/users/apolcyn/orgs",
      "repos_url": "https://api.github.com/users/apolcyn/repos",
      "events_url": "https://api.github.com/users/apolcyn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apolcyn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-20T07:01:50Z",
    "updated_at": "2018-06-20T07:01:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "Haven't had time to take a good look into this yet, planning to look further in tomorrow. FWIW here was a socket leak (possibly related to the \"Too many open files\" in this bug) that was a fixed a while ago in this PR: https://github.com/grpc/grpc/pull/11764, but this bug seems different from that issue because it seems that the failing scenarios are streaming...."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/399000787",
    "html_url": "https://github.com/grpc/grpc/issues/15628#issuecomment-399000787",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/15628",
    "id": 399000787,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5OTAwMDc4Nw==",
    "user": {
      "login": "apolcyn",
      "id": 9566254,
      "node_id": "MDQ6VXNlcjk1NjYyNTQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9566254?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apolcyn",
      "html_url": "https://github.com/apolcyn",
      "followers_url": "https://api.github.com/users/apolcyn/followers",
      "following_url": "https://api.github.com/users/apolcyn/following{/other_user}",
      "gists_url": "https://api.github.com/users/apolcyn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apolcyn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apolcyn/subscriptions",
      "organizations_url": "https://api.github.com/users/apolcyn/orgs",
      "repos_url": "https://api.github.com/users/apolcyn/repos",
      "events_url": "https://api.github.com/users/apolcyn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apolcyn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-21T07:15:48Z",
    "updated_at": "2018-06-21T07:15:48Z",
    "author_association": "CONTRIBUTOR",
    "body": "FTR this is reproduces locally every time.\r\n\r\n```\r\ntools/run_tests/performance/run_worker_ruby.sh --driver_port=10310 &\r\ntools/run_tests/performance/run_worker_ruby.sh --driver_port=10310 &\r\n```\r\n\r\n```\r\nbins/opt/qps_json_driver '--scenarios_json={\"scenarios\": [{\"name\": \"ruby_protobuf_sync_streaming_qps_unconstrained\", \"warmup_seconds\": 5, \"benchmark_seconds\": 30, \"num_servers\": 1, \"server_config\": {\"async_server_threads\": 0, \"channel_args\": [{\"str_value\": \"throughput\", \"name\": \"grpc.optimization_target\"}], \"security_params\": {\"use_test_ca\": true, \"server_host_override\": \"foo.test.google.fr\"}, \"threads_per_cq\": 0, \"server_type\": \"SYNC_SERVER\"}, \"client_config\": {\"security_params\": {\"use_test_ca\": true, \"server_host_override\": \"foo.test.google.fr\"}, \"channel_args\": [{\"str_value\": \"throughput\", \"name\": \"grpc.optimization_target\"}], \"async_client_threads\": 0, \"outstanding_rpcs_per_channel\": 16, \"rpc_type\": \"STREAMING\", \"payload_config\": {\"simple_params\": {\"resp_size\": 0, \"req_size\": 0}}, \"client_channels\": 64, \"threads_per_cq\": 0, \"load_params\": {\"closed_loop\": {}}, \"client_type\": \"SYNC_CLIENT\", \"histogram_params\": {\"max_possible\": 60000000000.0, \"resolution\": 0.01}}, \"num_clients\": 0}]}'\r\n```\r\n\r\nit seems that this happens every time, during the time that the <i>client</i> is opening up all of its <i>streams</i> that the beginning of the test (there are 1024 in total to open). The number of total calls alone doesn't seem to be whats triggering all of the \r\n\r\n```\r\nE0621 07:11:11.207012779     472 ev_epollex_linux.cc:1461]   pollset_set_add_pollset: {\"created\":\"@1529565071.206996829\",\"description\":\"OS Error\",\"errno\":24,\"file\":\"src/core/lib/iomgr/ev_epollex_linux.cc\",\"file_line\":520,\"os_error\":\"Too many open files\",\"syscall\":\"epoll_create1\"}\r\n```\r\n\r\nerrors though...."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/399361082",
    "html_url": "https://github.com/grpc/grpc/issues/15628#issuecomment-399361082",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/15628",
    "id": 399361082,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5OTM2MTA4Mg==",
    "user": {
      "login": "apolcyn",
      "id": 9566254,
      "node_id": "MDQ6VXNlcjk1NjYyNTQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9566254?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/apolcyn",
      "html_url": "https://github.com/apolcyn",
      "followers_url": "https://api.github.com/users/apolcyn/followers",
      "following_url": "https://api.github.com/users/apolcyn/following{/other_user}",
      "gists_url": "https://api.github.com/users/apolcyn/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/apolcyn/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/apolcyn/subscriptions",
      "organizations_url": "https://api.github.com/users/apolcyn/orgs",
      "repos_url": "https://api.github.com/users/apolcyn/repos",
      "events_url": "https://api.github.com/users/apolcyn/events{/privacy}",
      "received_events_url": "https://api.github.com/users/apolcyn/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-22T08:14:51Z",
    "updated_at": "2018-06-22T08:15:13Z",
    "author_association": "CONTRIBUTOR",
    "body": "an easier way to reproduce this is with client in `src/ruby/end2end` of:\r\n\r\n```\r\nrequire_relative './end2end_common'\r\nt = []\r\np ARGV[0]\r\nstub = Echo::EchoServer::Stub.new(\"localhost:#{ARGV[0]}\",\r\n                                  :this_channel_is_insecure)\r\n<variable number of concurrent calls>.times do |i|\r\n  t << Thread.new do\r\n    r = stub.echo_stream([Echo::EchoRequest.new(request: 'client/child started')])\r\n    r.each { |r| r }\r\n  end\r\nend\r\nt.each(&:join)\r\n```\r\n\r\nrunning against server of \r\n\r\n```\r\nrequire_relative './end2end_common'\r\n\r\np ServerRunner.new(EchoServerImpl, 'rpc_server_args': {'pool_size': 8192}).run\r\nsleep\r\n```\r\n\r\nwhere `<variable number of concurrent calls>` is something just greater than `ulimit -n`\r\n\r\ne.g., with a `ulimit -n` of 1024, I'm seeing ~1K calls can be made, and then that \"too many open files\" error starts happening once we go over that.\r\n\r\nThe ruby wrapper associates 1 new completion queue for <i>every</i> call, translating to 1 epollfd for every call [under epollex](https://github.com/grpc/grpc/blob/master/src/core/lib/iomgr/ev_epollex_linux.cc#L518) poller. That benchmark creates 1024 concurrent streaming calls, and it does so on 64 different channels, which means that there is certainly more than 1024 open fd's at once, and on my debian 9 GCP VM ,`ulimit -n` defaulted to 1024. It's not yet clear to me that there is a grpc bug here. @jtattermusch do you know if anything has changed recently on benchmark workers?"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/402181032",
    "html_url": "https://github.com/grpc/grpc/issues/15628#issuecomment-402181032",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/15628",
    "id": 402181032,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwMjE4MTAzMg==",
    "user": {
      "login": "jtattermusch",
      "id": 9939684,
      "node_id": "MDQ6VXNlcjk5Mzk2ODQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9939684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtattermusch",
      "html_url": "https://github.com/jtattermusch",
      "followers_url": "https://api.github.com/users/jtattermusch/followers",
      "following_url": "https://api.github.com/users/jtattermusch/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtattermusch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtattermusch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtattermusch/subscriptions",
      "organizations_url": "https://api.github.com/users/jtattermusch/orgs",
      "repos_url": "https://api.github.com/users/jtattermusch/repos",
      "events_url": "https://api.github.com/users/jtattermusch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtattermusch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-03T14:39:59Z",
    "updated_at": "2018-07-03T14:40:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "@apolcyn   quite a while ago we migrated the multi-machines benchmarks to kokoro which also involved recreating the bechmark workers (currently the \"driver\" machine is a kokoro-created VM, but the slaves running qps_workers are manually-provided VMs) - it might well be that the ruby benchmarks have been flaky for long time.\r\n\r\nI ssh'd to the new workers and they have the default `ulimit -n`  of  1024.\r\nWe do set the ulimit here:  https://github.com/grpc/grpc/blob/74a53c2440823e7b53741edba883ff1f4fb8f23a/tools/internal_ci/helper_scripts/prepare_build_linux_perf_multilang_rc#L19,  but as far as I can tell, that's only applied for the driver VM - not for the worker VMs that actually run the qps_worker binaries.\r\n\r\nBtw, I though that for languages with only sync API we use deliberately use fewer concurrent calls in scenario_config.py to not run into the \"too many open files\" problem.\r\n\r\nCC @matt-kwong \r\n\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/404627128",
    "html_url": "https://github.com/grpc/grpc/issues/15628#issuecomment-404627128",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/15628",
    "id": 404627128,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwNDYyNzEyOA==",
    "user": {
      "login": "sreecha",
      "id": 2754995,
      "node_id": "MDQ6VXNlcjI3NTQ5OTU=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/2754995?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sreecha",
      "html_url": "https://github.com/sreecha",
      "followers_url": "https://api.github.com/users/sreecha/followers",
      "following_url": "https://api.github.com/users/sreecha/following{/other_user}",
      "gists_url": "https://api.github.com/users/sreecha/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sreecha/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sreecha/subscriptions",
      "organizations_url": "https://api.github.com/users/sreecha/orgs",
      "repos_url": "https://api.github.com/users/sreecha/repos",
      "events_url": "https://api.github.com/users/sreecha/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sreecha/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-12T19:39:01Z",
    "updated_at": "2018-07-12T19:39:47Z",
    "author_association": "CONTRIBUTOR",
    "body": "This is due to bug: https://github.com/grpc/grpc/issues/15759  - The fix is not straightforward :(\r\n(I have some idea on how to fix it but it is a non trivial change)"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/438183496",
    "html_url": "https://github.com/grpc/grpc/issues/15628#issuecomment-438183496",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/15628",
    "id": 438183496,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzODE4MzQ5Ng==",
    "user": {
      "login": "jtattermusch",
      "id": 9939684,
      "node_id": "MDQ6VXNlcjk5Mzk2ODQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9939684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtattermusch",
      "html_url": "https://github.com/jtattermusch",
      "followers_url": "https://api.github.com/users/jtattermusch/followers",
      "following_url": "https://api.github.com/users/jtattermusch/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtattermusch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtattermusch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtattermusch/subscriptions",
      "organizations_url": "https://api.github.com/users/jtattermusch/orgs",
      "repos_url": "https://api.github.com/users/jtattermusch/repos",
      "events_url": "https://api.github.com/users/jtattermusch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtattermusch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-11-13T08:45:18Z",
    "updated_at": "2018-11-13T08:47:13Z",
    "author_association": "CONTRIBUTOR",
    "body": "This is still a problem. Overview of ruby scenario failures over the last 7 days  (~30 runs of the entire suite).\r\n```\r\nruby_protobuf_sync_streaming_qps_unconstrained    25 failures\r\nruby_to_cpp_protobuf_sync_streaming_ping_pong     19 failures\r\nruby_protobuf_sync_unary_qps_unconstrained        17 failures\r\nruby_protobuf_unary_ping_pong_1MB                 13 failures\r\nruby_to_cpp_protobuf_sync_unary_ping_pong          8 failures         \r\n```"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/438305054",
    "html_url": "https://github.com/grpc/grpc/issues/15628#issuecomment-438305054",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/15628",
    "id": 438305054,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzODMwNTA1NA==",
    "user": {
      "login": "jtattermusch",
      "id": 9939684,
      "node_id": "MDQ6VXNlcjk5Mzk2ODQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9939684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtattermusch",
      "html_url": "https://github.com/jtattermusch",
      "followers_url": "https://api.github.com/users/jtattermusch/followers",
      "following_url": "https://api.github.com/users/jtattermusch/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtattermusch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtattermusch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtattermusch/subscriptions",
      "organizations_url": "https://api.github.com/users/jtattermusch/orgs",
      "repos_url": "https://api.github.com/users/jtattermusch/repos",
      "events_url": "https://api.github.com/users/jtattermusch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtattermusch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-11-13T15:23:30Z",
    "updated_at": "2018-11-13T15:23:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "Here's a spreadsheet with scenario flakiness overview:\r\nhttps://docs.google.com/spreadsheets/d/1aEtGyQetgsvkQimluJqK4ZpLmBV0te6tjwVfaJISOV4/edit?usp=sharing (I also filed https://github.com/grpc/grpc/issues/17201 for C++)"
  }
]
