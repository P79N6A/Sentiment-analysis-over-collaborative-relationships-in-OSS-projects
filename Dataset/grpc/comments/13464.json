[
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/347611925",
    "html_url": "https://github.com/grpc/grpc/issues/13464#issuecomment-347611925",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13464",
    "id": 347611925,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NzYxMTkyNQ==",
    "user": {
      "login": "dvaldivia",
      "id": 18384552,
      "node_id": "MDQ6VXNlcjE4Mzg0NTUy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/18384552?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dvaldivia",
      "html_url": "https://github.com/dvaldivia",
      "followers_url": "https://api.github.com/users/dvaldivia/followers",
      "following_url": "https://api.github.com/users/dvaldivia/following{/other_user}",
      "gists_url": "https://api.github.com/users/dvaldivia/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dvaldivia/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dvaldivia/subscriptions",
      "organizations_url": "https://api.github.com/users/dvaldivia/orgs",
      "repos_url": "https://api.github.com/users/dvaldivia/repos",
      "events_url": "https://api.github.com/users/dvaldivia/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dvaldivia/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-28T18:07:35Z",
    "updated_at": "2017-11-28T18:07:35Z",
    "author_association": "NONE",
    "body": "This problem can be avoided if I have each thread create it's own stub\r\n\r\nWhen all the threads hang, `lsof` shows multiple connections stablished, and they stay there until dropped by the grpc server\r\n\r\n```\r\npython2.7 39760 dvaldivia    3u     IPv6 0x828efb87a2868805         0t0        TCP *:50051 (LISTEN)\r\npython2.7 39760 dvaldivia    8u     IPv6 0x828efb87a4fe9945         0t0        TCP localhost:50051->localhost:55054 (ESTABLISHED)\r\npython2.7 39760 dvaldivia    9u     IPv6 0x828efb877cec3605         0t0        TCP localhost:50051->localhost:55079 (ESTABLISHED)\r\npython2.7 39760 dvaldivia   10u     IPv6 0x828efb8786b3c385         0t0        TCP localhost:50051->localhost:55087 (ESTABLISHED)\r\npython2.7 42701 dvaldivia    7u     IPv6 0x828efb87a4feb045         0t0        TCP localhost:55054->localhost:50051 (ESTABLISHED)\r\npython2.7 42707 dvaldivia    7u     IPv6 0x828efb87a4feb045         0t0        TCP localhost:55054->localhost:50051 (ESTABLISHED)\r\npython2.7 42708 dvaldivia    7u     IPv6 0x828efb87a4feb045         0t0        TCP localhost:55054->localhost:50051 (ESTABLISHED)\r\npython2.7 42709 dvaldivia    7u     IPv6 0x828efb87a4feb045         0t0        TCP localhost:55054->localhost:50051 (ESTABLISHED)\r\npython2.7 42710 dvaldivia    7u     IPv6 0x828efb87a4feb045         0t0        TCP localhost:55054->localhost:50051 (ESTABLISHED)\r\npython2.7 42711 dvaldivia    7u     IPv6 0x828efb87a4feb045         0t0        TCP localhost:55054->localhost:50051 (ESTABLISHED)\r\npython2.7 42712 dvaldivia    7u     IPv6 0x828efb87a4feb045         0t0        TCP localhost:55054->localhost:50051 (ESTABLISHED)\r\npython2.7 42713 dvaldivia    7u     IPv6 0x828efb87a4feb045         0t0        TCP localhost:55054->localhost:50051 (ESTABLISHED)\r\npython2.7 42714 dvaldivia    7u     IPv6 0x828efb87a4feb045         0t0        TCP localhost:55054->localhost:50051 (ESTABLISHED)\r\npython2.7 42719 dvaldivia    7u     IPv6 0x828efb87751d2dc5         0t0        TCP localhost:55079->localhost:50051 (ESTABLISHED)\r\npython2.7 42722 dvaldivia   10u     IPv6 0x828efb8786b3bdc5         0t0        TCP localhost:55087->localhost:50051 (ESTABLISHED)\r\n```"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/347635863",
    "html_url": "https://github.com/grpc/grpc/issues/13464#issuecomment-347635863",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13464",
    "id": 347635863,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NzYzNTg2Mw==",
    "user": {
      "login": "dvaldivia",
      "id": 18384552,
      "node_id": "MDQ6VXNlcjE4Mzg0NTUy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/18384552?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dvaldivia",
      "html_url": "https://github.com/dvaldivia",
      "followers_url": "https://api.github.com/users/dvaldivia/followers",
      "following_url": "https://api.github.com/users/dvaldivia/following{/other_user}",
      "gists_url": "https://api.github.com/users/dvaldivia/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dvaldivia/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dvaldivia/subscriptions",
      "organizations_url": "https://api.github.com/users/dvaldivia/orgs",
      "repos_url": "https://api.github.com/users/dvaldivia/repos",
      "events_url": "https://api.github.com/users/dvaldivia/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dvaldivia/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-28T19:26:24Z",
    "updated_at": "2017-11-28T19:26:24Z",
    "author_association": "NONE",
    "body": "here's a gdb dump of the hanged process\r\n\r\n```\r\n#0 0x00007fef66e6b70d in poll () at ../sysdeps/unix/syscall-template.S:84\r\n#1  0x00007fef638bd6d2 in pollset_work (exec_ctx=0x7ffe82fe2750, pollset=0x7154588, worker_hdl=0x0, now=..., deadline=...)\r\n    at src/core/lib/iomgr/ev_poll_posix.c:979\r\n#2  0x00007fef638de16f in cq_next (cc=0x7154420, deadline=..., reserved=<optimized out>) at src/core/lib/surface/completion_queue.c:844\r\n#3  0x00007fef638dedfe in grpc_completion_queue_next (cc=<optimized out>, deadline=..., reserved=reserved@entry=0x0)\r\n    at src/core/lib/surface/completion_queue.c:873\r\n#4  0x00007fef63883441 in __pyx_pf_4grpc_7_cython_6cygrpc_15CompletionQueue_2poll (__pyx_v_deadline=<optimized out>, __pyx_v_self=0x7fef2ee58e90)\r\n    at src/python/grpcio/grpc/_cython/cygrpc.c:10553\r\n#5  __pyx_pw_4grpc_7_cython_6cygrpc_15CompletionQueue_3poll (__pyx_v_self=0x7fef2ee58e90, __pyx_args=<optimized out>, __pyx_kwds=<optimized out>)\r\n    at src/python/grpcio/grpc/_cython/cygrpc.c:10413\r\n#6  0x00000000004c468a in PyEval_EvalFrameEx ()\r\n#7  0x00000000004c9d8f in PyEval_EvalFrameEx ()\r\n#8  0x00000000004c2765 in PyEval_EvalCodeEx ()\r\n#9  0x00000000004de8b8 in ?? ()\r\n#10 0x00000000004b0cb3 in PyObject_Call ()\r\n```"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/347667187",
    "html_url": "https://github.com/grpc/grpc/issues/13464#issuecomment-347667187",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13464",
    "id": 347667187,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NzY2NzE4Nw==",
    "user": {
      "login": "dvaldivia",
      "id": 18384552,
      "node_id": "MDQ6VXNlcjE4Mzg0NTUy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/18384552?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dvaldivia",
      "html_url": "https://github.com/dvaldivia",
      "followers_url": "https://api.github.com/users/dvaldivia/followers",
      "following_url": "https://api.github.com/users/dvaldivia/following{/other_user}",
      "gists_url": "https://api.github.com/users/dvaldivia/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dvaldivia/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dvaldivia/subscriptions",
      "organizations_url": "https://api.github.com/users/dvaldivia/orgs",
      "repos_url": "https://api.github.com/users/dvaldivia/repos",
      "events_url": "https://api.github.com/users/dvaldivia/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dvaldivia/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-28T21:19:55Z",
    "updated_at": "2017-11-28T21:20:08Z",
    "author_association": "NONE",
    "body": "Avoiding the reuse of the grpc channels is a workaround, but this won't be as performant\r\n\r\n```\r\n        PING_CHANNEL2 = grpc.insecure_channel(\"{}:{}\".format(PING_HOSTNAME, PING_PORT))\r\n        PING_STUB2 = ping_pb2_grpc.PingServiceStub(PING_CHANNEL2)\r\n        \r\n        # Do call\r\n        response = PING_STUB2.Ping(ping_pb2.Request(message=\"PING\"), timeout=1.0)\r\n\r\n        del PING_CHANNEL2\r\n        del PING_STUB2\r\n```"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/347668984",
    "html_url": "https://github.com/grpc/grpc/issues/13464#issuecomment-347668984",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13464",
    "id": 347668984,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NzY2ODk4NA==",
    "user": {
      "login": "kpayson64",
      "id": 18316330,
      "node_id": "MDQ6VXNlcjE4MzE2MzMw",
      "avatar_url": "https://avatars2.githubusercontent.com/u/18316330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kpayson64",
      "html_url": "https://github.com/kpayson64",
      "followers_url": "https://api.github.com/users/kpayson64/followers",
      "following_url": "https://api.github.com/users/kpayson64/following{/other_user}",
      "gists_url": "https://api.github.com/users/kpayson64/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kpayson64/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kpayson64/subscriptions",
      "organizations_url": "https://api.github.com/users/kpayson64/orgs",
      "repos_url": "https://api.github.com/users/kpayson64/repos",
      "events_url": "https://api.github.com/users/kpayson64/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kpayson64/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-28T21:26:46Z",
    "updated_at": "2017-11-28T21:26:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "@dvaldivia \r\nIt seems like you are trying to create the channels before the fork() call, which is known to cause issues.\r\n\r\nDoes Celery expose some kind of worker initialization hook that is called after fork()?\r\nThat would probably be the best place for any channel initialization.\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/347688310",
    "html_url": "https://github.com/grpc/grpc/issues/13464#issuecomment-347688310",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13464",
    "id": 347688310,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0NzY4ODMxMA==",
    "user": {
      "login": "dvaldivia",
      "id": 18384552,
      "node_id": "MDQ6VXNlcjE4Mzg0NTUy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/18384552?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dvaldivia",
      "html_url": "https://github.com/dvaldivia",
      "followers_url": "https://api.github.com/users/dvaldivia/followers",
      "following_url": "https://api.github.com/users/dvaldivia/following{/other_user}",
      "gists_url": "https://api.github.com/users/dvaldivia/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dvaldivia/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dvaldivia/subscriptions",
      "organizations_url": "https://api.github.com/users/dvaldivia/orgs",
      "repos_url": "https://api.github.com/users/dvaldivia/repos",
      "events_url": "https://api.github.com/users/dvaldivia/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dvaldivia/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-28T22:39:56Z",
    "updated_at": "2017-11-28T22:39:56Z",
    "author_association": "NONE",
    "body": "@kpayson64 I tried your suggestion and that does work, creating the channel after the fork() keeps this issue from happening and also re-uses the same connection so we are back in business, should I close this issue or is there another issue to track this concurrency issue con `grpc-python` ?"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/349247206",
    "html_url": "https://github.com/grpc/grpc/issues/13464#issuecomment-349247206",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13464",
    "id": 349247206,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0OTI0NzIwNg==",
    "user": {
      "login": "dzbarsky",
      "id": 1565842,
      "node_id": "MDQ6VXNlcjE1NjU4NDI=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/1565842?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dzbarsky",
      "html_url": "https://github.com/dzbarsky",
      "followers_url": "https://api.github.com/users/dzbarsky/followers",
      "following_url": "https://api.github.com/users/dzbarsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/dzbarsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dzbarsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dzbarsky/subscriptions",
      "organizations_url": "https://api.github.com/users/dzbarsky/orgs",
      "repos_url": "https://api.github.com/users/dzbarsky/repos",
      "events_url": "https://api.github.com/users/dzbarsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dzbarsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-12-05T09:32:23Z",
    "updated_at": "2017-12-05T09:32:23Z",
    "author_association": "NONE",
    "body": "Fork kills background threads, that's probably why channel doesn't work right when forked."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/351556047",
    "html_url": "https://github.com/grpc/grpc/issues/13464#issuecomment-351556047",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/13464",
    "id": 351556047,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1MTU1NjA0Nw==",
    "user": {
      "login": "kpayson64",
      "id": 18316330,
      "node_id": "MDQ6VXNlcjE4MzE2MzMw",
      "avatar_url": "https://avatars2.githubusercontent.com/u/18316330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kpayson64",
      "html_url": "https://github.com/kpayson64",
      "followers_url": "https://api.github.com/users/kpayson64/followers",
      "following_url": "https://api.github.com/users/kpayson64/following{/other_user}",
      "gists_url": "https://api.github.com/users/kpayson64/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kpayson64/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kpayson64/subscriptions",
      "organizations_url": "https://api.github.com/users/kpayson64/orgs",
      "repos_url": "https://api.github.com/users/kpayson64/repos",
      "events_url": "https://api.github.com/users/kpayson64/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kpayson64/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-12-13T23:15:35Z",
    "updated_at": "2017-12-13T23:15:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "#13536  Is probably the best issue to track if you want to create channels before forking.  Its part of a more comprehensive fork support change."
  }
]
