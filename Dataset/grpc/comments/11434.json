[
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/307022577",
    "html_url": "https://github.com/grpc/grpc/issues/11434#issuecomment-307022577",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11434",
    "id": 307022577,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMwNzAyMjU3Nw==",
    "user": {
      "login": "jskeet",
      "id": 17011,
      "node_id": "MDQ6VXNlcjE3MDEx",
      "avatar_url": "https://avatars1.githubusercontent.com/u/17011?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jskeet",
      "html_url": "https://github.com/jskeet",
      "followers_url": "https://api.github.com/users/jskeet/followers",
      "following_url": "https://api.github.com/users/jskeet/following{/other_user}",
      "gists_url": "https://api.github.com/users/jskeet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jskeet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jskeet/subscriptions",
      "organizations_url": "https://api.github.com/users/jskeet/orgs",
      "repos_url": "https://api.github.com/users/jskeet/repos",
      "events_url": "https://api.github.com/users/jskeet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jskeet/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-06-08T07:28:01Z",
    "updated_at": "2017-06-08T07:28:01Z",
    "author_association": "CONTRIBUTOR",
    "body": "Okay, I've made a bit of progress understanding where this goes wrong...\r\n\r\nThe method name ends up in the native [`grpcsharp_channel_create_call`](https://github.com/grpc/grpc/blob/6b19d3b408903a9a91727d1dfd4cd1704433cfe7/src/csharp/ext/grpc_csharp_ext.c#L405) which has:\r\n\r\n```\r\ngrpc_slice method_slice = grpc_slice_from_copied_string(method);\r\n```\r\n\r\nThen `grpc_slice_from_copied_string` calls [`grpc_slice_from_copied_buffer`](https://github.com/grpc/grpc/blob/6b19d3b408903a9a91727d1dfd4cd1704433cfe7/src/core/lib/slice/slice.c#L206) which uses `GRPC_SLICE_MALLOC`.\r\n\r\nThat's [defined](https://github.com/grpc/grpc/blob/6b19d3b408903a9a91727d1dfd4cd1704433cfe7/include/grpc/slice.h#L83) as:\r\n\r\n```\r\n#define GRPC_SLICE_MALLOC(len)                                    \\\r\n  ((len) <= GRPC_SLICE_INLINED_SIZE                               \\\r\n       ? (grpc_slice){.refcount = NULL,                           \\\r\n                      .data.inlined = {.length = (uint8_t)(len)}} \\\r\n       : grpc_slice_malloc_large((len)))\r\n```\r\n\r\nNow `GRPC_SLICE_INLINED_SIZE` is [defined](https://github.com/grpc/grpc/blob/5d0b1aeadecf5cbfafa371da9494cd600615733a/include/grpc/impl/codegen/slice.h#L80) as:\r\n\r\n```\r\n#define GRPC_SLICE_INLINED_SIZE (sizeof(size_t) + sizeof(uint8_t *) - 1)\r\n```\r\n\r\nIf that's 15 in a 64-bit process (my C++ is very rusty) that would explain the difference between \"test.Serv.M\" (11 bytes) and \"test.Serv.Method\" (16 bytes).\r\n\r\nI'm not *sure* whether that means `grpc_slice_malloc_large` creates a memory leak, but it might..."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/307023703",
    "html_url": "https://github.com/grpc/grpc/issues/11434#issuecomment-307023703",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11434",
    "id": 307023703,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMwNzAyMzcwMw==",
    "user": {
      "login": "jskeet",
      "id": 17011,
      "node_id": "MDQ6VXNlcjE3MDEx",
      "avatar_url": "https://avatars1.githubusercontent.com/u/17011?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jskeet",
      "html_url": "https://github.com/jskeet",
      "followers_url": "https://api.github.com/users/jskeet/followers",
      "following_url": "https://api.github.com/users/jskeet/following{/other_user}",
      "gists_url": "https://api.github.com/users/jskeet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jskeet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jskeet/subscriptions",
      "organizations_url": "https://api.github.com/users/jskeet/orgs",
      "repos_url": "https://api.github.com/users/jskeet/repos",
      "events_url": "https://api.github.com/users/jskeet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jskeet/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-06-08T07:33:38Z",
    "updated_at": "2017-06-08T07:36:36Z",
    "author_association": "CONTRIBUTOR",
    "body": "Aha! I think I've got it. I believe `grpcsharp_channel_create_call` should be calling `grpc_slice_unref(method)` - and potentially the same for `host_slice`.\r\n\r\nIn other words, change this:\r\n\r\n```\r\nreturn grpc_channel_create_call(channel, parent_call, propagation_mask, cq,\r\n                                  method_slice, host_slice_ptr, deadline, NULL);\r\n```\r\n\r\nto\r\n\r\n```\r\ngrpc_call call = grpc_channel_create_call(channel, parent_call, propagation_mask, cq,\r\n    method_slice, host_slice_ptr, deadline, NULL);\r\n  grpc_slice_unref(method);\r\n  if (host_slice_ptr != NULL) {\r\n    grpc_slice_unref(host_slice);\r\n  }\r\nreturn call;\r\n```\r\n\r\nThat would mirror the [Python code](https://github.com/grpc/grpc/blob/46357c882df1afc28f7a5228c40fde522093fa32/src/python/grpcio/grpc/_cython/_cygrpc/channel.pyx.pxi#L74)."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/307143359",
    "html_url": "https://github.com/grpc/grpc/issues/11434#issuecomment-307143359",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11434",
    "id": 307143359,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMwNzE0MzM1OQ==",
    "user": {
      "login": "jtattermusch",
      "id": 9939684,
      "node_id": "MDQ6VXNlcjk5Mzk2ODQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9939684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtattermusch",
      "html_url": "https://github.com/jtattermusch",
      "followers_url": "https://api.github.com/users/jtattermusch/followers",
      "following_url": "https://api.github.com/users/jtattermusch/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtattermusch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtattermusch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtattermusch/subscriptions",
      "organizations_url": "https://api.github.com/users/jtattermusch/orgs",
      "repos_url": "https://api.github.com/users/jtattermusch/repos",
      "events_url": "https://api.github.com/users/jtattermusch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtattermusch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-06-08T15:43:31Z",
    "updated_at": "2017-06-08T15:43:31Z",
    "author_association": "CONTRIBUTOR",
    "body": "@jskeet I think you're right, thanks for a super detailed analysis.  Once you mentioned \"short method names\", the first thing I thought of was the difference between by-value and by-ref grpc_slices, but you solved it yourself before I could react.\r\nI'll quickly verify it and submit a patch (it's probably going to v1.4.x branch as we're very close to 1.4.0 release)."
  }
]
