[
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/390340275",
    "html_url": "https://github.com/grpc/grpc/issues/15441#issuecomment-390340275",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/15441",
    "id": 390340275,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5MDM0MDI3NQ==",
    "user": {
      "login": "ZhouyihaiDing",
      "id": 28968539,
      "node_id": "MDQ6VXNlcjI4OTY4NTM5",
      "avatar_url": "https://avatars3.githubusercontent.com/u/28968539?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ZhouyihaiDing",
      "html_url": "https://github.com/ZhouyihaiDing",
      "followers_url": "https://api.github.com/users/ZhouyihaiDing/followers",
      "following_url": "https://api.github.com/users/ZhouyihaiDing/following{/other_user}",
      "gists_url": "https://api.github.com/users/ZhouyihaiDing/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ZhouyihaiDing/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ZhouyihaiDing/subscriptions",
      "organizations_url": "https://api.github.com/users/ZhouyihaiDing/orgs",
      "repos_url": "https://api.github.com/users/ZhouyihaiDing/repos",
      "events_url": "https://api.github.com/users/ZhouyihaiDing/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ZhouyihaiDing/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-18T21:42:05Z",
    "updated_at": "2018-05-18T22:08:43Z",
    "author_association": "CONTRIBUTOR",
    "body": "- \r\n\r\nFirstly, it's mostly likely caused by the life cycle of the function variable `$updateMetadata` you defined inside the function `createCred`. This variable is destroyed when the function ends. \r\nWe [save the pointer(line 121)](https://github.com/grpc/grpc/blob/master/src/php/ext/grpc/call_credentials.c#L121:16) for this variable  function variable instead of copying the whole function. As this pointer becomes invalid, I expect a `segment fault` when the call wants to fetch and run it.\r\n\r\nCan you please try defining `$updateMetadata` out of the function and passing it into the closure?\r\n```\r\nfunction createCred($updateMetadata){\r\n    $cred = Grpc\\ChannelCredentials::createComposite(\r\n        Grpc\\ChannelCredentials::createSsl(file_get_contents('roots.pem')),\r\n        Grpc\\CallCredentials::createFromPlugin($updateMetadata));\r\n    return $cred;\r\n}\r\n$credentials_by_func = createCred($updateMetadata);\r\n$client = new \\Wener\\Service\\V1\\InfoServiceClient(\"myservice.com:443\", [\r\n    'credentials' => $credentials_by_func,\r\n]);\r\n```\r\n\r\n- \r\n\r\nThe other issue is probably caused by missing handler for the `zend_class_entry` object. I am not sure which handler is now. It may be [`clone`](https://github.com/php/php-src/blob/a7fe2570d3ce6915d4ea85c62c0f880ddc225ba7/Zend/zend.h#L133:24) or  [`create_object`](https://github.com/php/php-src/blob/a7fe2570d3ce6915d4ea85c62c0f880ddc225ba7/Zend/zend.h#L148:17). The cause is, when the closure function ends, the `Grpc\\ChannelCredentials` object is destroyed too, and it needs to be re-assigned to a new PHP variable. Thus, currently, it makes the code looks like:\r\n```\r\n$credentials_by_func = createCred($updateMetadata);\r\n$client = new \\Wener\\Service\\V1\\InfoServiceClient(\"myservice.com:443\", [\r\n    'credentials' => $credentials_by_func,\r\n]);\r\n```\r\nor\r\n```\r\n$client = new \\Wener\\Service\\V1\\InfoServiceClient(\"myservice.com:443\", [\r\n    'credentials' => $credentials_by_func = createCred($updateMetadata),\r\n]);\r\n```"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/390375415",
    "html_url": "https://github.com/grpc/grpc/issues/15441#issuecomment-390375415",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/15441",
    "id": 390375415,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5MDM3NTQxNQ==",
    "user": {
      "login": "wenerme",
      "id": 1777211,
      "node_id": "MDQ6VXNlcjE3NzcyMTE=",
      "avatar_url": "https://avatars2.githubusercontent.com/u/1777211?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wenerme",
      "html_url": "https://github.com/wenerme",
      "followers_url": "https://api.github.com/users/wenerme/followers",
      "following_url": "https://api.github.com/users/wenerme/following{/other_user}",
      "gists_url": "https://api.github.com/users/wenerme/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wenerme/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wenerme/subscriptions",
      "organizations_url": "https://api.github.com/users/wenerme/orgs",
      "repos_url": "https://api.github.com/users/wenerme/repos",
      "events_url": "https://api.github.com/users/wenerme/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wenerme/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-19T03:33:11Z",
    "updated_at": "2018-05-19T03:33:11Z",
    "author_association": "NONE",
    "body": "```php\r\n// This works\r\n$updateMetadata2 = function ($context) {\r\n    return [];\r\n};\r\nfunction createCred()\r\n{\r\n    global $updateMetadata2;\r\n\r\n    $cred = Grpc\\ChannelCredentials::createComposite(\r\n        Grpc\\ChannelCredentials::createSsl(file_get_contents('roots.pem')),\r\n        Grpc\\CallCredentials::createFromPlugin($updateMetadata2));\r\n    return $cred;\r\n}\r\n\r\n// This also works\r\n$holder = [];\r\nfunction createCred()\r\n{\r\n    global $holder;\r\n    $updateMetadata2 = function ($context) {\r\n        return [];\r\n    };\r\n    $holder[] = $updateMetadata2;\r\n    $cred = Grpc\\ChannelCredentials::createComposite(\r\n        Grpc\\ChannelCredentials::createSsl(file_get_contents('roots.pem')),\r\n        Grpc\\CallCredentials::createFromPlugin($updateMetadata2));\r\n    return $cred;\r\n}\r\n```\r\n\r\nI know how to write my helper function now, but the problem still exists.\r\n\r\n```php\r\nclass MoreGrpc\r\n{\r\n    static private $_rootPem;\r\n    static private $_holder = [];\r\n\r\n    static function getRootPem()\r\n    {\r\n        if (self::$_rootPem == null) {\r\n            $reflector = new ReflectionClass(\"Grpc\\AbstractCall\");\r\n            $grpcDir = dirname(dirname(dirname($reflector->getFileName())));\r\n            self::$_rootPem = file_get_contents(\"$grpcDir/etc/roots.pem\");\r\n        }\r\n\r\n        return self::$_rootPem;\r\n    }\r\n\r\n    static function createCredentialWithAccessIdAndSecret($accessId, $accessSecret)\r\n    {\r\n\r\n        $updateMetadata = function ($context) use ($accessId, $accessSecret) {\r\n            return ['x-access-id' => [$accessId], 'x-access-secret' => [$accessSecret]];\r\n        };\r\n        self::$_holder[] = $updateMetadata;\r\n\r\n        $cred = Grpc\\ChannelCredentials::createComposite(\r\n            Grpc\\ChannelCredentials::createSsl(self::getRootPem()),\r\n            Grpc\\CallCredentials::createFromPlugin($updateMetadata));\r\n\r\n        return $cred;\r\n    }\r\n}\r\n```\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/390441402",
    "html_url": "https://github.com/grpc/grpc/issues/15441#issuecomment-390441402",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/15441",
    "id": 390441402,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5MDQ0MTQwMg==",
    "user": {
      "login": "ZhouyihaiDing",
      "id": 28968539,
      "node_id": "MDQ6VXNlcjI4OTY4NTM5",
      "avatar_url": "https://avatars3.githubusercontent.com/u/28968539?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ZhouyihaiDing",
      "html_url": "https://github.com/ZhouyihaiDing",
      "followers_url": "https://api.github.com/users/ZhouyihaiDing/followers",
      "following_url": "https://api.github.com/users/ZhouyihaiDing/following{/other_user}",
      "gists_url": "https://api.github.com/users/ZhouyihaiDing/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ZhouyihaiDing/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ZhouyihaiDing/subscriptions",
      "organizations_url": "https://api.github.com/users/ZhouyihaiDing/orgs",
      "repos_url": "https://api.github.com/users/ZhouyihaiDing/repos",
      "events_url": "https://api.github.com/users/ZhouyihaiDing/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ZhouyihaiDing/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-19T23:58:40Z",
    "updated_at": "2018-05-20T00:03:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "By `the problem still exists`, do you mean the error `PHP Fatal error:  Uncaught Error: Cannot call overloaded function for non-object in /Workspace/vendor/grpc/grpc/src/lib/UnaryCall.php:44\r\nStack trace` still exists?\r\nHave you tried assign the result of creating new credentials into a variable and then pass it to the stub?\r\n```\r\n$creds = createCred(); \r\n$client = new \\Wener\\Service\\V1\\InfoServiceClient(\"myservice.com:443\", [\r\n    'credentials' => $creds,\r\n]);\r\n```\r\nIf it still fail, please let me know. Thanks! I haven't reproduce it for now. My guess is that `Grpc\\ChannelCredentials` created inside `createCred()` doesn't assign to `$creds` correctly. If you put that to global, I guess will works.\r\n\r\nI wrote [a simple test case](https://gist.github.com/ZhouyihaiDing/42c6e793cd7ced7515298d9dc95c6691) which runs well under the grpc root directory:\r\n\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/390537206",
    "html_url": "https://github.com/grpc/grpc/issues/15441#issuecomment-390537206",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/15441",
    "id": 390537206,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5MDUzNzIwNg==",
    "user": {
      "login": "wenerme",
      "id": 1777211,
      "node_id": "MDQ6VXNlcjE3NzcyMTE=",
      "avatar_url": "https://avatars2.githubusercontent.com/u/1777211?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/wenerme",
      "html_url": "https://github.com/wenerme",
      "followers_url": "https://api.github.com/users/wenerme/followers",
      "following_url": "https://api.github.com/users/wenerme/following{/other_user}",
      "gists_url": "https://api.github.com/users/wenerme/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/wenerme/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/wenerme/subscriptions",
      "organizations_url": "https://api.github.com/users/wenerme/orgs",
      "repos_url": "https://api.github.com/users/wenerme/repos",
      "events_url": "https://api.github.com/users/wenerme/events{/privacy}",
      "received_events_url": "https://api.github.com/users/wenerme/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-05-21T02:32:56Z",
    "updated_at": "2018-05-21T02:32:56Z",
    "author_association": "NONE",
    "body": "```php\r\n// Still not work\r\n// PHP Fatal error:  Uncaught Error: Cannot call overloaded function for non-object in /.../vendor/grpc/grpc/src/lib/UnaryCall.php:44\r\n\r\nfunction createCred2()\r\n{\r\n    $updateMetadata = function ($context) {\r\n        return [];\r\n    };\r\n    $cred = Grpc\\ChannelCredentials::createComposite(\r\n        Grpc\\ChannelCredentials::createSsl(file_get_contents('roots.pem')),\r\n        Grpc\\CallCredentials::createFromPlugin($updateMetadata));\r\n    return $cred;\r\n}\r\n$cred = createCred2();\r\n$client = new \\Yikaiye\\Service\\V1\\InfoServiceClient(\"sms.ykyapis.com:443\", [\r\n    'credentials' => $cred,\r\n]);\r\n```\r\n\r\nFor `the problem still exists` I mean even I can use the workaround(use an array to hold the closure), but the original version should not failed, that's the problem.If this is by design, then just add a note about this will be fine.\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/395258698",
    "html_url": "https://github.com/grpc/grpc/issues/15441#issuecomment-395258698",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/15441",
    "id": 395258698,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM5NTI1ODY5OA==",
    "user": {
      "login": "ZhouyihaiDing",
      "id": 28968539,
      "node_id": "MDQ6VXNlcjI4OTY4NTM5",
      "avatar_url": "https://avatars3.githubusercontent.com/u/28968539?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ZhouyihaiDing",
      "html_url": "https://github.com/ZhouyihaiDing",
      "followers_url": "https://api.github.com/users/ZhouyihaiDing/followers",
      "following_url": "https://api.github.com/users/ZhouyihaiDing/following{/other_user}",
      "gists_url": "https://api.github.com/users/ZhouyihaiDing/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ZhouyihaiDing/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ZhouyihaiDing/subscriptions",
      "organizations_url": "https://api.github.com/users/ZhouyihaiDing/orgs",
      "repos_url": "https://api.github.com/users/ZhouyihaiDing/repos",
      "events_url": "https://api.github.com/users/ZhouyihaiDing/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ZhouyihaiDing/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-07T00:52:56Z",
    "updated_at": "2018-06-07T01:06:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for helping us find this issue!\r\n\r\nI checked php-src, and it seems that zend doesn't provide an API for me to make a copy of `zend_fcall_info_cache` and `zend_fcall_info` easily, as well as expend the life cycle of the object to cross the script.\r\n\r\nI am working on adding the document for c extension recently. I will add notes and TODO for `createFromPlugin` method until we find a way to manage the `function` object."
  }
]
