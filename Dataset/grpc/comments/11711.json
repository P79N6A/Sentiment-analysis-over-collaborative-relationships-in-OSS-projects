[
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314216553",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314216553",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314216553,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDIxNjU1Mw==",
    "user": {
      "login": "bacheson",
      "id": 9341738,
      "node_id": "MDQ6VXNlcjkzNDE3Mzg=",
      "avatar_url": "https://avatars2.githubusercontent.com/u/9341738?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bacheson",
      "html_url": "https://github.com/bacheson",
      "followers_url": "https://api.github.com/users/bacheson/followers",
      "following_url": "https://api.github.com/users/bacheson/following{/other_user}",
      "gists_url": "https://api.github.com/users/bacheson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bacheson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bacheson/subscriptions",
      "organizations_url": "https://api.github.com/users/bacheson/orgs",
      "repos_url": "https://api.github.com/users/bacheson/repos",
      "events_url": "https://api.github.com/users/bacheson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bacheson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-10T19:54:23Z",
    "updated_at": "2017-07-10T19:54:23Z",
    "author_association": "NONE",
    "body": "same same...this killed a full day for me"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314217627",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314217627",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314217627,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDIxNzYyNw==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-10T19:58:23Z",
    "updated_at": "2017-07-10T19:58:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "Is this reproducible in earlier releases like 1.3.2?"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314218084",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314218084",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314218084,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDIxODA4NA==",
    "user": {
      "login": "chrisboulton",
      "id": 98472,
      "node_id": "MDQ6VXNlcjk4NDcy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/98472?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chrisboulton",
      "html_url": "https://github.com/chrisboulton",
      "followers_url": "https://api.github.com/users/chrisboulton/followers",
      "following_url": "https://api.github.com/users/chrisboulton/following{/other_user}",
      "gists_url": "https://api.github.com/users/chrisboulton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chrisboulton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chrisboulton/subscriptions",
      "organizations_url": "https://api.github.com/users/chrisboulton/orgs",
      "repos_url": "https://api.github.com/users/chrisboulton/repos",
      "events_url": "https://api.github.com/users/chrisboulton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chrisboulton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-10T20:00:05Z",
    "updated_at": "2017-07-10T20:00:05Z",
    "author_association": "NONE",
    "body": "> Is this reproducible in earlier releases like 1.3.2?\r\n\r\nWe've just built a 1.3.2 , so should be able to confirm shortly (I work with @splittingred)\r\n\r\n\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314222653",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314222653",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314222653,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDIyMjY1Mw==",
    "user": {
      "login": "bacheson",
      "id": 9341738,
      "node_id": "MDQ6VXNlcjkzNDE3Mzg=",
      "avatar_url": "https://avatars2.githubusercontent.com/u/9341738?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bacheson",
      "html_url": "https://github.com/bacheson",
      "followers_url": "https://api.github.com/users/bacheson/followers",
      "following_url": "https://api.github.com/users/bacheson/following{/other_user}",
      "gists_url": "https://api.github.com/users/bacheson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bacheson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bacheson/subscriptions",
      "organizations_url": "https://api.github.com/users/bacheson/orgs",
      "repos_url": "https://api.github.com/users/bacheson/repos",
      "events_url": "https://api.github.com/users/bacheson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bacheson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-10T20:13:50Z",
    "updated_at": "2017-07-10T20:13:50Z",
    "author_association": "NONE",
    "body": "can confirm the problem doesn't exist in 1.3.2"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314228050",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314228050",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314228050,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDIyODA1MA==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-10T20:33:57Z",
    "updated_at": "2017-07-10T20:33:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "@splittingred @chrisboulton Can you clarify a bit more about the error case? You mentioned the error happens during shutdown. I assume you have loaded the grpc extension via a `php.ini` for PHP/FPM? And during regular PHP script execution, is there no problem? The problem only happens when the FPM process shuts down? Is this only happening to your CI testing environment? I guess my question is: if this is production, will this happen during normal load when FPM is serving requests? Coz in production, I am assuming your FPM workers will, rarely, shutdown? Or my assumption is incorrect. Sorry for all these questions, I just want to clarify what we are dealing with here."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314232573",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314232573",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314232573,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDIzMjU3Mw==",
    "user": {
      "login": "chrisboulton",
      "id": 98472,
      "node_id": "MDQ6VXNlcjk4NDcy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/98472?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chrisboulton",
      "html_url": "https://github.com/chrisboulton",
      "followers_url": "https://api.github.com/users/chrisboulton/followers",
      "following_url": "https://api.github.com/users/chrisboulton/following{/other_user}",
      "gists_url": "https://api.github.com/users/chrisboulton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chrisboulton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chrisboulton/subscriptions",
      "organizations_url": "https://api.github.com/users/chrisboulton/orgs",
      "repos_url": "https://api.github.com/users/chrisboulton/repos",
      "events_url": "https://api.github.com/users/chrisboulton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chrisboulton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-10T20:46:32Z",
    "updated_at": "2017-07-10T20:47:23Z",
    "author_association": "NONE",
    "body": "Happy to clarify -\r\n\r\nIn this case the shutdown handler/phase we're talking about is one that PHP is executing either at the end of every request, or (based on our configuration) one that occurs every X requests or Y seconds where FPM is actually recycling the workers. It's not the parent process shutting down, and it's not us explicitly triggering a shutdown.\r\n\r\nWhat happens here is eventually all of the FPM children processes (the actual workers) end up getting stuck, and you can no longer accept new requests."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314238107",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314238107",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314238107,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDIzODEwNw==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-10T20:55:37Z",
    "updated_at": "2017-07-10T22:17:03Z",
    "author_association": "CONTRIBUTOR",
    "body": "> or (based on our configuration) one that occurs every X requests or Y seconds where FPM is actually recycling the workers\r\n\r\nCan you point me to a config snippet as to how to reproduce this with FPM? \r\n\r\nDid you also mention that this can be reproduced even if the PHP requests/scripts don't use any gRPC code at all? \r\n\r\n~~If this does not happen with version 1.3.2, then it may be related to #11005. We fixed a bunch of memory leaks and may have caused this.~~ #11005 was backported to 1.3.2 so that's unlikely the culprit."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314241744",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314241744",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314241744,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDI0MTc0NA==",
    "user": {
      "login": "splittingred",
      "id": 233334,
      "node_id": "MDQ6VXNlcjIzMzMzNA==",
      "avatar_url": "https://avatars3.githubusercontent.com/u/233334?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/splittingred",
      "html_url": "https://github.com/splittingred",
      "followers_url": "https://api.github.com/users/splittingred/followers",
      "following_url": "https://api.github.com/users/splittingred/following{/other_user}",
      "gists_url": "https://api.github.com/users/splittingred/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/splittingred/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/splittingred/subscriptions",
      "organizations_url": "https://api.github.com/users/splittingred/orgs",
      "repos_url": "https://api.github.com/users/splittingred/repos",
      "events_url": "https://api.github.com/users/splittingred/events{/privacy}",
      "received_events_url": "https://api.github.com/users/splittingred/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-10T21:03:46Z",
    "updated_at": "2017-07-10T21:03:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "> Did you also mention that this can be reproduced even if the PHP requests/scripts don't use any gRPC code at all?\r\n\r\nThat is correct; we do not have the gRPC or protobuf composer packages loaded - just the grpc extension itself."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314243265",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314243265",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314243265,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDI0MzI2NQ==",
    "user": {
      "login": "chrisboulton",
      "id": 98472,
      "node_id": "MDQ6VXNlcjk4NDcy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/98472?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chrisboulton",
      "html_url": "https://github.com/chrisboulton",
      "followers_url": "https://api.github.com/users/chrisboulton/followers",
      "following_url": "https://api.github.com/users/chrisboulton/following{/other_user}",
      "gists_url": "https://api.github.com/users/chrisboulton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chrisboulton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chrisboulton/subscriptions",
      "organizations_url": "https://api.github.com/users/chrisboulton/orgs",
      "repos_url": "https://api.github.com/users/chrisboulton/repos",
      "events_url": "https://api.github.com/users/chrisboulton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chrisboulton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-10T21:07:08Z",
    "updated_at": "2017-07-10T21:54:20Z",
    "author_association": "NONE",
    "body": "> Can you point me to a config snippet as to how to reproduce this with FPM?\r\n\r\nSure. You essentially want to setup an FPM pool, and then configure the `pm.max_requests` option.\r\n\r\nNote - I've not confirmed this is where the shutdown handler is kicking in for this case - it might just be after every request.\r\n\r\nThat said, I'd probably recommend setting up an FPM pool with one worker with a configuration and continually hitting it. Eventually it should stall.\r\n\r\n> Did you also mention that this can be reproduced even if the PHP requests/scripts don't use any gRPC code at all?\r\n\r\nYep - you can see from the trace above that there's basically a generic shutdown handler in PHP that's iterating over any extension/module loaded into PHP and calling its destructor (in your case, `zm_shutdown_grpc`)"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314294840",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314294840",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314294840,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDI5NDg0MA==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-11T01:17:54Z",
    "updated_at": "2017-07-11T01:17:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "Two more clarifications:\r\n\r\n1. So looks like triggering this shutdown procedure by FPM (every X requests or Y seconds) is normal? What's the advantage or that? Does this mean every PHP extension got completely wiped out and restarted in these child processes? (The reason I asked is that we are working on persisting the grpc channel across PHP requests to improve performance, i.e. for the life of the extension being loaded, we can re-use the underlying grpc channel. If extensions got reloaded frequently, then it kinda defeats the purpose). \r\n\r\n2. Is reverting to 1.3.2, or not loading the grpc extension (since you are not using any grpc code) a workaround for now?\r\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314299748",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314299748",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314299748,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDI5OTc0OA==",
    "user": {
      "login": "bacheson",
      "id": 9341738,
      "node_id": "MDQ6VXNlcjkzNDE3Mzg=",
      "avatar_url": "https://avatars2.githubusercontent.com/u/9341738?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bacheson",
      "html_url": "https://github.com/bacheson",
      "followers_url": "https://api.github.com/users/bacheson/followers",
      "following_url": "https://api.github.com/users/bacheson/following{/other_user}",
      "gists_url": "https://api.github.com/users/bacheson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bacheson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bacheson/subscriptions",
      "organizations_url": "https://api.github.com/users/bacheson/orgs",
      "repos_url": "https://api.github.com/users/bacheson/repos",
      "events_url": "https://api.github.com/users/bacheson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bacheson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-11T01:51:53Z",
    "updated_at": "2017-07-11T01:51:53Z",
    "author_association": "NONE",
    "body": "@stanley-cheung thank you for your responsiveness to this issue. It sounds like the gravity of the situation hasn't been adequately expressed.\r\n\r\nThis issue has bricked any system running FPM + gRPC. I can only speculate but i'm guessing this would touch millions of servers around the world. \r\n\r\nSo yes, downgrading to 1.3.2 is a workaround but it's very important you fix this issue. I'd imagine most people who have been hit by this simply don't know that your extension is the culprit. It was hard to identify as everything looks normal until all fpm workers lock-up. "
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314302981",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314302981",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314302981,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDMwMjk4MQ==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-11T02:14:01Z",
    "updated_at": "2017-07-11T02:14:01Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yes I do plan to fix this, especially if this is a regression from 1.3.2. I just haven't been able to reproduce this because I am somewhat unfamiliar with the FPM setup beyond the very basics."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314322288",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314322288",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314322288,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDMyMjI4OA==",
    "user": {
      "login": "chrisboulton",
      "id": 98472,
      "node_id": "MDQ6VXNlcjk4NDcy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/98472?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chrisboulton",
      "html_url": "https://github.com/chrisboulton",
      "followers_url": "https://api.github.com/users/chrisboulton/followers",
      "following_url": "https://api.github.com/users/chrisboulton/following{/other_user}",
      "gists_url": "https://api.github.com/users/chrisboulton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chrisboulton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chrisboulton/subscriptions",
      "organizations_url": "https://api.github.com/users/chrisboulton/orgs",
      "repos_url": "https://api.github.com/users/chrisboulton/repos",
      "events_url": "https://api.github.com/users/chrisboulton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chrisboulton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-11T04:51:07Z",
    "updated_at": "2017-07-12T20:54:54Z",
    "author_association": "NONE",
    "body": "OK, I'm pretty sure this is due to PHP-FPM cycling processes - I spun up a DigitalOcean VM and was able to reproduce with a small static FPM pool configured with 2 processes and max 50 requests each. Died after 100 requests.\r\n \r\n```\r\nab -c 1 -n 1000 http://xxxx/i.php\r\nThis is ApacheBench, Version 2.3 <$Revision: 1757674 $>\r\nCopyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/\r\nLicensed to The Apache Software Foundation, http://www.apache.org/\r\n\r\nBenchmarking xxx (be patient)\r\nCompleted 100 requests\r\napr_pollset_poll: The timeout specified has expired (70007)\r\n```\r\n\r\nAnd PHP workers are stuck spinning:\r\n\r\n```\r\nroot@debian-512mb-nyc3-01:~# gdb\r\n(gdb) attach 18320\r\nAttaching to process 18320\r\n...\r\n(gdb) bt\r\n#0  pthread_cond_wait@@GLIBC_2.3.2 () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\r\n#1  0x00007fadf27edac7 in gpr_cv_wait () from /usr/lib/php/20151012/grpc.so\r\n#2  0x00007fadf281b227 in stop_threads () from /usr/lib/php/20151012/grpc.so\r\n#3  0x00007fadf281b287 in grpc_timer_manager_shutdown () from /usr/lib/php/20151012/grpc.so\r\n#4  0x00007fadf280df81 in grpc_iomgr_shutdown () from /usr/lib/php/20151012/grpc.so\r\n#5  0x00007fadf27ef347 in grpc_shutdown () from /usr/lib/php/20151012/grpc.so\r\n#6  0x00007fadf27e6322 in zm_shutdown_grpc () from /usr/lib/php/20151012/grpc.so\r\n#7  0x000055a443dd3367 in module_destructor ()\r\n#8  0x000055a443dcb4fc in ?? ()\r\n#9  0x000055a443dde891 in zend_hash_graceful_reverse_destroy ()\r\n#10 0x000055a443dcc5f1 in zend_shutdown ()\r\n#11 0x000055a443d6b75b in php_module_shutdown ()\r\n#12 0x000055a443c4e7ec in main ()\r\n```\r\n\r\nTo reproduce, you want something like: (Debian Stretch, but any with PHP 7 should do)\r\n\r\n```\r\napt-get update\r\napt-get install php7.0-dev php7.0-fpm zlib1g-dev apache2 libapache2-mod-fcgid\r\na2enconf php7.0-fpm\r\na2enmod proxy_fcgi setenvif\r\na2disconf php7.0\r\npecl install grpc\r\necho 'extension=grpc.so' > /etc/php/7.0/mods-available/grpc.ini\r\necho '\r\n[www]\r\nuser = www-data\r\ngroup = www-data\r\nlisten = /run/php/php7.0-fpm.sock\r\nlisten.owner = www-data\r\nlisten.group = www-data\r\npm = static\r\npm.max_children = 2\r\npm.max_requests = 50\r\n' > /etc/php/7.0/fpm/pool.d/www.conf\r\necho '<?php phpinfo();' > /var/www/html/i.php\r\nphpenmod -s ALL grpc\r\nservice apache2 restart\r\nservice php7.0-fpm restart\r\n```"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314323316",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314323316",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314323316,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDMyMzMxNg==",
    "user": {
      "login": "chrisboulton",
      "id": 98472,
      "node_id": "MDQ6VXNlcjk4NDcy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/98472?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chrisboulton",
      "html_url": "https://github.com/chrisboulton",
      "followers_url": "https://api.github.com/users/chrisboulton/followers",
      "following_url": "https://api.github.com/users/chrisboulton/following{/other_user}",
      "gists_url": "https://api.github.com/users/chrisboulton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chrisboulton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chrisboulton/subscriptions",
      "organizations_url": "https://api.github.com/users/chrisboulton/orgs",
      "repos_url": "https://api.github.com/users/chrisboulton/repos",
      "events_url": "https://api.github.com/users/chrisboulton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chrisboulton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-11T04:59:23Z",
    "updated_at": "2017-07-11T04:59:23Z",
    "author_association": "NONE",
    "body": "@stanley-cheung: More generally -\r\n\r\n> So looks like triggering this shutdown procedure by FPM (every X requests or Y seconds) is normal? What's the advantage or that? Does this mean every PHP extension got completely wiped out and restarted in these child processes? (The reason I asked is that we are working on persisting the grpc channel across PHP requests to improve performance, i.e. for the life of the extension being loaded, we can re-use the underlying grpc channel. If extensions got reloaded frequently, then it kinda defeats the purpose).\r\n\r\nIt's pretty normal in large setups, just to help avoid memory leaks, bad GC, etc. In our production environment we cycle FPM workers every 10k requests.\r\n\r\nThere's still a benefit to the persistent connection work you're doing and I think in our environment we'd benefit greatly, but you should really make sure you understand the PHP process models and the options available for sharing/maintaining a pool of persistent connections. Persistent connections got a bad wrap in the PHP community a while ago, but it's mostly because people don't understand how they work/interact with the process model they've chosen to run PHP under (ie which SAPI) and how to configure them accordingly. Happy to offer assistance in this area if you need it. "
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314354875",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314354875",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314354875,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDM1NDg3NQ==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-11T07:07:29Z",
    "updated_at": "2017-07-11T07:07:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "@chrisboulton Thanks for the repro test script. I will definitely look into this asap. Super helpful!"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314880994",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314880994",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314880994,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDg4MDk5NA==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-12T20:04:10Z",
    "updated_at": "2017-07-12T20:27:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "@chrisboulton ~~Hi, I followed your steps above on a Debian Stretch instances with PHP 7.0.19. But apache is not executing the PHP code. Just giving me back the text of the `i.php` file. I guess I am missing a `.conf` somewhere under `/etc/apache2`?~~\r\n\r\n~~Nevermind, looks like I need to install `libapache2-mod-php`~~\r\n\r\nActually I am still stuck. I can't seem to have apache2 to connect properly to use FPM."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314882484",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314882484",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314882484,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDg4MjQ4NA==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-12T20:10:04Z",
    "updated_at": "2017-07-12T20:11:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314887016",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314887016",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314887016,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDg4NzAxNg==",
    "user": {
      "login": "chrisboulton",
      "id": 98472,
      "node_id": "MDQ6VXNlcjk4NDcy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/98472?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chrisboulton",
      "html_url": "https://github.com/chrisboulton",
      "followers_url": "https://api.github.com/users/chrisboulton/followers",
      "following_url": "https://api.github.com/users/chrisboulton/following{/other_user}",
      "gists_url": "https://api.github.com/users/chrisboulton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chrisboulton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chrisboulton/subscriptions",
      "organizations_url": "https://api.github.com/users/chrisboulton/orgs",
      "repos_url": "https://api.github.com/users/chrisboulton/repos",
      "events_url": "https://api.github.com/users/chrisboulton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chrisboulton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-12T20:27:56Z",
    "updated_at": "2017-07-12T20:27:56Z",
    "author_association": "NONE",
    "body": "You don't want libapache2-mod-php in this circumstance - we were seeing the problem with FPM, not the Apache module SAPI.\r\n\r\nIt's possible I've missed something in my steps above which was resulting in PHP not working - give me 10 minutes to setup a new VM and find out what I've missed."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314887774",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314887774",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314887774,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDg4Nzc3NA==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-12T20:31:08Z",
    "updated_at": "2017-07-12T20:31:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yea I just realized I shouldn't be using `libapache2-mod-php` - it routes the .php files to another handler not FPM.\r\n\r\nThanks for the help!"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314889271",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314889271",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314889271,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDg4OTI3MQ==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-12T20:37:16Z",
    "updated_at": "2017-07-12T20:37:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "I do have a `/etc/apache2/conf-enabled/php7.0-fpm.conf` that have this snippet\r\n```\r\n<IfModule !mod_php7.c>\r\n<IfModule proxy_fcgi_module>\r\n    # Enable http authorization headers                                                                       \r\n    <IfModule setenvif_module>\r\n    SetEnvIfNoCase ^Authorization$ \"(.+)\" HTTP_AUTHORIZATION=$1\r\n    </IfModule>\r\n\r\n    <FilesMatch \".+\\.ph(p[3457]?|t|tml)$\">\r\n        SetHandler \"proxy:unix:/run/php/php7.0-fpm.sock|fcgi://localhost\"\r\n    </FilesMatch>\r\n```\r\n\r\nSo it seems like it should work"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314891098",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314891098",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314891098,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDg5MTA5OA==",
    "user": {
      "login": "chrisboulton",
      "id": 98472,
      "node_id": "MDQ6VXNlcjk4NDcy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/98472?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chrisboulton",
      "html_url": "https://github.com/chrisboulton",
      "followers_url": "https://api.github.com/users/chrisboulton/followers",
      "following_url": "https://api.github.com/users/chrisboulton/following{/other_user}",
      "gists_url": "https://api.github.com/users/chrisboulton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chrisboulton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chrisboulton/subscriptions",
      "organizations_url": "https://api.github.com/users/chrisboulton/orgs",
      "repos_url": "https://api.github.com/users/chrisboulton/repos",
      "events_url": "https://api.github.com/users/chrisboulton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chrisboulton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-12T20:44:00Z",
    "updated_at": "2017-07-12T20:44:00Z",
    "author_association": "NONE",
    "body": "I'd have a look to see if the fcgi is enabled... `a2enmod proxy_fcgi`"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314891300",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314891300",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314891300,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDg5MTMwMA==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-12T20:44:41Z",
    "updated_at": "2017-07-12T20:44:41Z",
    "author_association": "CONTRIBUTOR",
    "body": "```\r\n~$ sudo a2enmod proxy-fcgi\r\nERROR: Module proxy-fcgi does not exist!\r\n```"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314891574",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314891574",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314891574,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDg5MTU3NA==",
    "user": {
      "login": "chrisboulton",
      "id": 98472,
      "node_id": "MDQ6VXNlcjk4NDcy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/98472?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chrisboulton",
      "html_url": "https://github.com/chrisboulton",
      "followers_url": "https://api.github.com/users/chrisboulton/followers",
      "following_url": "https://api.github.com/users/chrisboulton/following{/other_user}",
      "gists_url": "https://api.github.com/users/chrisboulton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chrisboulton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chrisboulton/subscriptions",
      "organizations_url": "https://api.github.com/users/chrisboulton/orgs",
      "repos_url": "https://api.github.com/users/chrisboulton/repos",
      "events_url": "https://api.github.com/users/chrisboulton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chrisboulton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-12T20:45:50Z",
    "updated_at": "2017-07-12T20:46:21Z",
    "author_association": "NONE",
    "body": "Ah - do `apt-get install libapache2-mod-fcgid` (Also you want an underscore when enabling the module)"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314892510",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314892510",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314892510,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDg5MjUxMA==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-12T20:49:17Z",
    "updated_at": "2017-07-12T20:49:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "Just tried that and didn't seem to work\r\n```\r\n~$sudo apt-get install libapache2-mod-fcgid\r\nReading package lists... Done\r\nBuilding dependency tree       \r\nReading state information... Done\r\nlibapache2-mod-fcgid is already the newest version (1:2.3.9-1+b1).\r\n0 upgraded, 0 newly installed, 0 to remove and 6 not upgraded.\r\nstanleycheung@stanleycheung-debian9:~$ sudo service apache2 restart\r\nstanleycheung@stanleycheung-debian9:~$ sudo service php7.0-fpm restart\r\nstanleycheung@stanleycheung-debian9:~$ curl localhost/i.php\r\n<?php\r\n\r\nif (extension_loaded('grpc')) {\r\n  print(\"grpc extension loaded\\n\");\r\n} else {\r\n  print(\"grpc extension not loaded\\n\");\r\n```"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314894135",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314894135",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314894135,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDg5NDEzNQ==",
    "user": {
      "login": "chrisboulton",
      "id": 98472,
      "node_id": "MDQ6VXNlcjk4NDcy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/98472?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chrisboulton",
      "html_url": "https://github.com/chrisboulton",
      "followers_url": "https://api.github.com/users/chrisboulton/followers",
      "following_url": "https://api.github.com/users/chrisboulton/following{/other_user}",
      "gists_url": "https://api.github.com/users/chrisboulton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chrisboulton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chrisboulton/subscriptions",
      "organizations_url": "https://api.github.com/users/chrisboulton/orgs",
      "repos_url": "https://api.github.com/users/chrisboulton/repos",
      "events_url": "https://api.github.com/users/chrisboulton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chrisboulton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-12T20:55:37Z",
    "updated_at": "2017-07-12T20:55:37Z",
    "author_association": "NONE",
    "body": "Can you run through the above instructions again? Sorry - when I wrote them up it was after the fact and late at night. I've just gone through and updated some things. I think you're mainly missing the `setenvif` module at the moment."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314895016",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-314895016",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 314895016,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDg5NTAxNg==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-12T20:58:47Z",
    "updated_at": "2017-07-12T20:59:42Z",
    "author_association": "CONTRIBUTOR",
    "body": "Great! `a2enmod proxy_fcgi setenvif` did it. Now I am able see this:\r\n```\r\n~$ curl localhost/i.php\r\ngrpc extension loaded\r\n```\r\n\r\nAnd reproduced this:\r\n```\r\n~$ ab -c 1 -n 1000 localhost/i.php\r\nThis is ApacheBench, Version 2.3 <$Revision: 1757674 $>\r\nCopyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/\r\nLicensed to The Apache Software Foundation, http://www.apache.org/\r\n\r\nBenchmarking localhost (be patient)\r\napr_pollset_poll: The timeout specified has expired (70007)\r\nTotal of 99 requests completed\r\n```"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/315140138",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-315140138",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 315140138,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTE0MDEzOA==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-13T17:02:21Z",
    "updated_at": "2017-07-13T17:02:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "Quick update: I reproduced this issue and narrowed it down to a particular new call introduced to the shutdown procedure recently. Working with the core team to understand the issue."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/315221672",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-315221672",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 315221672,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTIyMTY3Mg==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-13T22:42:56Z",
    "updated_at": "2017-07-13T22:50:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "Summary of findings:\r\n * I traced it down to the fact that the grpc extension is loaded at the php-fpm parent process. In the PHP MINIT function, we call `grpc_init`. At 1.4 or later, the gRPC C core library introduced a new thread to manage timer related stuff. That thread was not forked into the php-fpm child processes.\r\n * So when the child php-fpm process is shutdown (i.e. when the PHP MSHUTDOWN function is called to shutdown each extension), the `grpc_shutdown` function hangs because the underlying `grpc_timer_manager_shutdown` cannot find the timer manager thread, which was at the parent process.\r\n * Unfortunately, grpc has not officially supported fork. Previously things work at version 1.3.2 or before was because it so happened that, if fork happens after `grpc_init`, and before any grpc channel is created, it will work but just accidentally. With this new timer manager change in 1.4, it will not work if fork happens after grpc_init.\r\n * The short term workaround is to use version 1.3.2. If there's any critical bug fixes, we can backport it there.\r\n * There is ongoing work in grpc core to support forking properly, but that will be 1 to 2 releases out.\r\n * This is another *really* ugly workaround is to simply not call `grpc_shutdown` at the `PHP_MSHUTDOWN_FUNCTION`. It *may* be acceptable if the child process is going away anyway but I don't know the memory leak implication if we do that. Plus, the timer manager thread will still be at the parent so I don't know whether deadline, cancel related functionality will still work.\r\n * This is the same issue as #11506\r\n * Same issue for other languages in #7951\r\n\r\nQuestions for community:\r\n * Does anybody know if there's a way for the PHP extension to call a function *after* php-fpm forks the child process? If that's possible, I can make the change in our gRPC PHP extension to only call `grpc_init` at that hook, rather that at the `PHP_MINIT_FUNCTION`. I think `RINIT` is called per request which is too expensive. I tried `GINIT` but it doesn't seem to be called after forking.\r\n * Alternatively, in this particular setup with PHP-FPM, is there a way for us to not fork child processes *after* the extension is loaded? Is there a way to load an extension only after the child process is forked?"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/315222622",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-315222622",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 315222622,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTIyMjYyMg==",
    "user": {
      "login": "chrisboulton",
      "id": 98472,
      "node_id": "MDQ6VXNlcjk4NDcy",
      "avatar_url": "https://avatars3.githubusercontent.com/u/98472?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chrisboulton",
      "html_url": "https://github.com/chrisboulton",
      "followers_url": "https://api.github.com/users/chrisboulton/followers",
      "following_url": "https://api.github.com/users/chrisboulton/following{/other_user}",
      "gists_url": "https://api.github.com/users/chrisboulton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chrisboulton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chrisboulton/subscriptions",
      "organizations_url": "https://api.github.com/users/chrisboulton/orgs",
      "repos_url": "https://api.github.com/users/chrisboulton/repos",
      "events_url": "https://api.github.com/users/chrisboulton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chrisboulton/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-13T22:48:02Z",
    "updated_at": "2017-07-13T22:48:02Z",
    "author_association": "NONE",
    "body": "> Does anybody know if there's a way for the PHP extension to call a function after php-fpm forks the child process?\r\n\r\nMy immediate thought (without having dug through the FPM SAPI just yet), would be that you might need to implement this in `RINIT`, but implement some kind of short circuit if the library has already been initialized in the worker, to eliminate the expensive call.\r\n\r\nI'll see if I can find some time in the next few days to dig through the SAPI code to see if there are any other better hooks."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/315242212",
    "html_url": "https://github.com/grpc/grpc/issues/11711#issuecomment-315242212",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11711",
    "id": 315242212,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTI0MjIxMg==",
    "user": {
      "login": "stanley-cheung",
      "id": 11674202,
      "node_id": "MDQ6VXNlcjExNjc0MjAy",
      "avatar_url": "https://avatars2.githubusercontent.com/u/11674202?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/stanley-cheung",
      "html_url": "https://github.com/stanley-cheung",
      "followers_url": "https://api.github.com/users/stanley-cheung/followers",
      "following_url": "https://api.github.com/users/stanley-cheung/following{/other_user}",
      "gists_url": "https://api.github.com/users/stanley-cheung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/stanley-cheung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/stanley-cheung/subscriptions",
      "organizations_url": "https://api.github.com/users/stanley-cheung/orgs",
      "repos_url": "https://api.github.com/users/stanley-cheung/repos",
      "events_url": "https://api.github.com/users/stanley-cheung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/stanley-cheung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-14T01:09:41Z",
    "updated_at": "2017-07-14T01:09:41Z",
    "author_association": "CONTRIBUTOR",
    "body": "@chrisboulton I made a PR #11814. If by any chance you can build and test this manually that would be great. Thanks for all the help debugging this issue so far. "
  }
]
