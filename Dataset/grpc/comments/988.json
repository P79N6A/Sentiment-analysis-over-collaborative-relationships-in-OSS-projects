[
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/77945899",
    "html_url": "https://github.com/grpc/grpc/issues/988#issuecomment-77945899",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/988",
    "id": 77945899,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3OTQ1ODk5",
    "user": {
      "login": "ctiller",
      "id": 10120821,
      "node_id": "MDQ6VXNlcjEwMTIwODIx",
      "avatar_url": "https://avatars3.githubusercontent.com/u/10120821?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ctiller",
      "html_url": "https://github.com/ctiller",
      "followers_url": "https://api.github.com/users/ctiller/followers",
      "following_url": "https://api.github.com/users/ctiller/following{/other_user}",
      "gists_url": "https://api.github.com/users/ctiller/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ctiller/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ctiller/subscriptions",
      "organizations_url": "https://api.github.com/users/ctiller/orgs",
      "repos_url": "https://api.github.com/users/ctiller/repos",
      "events_url": "https://api.github.com/users/ctiller/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ctiller/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2015-03-09T21:23:37Z",
    "updated_at": "2015-03-09T21:23:37Z",
    "author_association": "MEMBER",
    "body": "Check the CQ pending events array, look for non zero entries - if there are\nsome, there is an unfinished event of the type corresponding to that array\nindex. Figure out if it's validly pending (indicating a bug in the caller)\nor invalidly pending (indicating a bug in the core).\n\nOn Tue, Mar 10, 2015, 05:36 Jan Tattermusch notifications@github.com\nwrote:\n\n> Context:\n> In C#, I have a test Grpc.Core.Tests.ClientServerTest.UnknownMethodHandler\n> that runs a client and a server. Clients calls a nonimplemented RPC and\n> server responds with \"Unimplemented\" status. So far so good.\n> \n> My tests passes, but when shutting down the thread pool (4 threads calling\n> next() on the same cq), one of the threads hangs in about 10% of the time.\n> I found out that all threads but one receive shutdown event as expected,\n> but for one of the threads grpc_completion_queue_next never returns.\n> \n> Here's my stack trace for the thread that hangs:\n> \n> (gdb) where\n> #0 0x00007f59598b2b13 in epoll_wait () at\n> ../sysdeps/unix/syscall-template.S:81\n> #1 https://github.com/grpc/grpc/pull/1 0x00007f59554b7cf6 in\n> multipoll_with_epoll_pollset_maybe_work (pollset=0x7f594400f760,\n> deadline=..., now=..., allow_synchronous_callback=1)\n> at src/core/iomgr/pollset_multipoller_with_epoll.c:112\n> #2 https://github.com/grpc/grpc/pull/2 0x00007f59554b8562 in\n> grpc_pollset_work (pollset=0x7f594400f760, deadline=...) at\n> src/core/iomgr/pollset_posix.c:176\n> #3 https://github.com/grpc/grpc/pull/3 0x00007f59554c84dd in\n> grpc_completion_queue_next (cc=0x7f594400f750, deadline=...) at\n> src/core/surface/completion_queue.c:312\n> #4 https://github.com/grpc/grpc/pull/4 0x00007f5955adb94c in\n> grpcsharp_completion_queue_next_with_callback (cq=0x7f594400f750) at\n> src/csharp/ext/grpc_csharp_ext.c:230\n> #5 https://github.com/grpc/grpc/pull/5 0x0000000041cd00a7 in ?? ()\n> #6 https://github.com/grpc/grpc/pull/6 0x00007f592c002540 in ?? ()\n> #7 https://github.com/grpc/grpc/pull/7 0x00007f59582644d0 in ?? ()\n> #8 https://github.com/grpc/grpc/pull/8 0x00007f594c0025c0 in ?? ()\n> #9 https://github.com/grpc/grpc/pull/9 0x00007f593fdfdc00 in ?? ()\n> #10 https://github.com/grpc/grpc/issues/10 0x00007f593fdfdaf0 in ?? ()\n> #11 https://github.com/grpc/grpc/pull/11 0x0000000000000000 in ?? ()\n> \n> (gdb) info threads\n> Id Target Id Frame\n> 12 Thread 0x7f5956b1f700 (LWP 15791) \"cli\" sem_wait () at\n> ../nptl/sysdeps/unix/sysv/linux/x86_64/sem_wait.S:85\n> 11 Thread 0x7f59564ff700 (LWP 15792) \"cli\" 0x00007f5959b8c6dd in accept ()\n> at ../sysdeps/unix/syscall-template.S:81\n> 10 Thread 0x7f59562fe700 (LWP 15793) \"cli\" pthread_cond_timedwait@@GLIBC_2.3.2\n> () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_timedwait.S:238\n> 9 Thread 0x7f59560fd700 (LWP 15794) \"cli\" pthread_cond_wait@@GLIBC_2.3.2\n> () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n> 8 Thread 0x7f5955efc700 (LWP 15795) \"cli\" pthread_cond_wait@@GLIBC_2.3.2\n> () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n> 7 Thread 0x7f595523b700 (LWP 15796) \"cli\" 0x00007f59598b2b13 in epoll_wait\n> () at ../sysdeps/unix/syscall-template.S:81\n> 6 Thread 0x7f5954a3a700 (LWP 15797) \"cli\" pthread_cond_wait@@GLIBC_2.3.2\n> () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n> - 5 Thread 0x7f593fdfe700 (LWP 15800) \"cli\" 0x00007f59598b2b13 in\n>   epoll_wait () at ../sysdeps/unix/syscall-template.S:81 4 Thread\n>   0x7f593f9fc700 (LWP 15802) \"cli\" 0x00007f5959b8cb9d in nanosleep () at\n>   ../sysdeps/unix/syscall-template.S:81 3 Thread 0x7f593f9bb700 (LWP 15803)\n>   \"cli\" pthread_cond_timedwait@@GLIBC_2.3.2 () at\n>   ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_timedwait.S:238 2\n>   Thread 0x7f593efb9700 (LWP 15805) \"cli\" sem_timedwait () at\n>   ../nptl/sysdeps/unix/sysv/linux/x86_64/sem_timedwait.S:101 1 Thread\n>   0x7f595a6ac7c0 (LWP 15790) \"cli\" pthread_cond_wait@@GLIBC_2.3.2 () at\n>   ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185\n> \n> —\n> Reply to this email directly or view it on GitHub\n> https://github.com/grpc/grpc/issues/988.\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/77976418",
    "html_url": "https://github.com/grpc/grpc/issues/988#issuecomment-77976418",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/988",
    "id": 77976418,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3OTc2NDE4",
    "user": {
      "login": "jtattermusch",
      "id": 9939684,
      "node_id": "MDQ6VXNlcjk5Mzk2ODQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9939684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtattermusch",
      "html_url": "https://github.com/jtattermusch",
      "followers_url": "https://api.github.com/users/jtattermusch/followers",
      "following_url": "https://api.github.com/users/jtattermusch/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtattermusch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtattermusch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtattermusch/subscriptions",
      "organizations_url": "https://api.github.com/users/jtattermusch/orgs",
      "repos_url": "https://api.github.com/users/jtattermusch/repos",
      "events_url": "https://api.github.com/users/jtattermusch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtattermusch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2015-03-10T00:54:52Z",
    "updated_at": "2015-03-10T00:54:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks for the advice! Unfortunately, there seem to be no events pending on that cq.\n\n(gdb) frame 3\n#3  0x00007f12239f04bb in grpc_completion_queue_next (cc=0x7f122801a1a0, deadline=...) at  src/core/surface/completion_queue.c:311\n311     if (cc->allow_polling && grpc_pollset_work(&cc->pollset, deadline)) {\n(gdb) print cc->pending_op_count\n$3 = {0, 0, 0, 0, 0, 0, 0, 0, 0}\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/78006489",
    "html_url": "https://github.com/grpc/grpc/issues/988#issuecomment-78006489",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/988",
    "id": 78006489,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc4MDA2NDg5",
    "user": {
      "login": "ctiller",
      "id": 10120821,
      "node_id": "MDQ6VXNlcjEwMTIwODIx",
      "avatar_url": "https://avatars3.githubusercontent.com/u/10120821?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ctiller",
      "html_url": "https://github.com/ctiller",
      "followers_url": "https://api.github.com/users/ctiller/followers",
      "following_url": "https://api.github.com/users/ctiller/following{/other_user}",
      "gists_url": "https://api.github.com/users/ctiller/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ctiller/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ctiller/subscriptions",
      "organizations_url": "https://api.github.com/users/ctiller/orgs",
      "repos_url": "https://api.github.com/users/ctiller/repos",
      "events_url": "https://api.github.com/users/ctiller/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ctiller/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2015-03-10T07:22:06Z",
    "updated_at": "2015-03-10T07:22:06Z",
    "author_association": "MEMBER",
    "body": "Interesting... can you print *cc in the same context? I can probably remote debug it enough to solve this for you from there.\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/78099711",
    "html_url": "https://github.com/grpc/grpc/issues/988#issuecomment-78099711",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/988",
    "id": 78099711,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc4MDk5NzEx",
    "user": {
      "login": "jtattermusch",
      "id": 9939684,
      "node_id": "MDQ6VXNlcjk5Mzk2ODQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9939684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtattermusch",
      "html_url": "https://github.com/jtattermusch",
      "followers_url": "https://api.github.com/users/jtattermusch/followers",
      "following_url": "https://api.github.com/users/jtattermusch/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtattermusch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtattermusch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtattermusch/subscriptions",
      "organizations_url": "https://api.github.com/users/jtattermusch/orgs",
      "repos_url": "https://api.github.com/users/jtattermusch/repos",
      "events_url": "https://api.github.com/users/jtattermusch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtattermusch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2015-03-10T17:07:03Z",
    "updated_at": "2015-03-10T17:07:03Z",
    "author_association": "CONTRIBUTOR",
    "body": "$4 = {allow_polling = 1, refs = {count = 0}, pollset = {vtable = 0x7f1223dbe200 <multipoll_with_epoll_pollset>, mu = {__data = {__lock = 0, __count = 0, \n        __owner = 0, __nusers = 0, __kind = 0, __spins = 0, __elision = 0, __list = {__prev = 0x0, __next = 0x0}}, __size = '\\000' <repeats 39 times>, \n      __align = 0}, cv = {__data = {__lock = 0, __futex = 4, __total_seq = 2, __wakeup_seq = 2, __woken_seq = 2, __mutex = 0x7f122801a1b8, __nwaiters = 0, \n        __broadcast_seq = 1}, \n      __size = \"\\000\\000\\000\\000\\004\\000\\000\\000\\002\\000\\000\\000\\000\\000\\000\\000\\002\\000\\000\\000\\000\\000\\000\\000\\002\\000\\000\\000\\000\\000\\000\\000\\270\\241\\001(\\022\\177\\000\\000\\000\\000\\000\\000\\001\\000\\000\", __align = 17179869184}, kick_state = {mu = {__data = {__lock = 0, __count = 0, __owner = 0, __nusers = 0, __kind = 0, \n          __spins = 0, __elision = 0, __list = {__prev = 0x0, __next = 0x0}}, __size = '\\000' <repeats 39 times>, __align = 0}, kicked = 0, fd_info = 0x0}, \n    counter = 1, in_flight_cbs = 0, shutting_down = 0, shutdown_done_cb = 0x0, shutdown_done_arg = 0x0, data = {fd = 671566384, ptr = 0x7f1228074a30}}, \n  shutdown = 1, shutdown_called = 1, queue = 0x0, buckets = {0x0 <repeats 31 times>}, pending_op_count = {0, 0, 0, 0, 0, 0, 0, 0, 0}}\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/78149038",
    "html_url": "https://github.com/grpc/grpc/issues/988#issuecomment-78149038",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/988",
    "id": 78149038,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc4MTQ5MDM4",
    "user": {
      "login": "ctiller",
      "id": 10120821,
      "node_id": "MDQ6VXNlcjEwMTIwODIx",
      "avatar_url": "https://avatars3.githubusercontent.com/u/10120821?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ctiller",
      "html_url": "https://github.com/ctiller",
      "followers_url": "https://api.github.com/users/ctiller/followers",
      "following_url": "https://api.github.com/users/ctiller/following{/other_user}",
      "gists_url": "https://api.github.com/users/ctiller/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ctiller/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ctiller/subscriptions",
      "organizations_url": "https://api.github.com/users/ctiller/orgs",
      "repos_url": "https://api.github.com/users/ctiller/repos",
      "events_url": "https://api.github.com/users/ctiller/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ctiller/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2015-03-10T21:10:33Z",
    "updated_at": "2015-03-10T21:10:33Z",
    "author_association": "MEMBER",
    "body": "grpc_completion_queue_shutdown needs a call to grpc_pollset_kick.\n\nOn Wed, Mar 11, 2015, 03:37 Jan Tattermusch notifications@github.com\nwrote:\n\n> $4 = {allow_polling = 1, refs = {count = 0}, pollset = {vtable =\n> 0x7f1223dbe200 , mu = {__data = {__lock = 0, __count = 0,\n> __owner = 0, __nusers = 0, __kind = 0, __spins = 0, __elision = 0, __list\n> = {__prev = 0x0, __next = 0x0}}, __size = '\\000' ,\n> __align = 0}, cv = {__data = {__lock = 0, __futex = 4, __total_seq = 2,\n> __wakeup_seq = 2, __woken_seq = 2, __mutex = 0x7f122801a1b8, __nwaiters =\n> 0,\n> __broadcast_seq = 1},\n> __size =\n> \"\\000\\000\\000\\000\\004\\000\\000\\000\\002\\000\\000\\000\\000\\000\\000\\000\\002\\000\\000\\000\\000\\000\\000\\000\\002\\000\\000\\000\\000\\000\\000\\000\\270\\241\\001(\\022\\177\\000\\000\\000\\000\\000\\000\\001\\000\\000\",\n> __align = 17179869184}, kick_state = {mu = {__data = {__lock = 0, __count =\n> 0, __owner = 0, __nusers = 0, __kind = 0,\n> __spins = 0, __elision = 0, __list = {__prev = 0x0, __next = 0x0}}, __size\n> = '\\000' , __align = 0}, kicked = 0, fd_info = 0x0},\n> counter = 1, in_flight_cbs = 0, shutting_down = 0, shutdown_done_cb = 0x0,\n> shutdown_done_arg = 0x0, data = {fd = 671566384, ptr = 0x7f1228074a30}},\n> shutdown = 1, shutdown_called = 1, queue = 0x0, buckets = {0x0 },\n> pending_op_count = {0, 0, 0, 0, 0, 0, 0, 0, 0}}\n> \n> —\n> Reply to this email directly or view it on GitHub\n> https://github.com/grpc/grpc/issues/988#issuecomment-78099711.\n"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/78167518",
    "html_url": "https://github.com/grpc/grpc/issues/988#issuecomment-78167518",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/988",
    "id": 78167518,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc4MTY3NTE4",
    "user": {
      "login": "jtattermusch",
      "id": 9939684,
      "node_id": "MDQ6VXNlcjk5Mzk2ODQ=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/9939684?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtattermusch",
      "html_url": "https://github.com/jtattermusch",
      "followers_url": "https://api.github.com/users/jtattermusch/followers",
      "following_url": "https://api.github.com/users/jtattermusch/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtattermusch/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtattermusch/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtattermusch/subscriptions",
      "organizations_url": "https://api.github.com/users/jtattermusch/orgs",
      "repos_url": "https://api.github.com/users/jtattermusch/repos",
      "events_url": "https://api.github.com/users/jtattermusch/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtattermusch/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2015-03-10T23:02:53Z",
    "updated_at": "2015-03-10T23:02:53Z",
    "author_association": "CONTRIBUTOR",
    "body": "I've tried to add kick to different locations and it's not helping ;-)\n\nvoid grpc_completion_queue_shutdown(grpc_completion_queue _cc) {\n  gpr_mu_lock(GRPC_POLLSET_MU(&cc->pollset));\n  cc->shutdown_called = 1;\n  grpc_pollset_kick(&cc->pollset);   /_ I added this one just to be sure */\n  gpr_mu_unlock(GRPC_POLLSET_MU(&cc->pollset));\n\n  if (gpr_unref(&cc->refs)) {\n    gpr_mu_lock(GRPC_POLLSET_MU(&cc->pollset));\n    GPR_ASSERT(!cc->shutdown);\n    cc->shutdown = 1;\n    gpr_cv_broadcast(GRPC_POLLSET_CV(&cc->pollset));\n    grpc_pollset_kick(&cc->pollset);   /\\* this is the kick that should wakeup the epoll_wait call */\n    gpr_mu_unlock(GRPC_POLLSET_MU(&cc->pollset));\n  }\n}\n"
  }
]
