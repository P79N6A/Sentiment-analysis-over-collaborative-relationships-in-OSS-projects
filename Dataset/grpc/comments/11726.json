[
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314038884",
    "html_url": "https://github.com/grpc/grpc/pull/11726#issuecomment-314038884",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11726",
    "id": 314038884,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDAzODg4NA==",
    "user": {
      "login": "grpc-kokoro",
      "id": 12722905,
      "node_id": "MDQ6VXNlcjEyNzIyOTA1",
      "avatar_url": "https://avatars3.githubusercontent.com/u/12722905?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/grpc-kokoro",
      "html_url": "https://github.com/grpc-kokoro",
      "followers_url": "https://api.github.com/users/grpc-kokoro/followers",
      "following_url": "https://api.github.com/users/grpc-kokoro/following{/other_user}",
      "gists_url": "https://api.github.com/users/grpc-kokoro/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/grpc-kokoro/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/grpc-kokoro/subscriptions",
      "organizations_url": "https://api.github.com/users/grpc-kokoro/orgs",
      "repos_url": "https://api.github.com/users/grpc-kokoro/repos",
      "events_url": "https://api.github.com/users/grpc-kokoro/events{/privacy}",
      "received_events_url": "https://api.github.com/users/grpc-kokoro/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-10T08:24:55Z",
    "updated_at": "2017-07-10T08:24:55Z",
    "author_association": "NONE",
    "body": "```\n[trickle] No significant performance differences\n```"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314043688",
    "html_url": "https://github.com/grpc/grpc/pull/11726#issuecomment-314043688",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11726",
    "id": 314043688,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDA0MzY4OA==",
    "user": {
      "login": "grpc-kokoro",
      "id": 12722905,
      "node_id": "MDQ6VXNlcjEyNzIyOTA1",
      "avatar_url": "https://avatars3.githubusercontent.com/u/12722905?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/grpc-kokoro",
      "html_url": "https://github.com/grpc-kokoro",
      "followers_url": "https://api.github.com/users/grpc-kokoro/followers",
      "following_url": "https://api.github.com/users/grpc-kokoro/following{/other_user}",
      "gists_url": "https://api.github.com/users/grpc-kokoro/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/grpc-kokoro/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/grpc-kokoro/subscriptions",
      "organizations_url": "https://api.github.com/users/grpc-kokoro/orgs",
      "repos_url": "https://api.github.com/users/grpc-kokoro/repos",
      "events_url": "https://api.github.com/users/grpc-kokoro/events{/privacy}",
      "received_events_url": "https://api.github.com/users/grpc-kokoro/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-10T08:44:57Z",
    "updated_at": "2017-07-10T08:44:57Z",
    "author_association": "NONE",
    "body": "```\n[microbenchmarks] No significant performance differences\n```"
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314119676",
    "html_url": "https://github.com/grpc/grpc/pull/11726#issuecomment-314119676",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11726",
    "id": 314119676,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDExOTY3Ng==",
    "user": {
      "login": "markdroth",
      "id": 18664614,
      "node_id": "MDQ6VXNlcjE4NjY0NjE0",
      "avatar_url": "https://avatars2.githubusercontent.com/u/18664614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/markdroth",
      "html_url": "https://github.com/markdroth",
      "followers_url": "https://api.github.com/users/markdroth/followers",
      "following_url": "https://api.github.com/users/markdroth/following{/other_user}",
      "gists_url": "https://api.github.com/users/markdroth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/markdroth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/markdroth/subscriptions",
      "organizations_url": "https://api.github.com/users/markdroth/orgs",
      "repos_url": "https://api.github.com/users/markdroth/repos",
      "events_url": "https://api.github.com/users/markdroth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/markdroth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-10T14:18:35Z",
    "updated_at": "2017-07-10T14:18:35Z",
    "author_association": "MEMBER",
    "body": "I don't understand this change.  Why does acquiring the lock earlier make any difference?  I thought that the lock was only used for the condition variable."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314140244",
    "html_url": "https://github.com/grpc/grpc/pull/11726#issuecomment-314140244",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11726",
    "id": 314140244,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDE0MDI0NA==",
    "user": {
      "login": "dgquintas",
      "id": 120217,
      "node_id": "MDQ6VXNlcjEyMDIxNw==",
      "avatar_url": "https://avatars3.githubusercontent.com/u/120217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dgquintas",
      "html_url": "https://github.com/dgquintas",
      "followers_url": "https://api.github.com/users/dgquintas/followers",
      "following_url": "https://api.github.com/users/dgquintas/following{/other_user}",
      "gists_url": "https://api.github.com/users/dgquintas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dgquintas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dgquintas/subscriptions",
      "organizations_url": "https://api.github.com/users/dgquintas/orgs",
      "repos_url": "https://api.github.com/users/dgquintas/repos",
      "events_url": "https://api.github.com/users/dgquintas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dgquintas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-10T15:23:37Z",
    "updated_at": "2017-07-10T15:23:57Z",
    "author_association": "NONE",
    "body": "Looking at the previous version, `notify_one()` can happen before `wait()`. Consider the previous (current HEAD) version:\r\n\r\n```\r\nServerThread(...) {\r\n...\r\n    std::mutex mu;\r\n    std::condition_variable cond;\r\n    thread_.reset(new std::thread(\r\n        std::bind(&ServerThread::Start, this, server_host, &mu, &cond)));\r\n```\r\nAt this point, `Start()` runs on the just-spawn thread. In there, it's able to acquire the lock without any problem and call `notify_one()`, which is \"lost\": nothing was `wait()ing` on it.\r\n\r\nUsually, the startup of the thread is slow enough that the rest of `ServerThread`'s constructor can continue to acquire the lock and `wait()`. But of course there's no guarantee of this happening. In fact it doesn't under load. \r\n\r\nThe new version makes sure `Start()` can't make progress to `notify_one()` until the corresponding `wait()` in `ServerThread`'s constructor is invoked.\r\n\r\nThis is also the reason to use a lock on the `notify_one()` side. It's not strictly necessary and it's generally considered a \"pessimization\". From [the docs](http://en.cppreference.com/w/cpp/thread/condition_variable/notify_one):\r\n\r\n> The notifying thread does not need to hold the lock on the same mutex as the one held by the waiting thread(s); in fact doing so is a pessimization, since the notified thread would immediately block again, waiting for the notifying thread to release the lock."
  },
  {
    "url": "https://api.github.com/repos/grpc/grpc/issues/comments/314471899",
    "html_url": "https://github.com/grpc/grpc/pull/11726#issuecomment-314471899",
    "issue_url": "https://api.github.com/repos/grpc/grpc/issues/11726",
    "id": 314471899,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNDQ3MTg5OQ==",
    "user": {
      "login": "markdroth",
      "id": 18664614,
      "node_id": "MDQ6VXNlcjE4NjY0NjE0",
      "avatar_url": "https://avatars2.githubusercontent.com/u/18664614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/markdroth",
      "html_url": "https://github.com/markdroth",
      "followers_url": "https://api.github.com/users/markdroth/followers",
      "following_url": "https://api.github.com/users/markdroth/following{/other_user}",
      "gists_url": "https://api.github.com/users/markdroth/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/markdroth/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/markdroth/subscriptions",
      "organizations_url": "https://api.github.com/users/markdroth/orgs",
      "repos_url": "https://api.github.com/users/markdroth/repos",
      "events_url": "https://api.github.com/users/markdroth/events{/privacy}",
      "received_events_url": "https://api.github.com/users/markdroth/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-11T14:58:25Z",
    "updated_at": "2017-07-11T14:58:25Z",
    "author_association": "MEMBER",
    "body": "Maybe add some comments explaining the reason for the placement of the locking, so that we don't accidentally break it in the future?"
  }
]
