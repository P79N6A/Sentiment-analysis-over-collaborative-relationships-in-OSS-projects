{"schema": {"fields":[{"type":"integer","name":"index"},{"type":"string","name":"author_association"},{"type":"string","name":"body"},{"type":"datetime","name":"created_at"},{"type":"string","name":"html_url"},{"type":"integer","name":"id"},{"type":"string","name":"issue_url"},{"type":"string","name":"node_id"},{"type":"datetime","name":"updated_at"},{"type":"string","name":"url"},{"type":"string","name":"user"}],"pandas_version":"0.20.0","primaryKey":["index"]}, "data": [{"index":0,"author_association":"CONTRIBUTOR","body":"BTW the main reason I didn't implement a Kelemen geometry function is that the indirect specular GGX Environment BDRF is opaque (see https:\/\/github.com\/mrdoob\/three.js\/issues\/7489 for discussion) , I can not figure out how to modify it to also use a Kelement geometry function instead of the GGX geometry function to keep it in sync with the direct specular lighting.  This implementation is at least consistent between direct and indirect specular even though it is still reliant upon the GGX geometry function.\n\nHere is a Kelemen visibility function (cut-and-pasted from Clara.io's code base) as we could use:\n\n```\nfloat G_Kelemen( float dotHV ) {\n  return 1.0 \/ ( 4.0 * pow2( dotHV ) + EPSILON );\n}\n```\n","created_at":"2016-05-30T14:52:13.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222508594","id":222508594,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjUwODU5NA==","updated_at":"2016-05-30T14:52:42.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222508594","user":{"following_url":"https:\/\/api.github.com\/users\/bhouston\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/bhouston\/events{\/privacy}","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/588541?v=4","url":"https:\/\/api.github.com\/users\/bhouston","gists_url":"https:\/\/api.github.com\/users\/bhouston\/gists{\/gist_id}","html_url":"https:\/\/github.com\/bhouston","subscriptions_url":"https:\/\/api.github.com\/users\/bhouston\/subscriptions","node_id":"MDQ6VXNlcjU4ODU0MQ==","repos_url":"https:\/\/api.github.com\/users\/bhouston\/repos","received_events_url":"https:\/\/api.github.com\/users\/bhouston\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/bhouston\/starred{\/owner}{\/repo}","site_admin":false,"login":"bhouston","type":"User","id":588541,"followers_url":"https:\/\/api.github.com\/users\/bhouston\/followers","organizations_url":"https:\/\/api.github.com\/users\/bhouston\/orgs"}},{"index":1,"author_association":"COLLABORATOR","body":"@bhouston Thanks! I have implemented the same in my fork, and also used GGX. I do not think the clear coat model matters that much.\n\nI will compare our approaches as soon as I can, and see if there are any modeling differences that appear significant.\n\nI used the uncapitalized form `.clearcoat` \/ `.clearcoatRoughness` -- personal preference, of course.\n","created_at":"2016-05-30T17:38:20.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222532517","id":222532517,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjUzMjUxNw==","updated_at":"2016-05-30T17:38:20.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222532517","user":{"following_url":"https:\/\/api.github.com\/users\/WestLangley\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/WestLangley\/events{\/privacy}","avatar_url":"https:\/\/avatars2.githubusercontent.com\/u\/1000017?v=4","url":"https:\/\/api.github.com\/users\/WestLangley","gists_url":"https:\/\/api.github.com\/users\/WestLangley\/gists{\/gist_id}","html_url":"https:\/\/github.com\/WestLangley","subscriptions_url":"https:\/\/api.github.com\/users\/WestLangley\/subscriptions","node_id":"MDQ6VXNlcjEwMDAwMTc=","repos_url":"https:\/\/api.github.com\/users\/WestLangley\/repos","received_events_url":"https:\/\/api.github.com\/users\/WestLangley\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/WestLangley\/starred{\/owner}{\/repo}","site_admin":false,"login":"WestLangley","type":"User","id":1000017,"followers_url":"https:\/\/api.github.com\/users\/WestLangley\/followers","organizations_url":"https:\/\/api.github.com\/users\/WestLangley\/orgs"}},{"index":2,"author_association":"CONTRIBUTOR","body":"@WestLangley thanks for the partial review.  I've moved the uniforms into the right place. :)  I think I'll keep \"clearCoat\" like that because it is generally used as two words in most references I have found: \"clear coat\".  Good to know that you went with GGX as well.\n\nI believe that the use of the Kelemen visible\/geometry distribution for clear coats originates from this paper (by Kelemen of course):\n\nhttp:\/\/sirkan.iit.bme.hu\/~szirmay\/scook.pdf\n","created_at":"2016-05-30T17:55:45.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222534518","id":222534518,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjUzNDUxOA==","updated_at":"2016-05-30T17:55:45.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222534518","user":{"following_url":"https:\/\/api.github.com\/users\/bhouston\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/bhouston\/events{\/privacy}","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/588541?v=4","url":"https:\/\/api.github.com\/users\/bhouston","gists_url":"https:\/\/api.github.com\/users\/bhouston\/gists{\/gist_id}","html_url":"https:\/\/github.com\/bhouston","subscriptions_url":"https:\/\/api.github.com\/users\/bhouston\/subscriptions","node_id":"MDQ6VXNlcjU4ODU0MQ==","repos_url":"https:\/\/api.github.com\/users\/bhouston\/repos","received_events_url":"https:\/\/api.github.com\/users\/bhouston\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/bhouston\/starred{\/owner}{\/repo}","site_admin":false,"login":"bhouston","type":"User","id":588541,"followers_url":"https:\/\/api.github.com\/users\/bhouston\/followers","organizations_url":"https:\/\/api.github.com\/users\/bhouston\/orgs"}},{"index":3,"author_association":"COLLABORATOR","body":"@bhouston All the pieces are in place and I like your refactoring. But your model is losing too much energy when `clearCoat` is increased. I have a proposed fix though.\n\nI should preface this by saying there are no right answers, and we may each choose to make different compromises. We just have to do something that is reasonable.\n\nHere are results of my proposed fix. The underlying material in this example is rough with a (maximal) _super-smooth_ clear coat.\n\n![screen shot 2016-05-30 at 4 38 45 pm](https:\/\/cloud.githubusercontent.com\/assets\/1000017\/15658437\/a6b76346-268a-11e6-8a0f-c9e3de2e2676.png)\n\nAnd the same underlying material with a maximal _super-rough_ clear coat.\n\n![screen shot 2016-05-30 at 4 39 02 pm](https:\/\/cloud.githubusercontent.com\/assets\/1000017\/15658446\/b374e806-268a-11e6-88c3-a9cb0f8231bb.png)\n\nThese compare to the same two cases -- smooth clear coat and rough clear coat -- using the model in this PR. Notice how energy is lost from the underlying material.\n\n![screen shot 2016-05-30 at 4 42 04 pm](https:\/\/cloud.githubusercontent.com\/assets\/1000017\/15658462\/c0e12c52-268a-11e6-8618-6a2d6a4e65d8.png)\n\n![screen shot 2016-05-30 at 4 42 19 pm](https:\/\/cloud.githubusercontent.com\/assets\/1000017\/15658471\/e186f8f6-268a-11e6-8089-d97155fef8b3.png)\n\nIn the model I implemented in my fork, I made the following assumptions.\n1. The clear coat does not reflect any light diffusely. It is transparent. That energy is passed through to the underlying material, where it is absorbed, or reflected.\n2. The specular energy reflected by the clear coat is minimal. For that reason, it is OK -- for now anyway -- to ignore the energy conservation calculation that would otherwise be required.\n\nHere are the suggested changes to your model. Posted for clarity, not efficiency.\n\n``` glsl\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n    float dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\n    vec3 irradiance = dotNL * directLight.color;\n\n    #ifndef PHYSICALLY_CORRECT_LIGHTS\n\n        irradiance *= PI; \/\/ punctual light\n\n    #endif\n\n    vec3 specularRadiance = irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness );\n    vec3 diffuseRadiance = irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\n    #ifndef STANDARD\n\n        vec3 clearCoatSpecularRadiance = irradiance * BRDF_Specular_GGX( directLight, geometry, vec3( material.clearCoat ), material.clearCoatRoughness );\n\n        \/\/specularRadiance = mix( specularRadiance, clearCoatSpecularRadiance, material.clearCoat );\n        \/\/diffuseRadiance = mix( diffuseRadiance, vec3( 0.0 ), material.clearCoat );\n        specularRadiance += material.clearCoat * clearCoatSpecularRadiance;\n\n    #endif\n\n    reflectedLight.directSpecular += specularRadiance;\n    reflectedLight.directDiffuse += diffuseRadiance;\n\n}\n\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n    vec3 diffuseRadiance = irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\n    \/\/#ifndef STANDARD\n\n    \/\/  diffuseRadiance = mix( diffuseRadiance, vec3( 0.0 ), material.clearCoat );\n\n    \/\/#endif\n\n    reflectedLight.indirectDiffuse += diffuseRadiance;\n\n}\n\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 clearCoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n    vec3 specularRadiance = radiance * BRDF_Specular_GGX_Environment( geometry, material.specularColor, material.specularRoughness );\n\n    #ifndef STANDARD\n\n        vec3 clearCoatSpecularRadiance = clearCoatRadiance * BRDF_Specular_GGX_Environment( geometry, vec3( material.clearCoat * DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\n        \/\/specularRadiance = mix( specularRadiance, clearCoatSpecularRadiance, material.clearCoat );\n        specularRadiance += material.clearCoat * clearCoatSpecularRadiance;\n\n    #endif\n\n    reflectedLight.indirectSpecular += specularRadiance;\n\n}\n```\n\nI am open to other changes, such a modeling the clear coat as a polyurethane. I may still have a few minor additional suggestions later -- after some experimentation.\n\nAnd of course, thank you for this PR!\n","created_at":"2016-05-30T21:34:16.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222557084","id":222557084,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjU1NzA4NA==","updated_at":"2016-05-30T21:34:16.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222557084","user":{"following_url":"https:\/\/api.github.com\/users\/WestLangley\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/WestLangley\/events{\/privacy}","avatar_url":"https:\/\/avatars2.githubusercontent.com\/u\/1000017?v=4","url":"https:\/\/api.github.com\/users\/WestLangley","gists_url":"https:\/\/api.github.com\/users\/WestLangley\/gists{\/gist_id}","html_url":"https:\/\/github.com\/WestLangley","subscriptions_url":"https:\/\/api.github.com\/users\/WestLangley\/subscriptions","node_id":"MDQ6VXNlcjEwMDAwMTc=","repos_url":"https:\/\/api.github.com\/users\/WestLangley\/repos","received_events_url":"https:\/\/api.github.com\/users\/WestLangley\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/WestLangley\/starred{\/owner}{\/repo}","site_admin":false,"login":"WestLangley","type":"User","id":1000017,"followers_url":"https:\/\/api.github.com\/users\/WestLangley\/followers","organizations_url":"https:\/\/api.github.com\/users\/WestLangley\/orgs"}},{"index":4,"author_association":"CONTRIBUTOR","body":"I followed the energy conservation model because I was following the UE4 clear coat model -- this is actually how they do it.  But you seem to be suggesting what Burley suggests in the Disney PBR paper:\n\n> For our clearcoat layer, we use a fixed ior of 1.5, representative of polyurethane, and instead\n> allow artists to scale the overall strength of the layer using the clearcoat parameter. The normalized\n> parameter range corresponds to an overall scale of [0, 0.25]. This layer, even though it has a large\n> visual impact, represents a relatively small amount of energy so we don\u2019t subtract any energy from the base layer. When set to zero, the clearcoat layer is effectively disabled and incurs no cost.\n\nQuoted from pg 16 of https:\/\/disney-animation.s3.amazonaws.com\/library\/s2012_pbs_disney_brdf_notes_v2.pdf\n\nDisney model, like you suggest, does not engage in energy conservation, but they also limit the strength of the clear coat to go to 0.25, as that seems to be the meaningful range (sort of like how we limit reflectance to the range of [0,0.16].  Thus when we set `material.clearCoat` in `lights_physical_fragment.glsl` we would do this:\n\n```\nmaterial.clearCoat = saturate( clearCoat ) * 0.25;\n```\n\nAnd this would work well with the rest of your proposed changes.\n\nWhat do you think?\n","created_at":"2016-05-31T00:25:14.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222568938","id":222568938,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjU2ODkzOA==","updated_at":"2016-05-31T00:25:14.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222568938","user":{"following_url":"https:\/\/api.github.com\/users\/bhouston\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/bhouston\/events{\/privacy}","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/588541?v=4","url":"https:\/\/api.github.com\/users\/bhouston","gists_url":"https:\/\/api.github.com\/users\/bhouston\/gists{\/gist_id}","html_url":"https:\/\/github.com\/bhouston","subscriptions_url":"https:\/\/api.github.com\/users\/bhouston\/subscriptions","node_id":"MDQ6VXNlcjU4ODU0MQ==","repos_url":"https:\/\/api.github.com\/users\/bhouston\/repos","received_events_url":"https:\/\/api.github.com\/users\/bhouston\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/bhouston\/starred{\/owner}{\/repo}","site_admin":false,"login":"bhouston","type":"User","id":588541,"followers_url":"https:\/\/api.github.com\/users\/bhouston\/followers","organizations_url":"https:\/\/api.github.com\/users\/bhouston\/orgs"}},{"index":5,"author_association":"COLLABORATOR","body":"Yes. That must have been what I read, too. : - )\n\n> I followed the energy conservation model \n\nYes, but I do not think what you implemented is the correct energy conservation model. You would have to do an integral to see how much total energy is reflected specularly, and then subtract that from the energy that is available for the next layer. I expect the total energy reflected by the clear coat layer is very small (assuming no diffuse reflectance), but I haven't done the math to quantify.\n\nI actually remapped `clearCoat` like so:\n\n``` glsl\nmaterial.clearCoat = 0.5 * clearCoat;\n```\n\nBut I like it not remapped now. : - )  Can we leave it not remapped for now so we can experiment with it?\n","created_at":"2016-05-31T00:42:06.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222570158","id":222570158,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjU3MDE1OA==","updated_at":"2016-05-31T00:42:06.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222570158","user":{"following_url":"https:\/\/api.github.com\/users\/WestLangley\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/WestLangley\/events{\/privacy}","avatar_url":"https:\/\/avatars2.githubusercontent.com\/u\/1000017?v=4","url":"https:\/\/api.github.com\/users\/WestLangley","gists_url":"https:\/\/api.github.com\/users\/WestLangley\/gists{\/gist_id}","html_url":"https:\/\/github.com\/WestLangley","subscriptions_url":"https:\/\/api.github.com\/users\/WestLangley\/subscriptions","node_id":"MDQ6VXNlcjEwMDAwMTc=","repos_url":"https:\/\/api.github.com\/users\/WestLangley\/repos","received_events_url":"https:\/\/api.github.com\/users\/WestLangley\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/WestLangley\/starred{\/owner}{\/repo}","site_admin":false,"login":"WestLangley","type":"User","id":1000017,"followers_url":"https:\/\/api.github.com\/users\/WestLangley\/followers","organizations_url":"https:\/\/api.github.com\/users\/WestLangley\/orgs"}},{"index":6,"author_association":"CONTRIBUTOR","body":"I just implemented what you asked and I do not like the results as it is missing the richness that the energy conserving model added:\n\n![image](https:\/\/cloud.githubusercontent.com\/assets\/588541\/15660176\/a012b54c-26a6-11e6-907c-fb4155092d54.png)\n\nI actually like the idea of not allowing for one to use only clear coatas I had it in the original PR (thus I like the idea of limiting it to 0.25 as Burley does as that seems reasonable) , but the energy conservation adds so much realism -- otherwise the artist has to do that themselves, and know that they have to do that (which is hard on artists to remember that they have to always do this compensation.)\n\nMy concern is that you are not familiar with the realism that energy conservation adds.\n","created_at":"2016-05-31T00:42:43.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222570205","id":222570205,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjU3MDIwNQ==","updated_at":"2016-05-31T00:42:43.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222570205","user":{"following_url":"https:\/\/api.github.com\/users\/bhouston\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/bhouston\/events{\/privacy}","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/588541?v=4","url":"https:\/\/api.github.com\/users\/bhouston","gists_url":"https:\/\/api.github.com\/users\/bhouston\/gists{\/gist_id}","html_url":"https:\/\/github.com\/bhouston","subscriptions_url":"https:\/\/api.github.com\/users\/bhouston\/subscriptions","node_id":"MDQ6VXNlcjU4ODU0MQ==","repos_url":"https:\/\/api.github.com\/users\/bhouston\/repos","received_events_url":"https:\/\/api.github.com\/users\/bhouston\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/bhouston\/starred{\/owner}{\/repo}","site_admin":false,"login":"bhouston","type":"User","id":588541,"followers_url":"https:\/\/api.github.com\/users\/bhouston\/followers","organizations_url":"https:\/\/api.github.com\/users\/bhouston\/orgs"}},{"index":7,"author_association":"CONTRIBUTOR","body":"Energy conservation is actually a major part of PBR models and a major reason why they are realistic.  The energy conservation that metalness does to diffuse is the best example of how energy conservation adds tons of realism.\n\nNow I am not saying I am doing energy conservation correct in this case - I maybe should be doing it based on the result of the Schlick fresnel term.\n\nI think the simplest is given in equation (22) in this classic paper by Schlick on how one does simple energy conservation through layered materials:\n\nhttps:\/\/www.cs.virginia.edu\/~jdl\/bib\/appearance\/analytic%20models\/schlick94b.pdf\n","created_at":"2016-05-31T00:56:37.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222571201","id":222571201,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjU3MTIwMQ==","updated_at":"2016-05-31T00:56:37.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222571201","user":{"following_url":"https:\/\/api.github.com\/users\/bhouston\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/bhouston\/events{\/privacy}","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/588541?v=4","url":"https:\/\/api.github.com\/users\/bhouston","gists_url":"https:\/\/api.github.com\/users\/bhouston\/gists{\/gist_id}","html_url":"https:\/\/github.com\/bhouston","subscriptions_url":"https:\/\/api.github.com\/users\/bhouston\/subscriptions","node_id":"MDQ6VXNlcjU4ODU0MQ==","repos_url":"https:\/\/api.github.com\/users\/bhouston\/repos","received_events_url":"https:\/\/api.github.com\/users\/bhouston\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/bhouston\/starred{\/owner}{\/repo}","site_admin":false,"login":"bhouston","type":"User","id":588541,"followers_url":"https:\/\/api.github.com\/users\/bhouston\/followers","organizations_url":"https:\/\/api.github.com\/users\/bhouston\/orgs"}},{"index":8,"author_association":"CONTRIBUTOR","body":"> I expect the total energy reflected by the clear coat layer is very small (assuming no diffuse reflectance), but I haven't done the math to quantify.\n\nI believe if you calculate the Schlick Fresnel term, that is how much is reflected by the specular layer, and ( 1 - Schlick_Fresnel ) is what is available to the layer underneath.\n\nWe could do this for clearCoat as well as the standard specular lobe (well we would have to chain the two energy preservations together) and ThreeJS's physical model would be energy preserving.\n","created_at":"2016-05-31T01:02:27.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222571658","id":222571658,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjU3MTY1OA==","updated_at":"2016-05-31T01:02:27.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222571658","user":{"following_url":"https:\/\/api.github.com\/users\/bhouston\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/bhouston\/events{\/privacy}","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/588541?v=4","url":"https:\/\/api.github.com\/users\/bhouston","gists_url":"https:\/\/api.github.com\/users\/bhouston\/gists{\/gist_id}","html_url":"https:\/\/github.com\/bhouston","subscriptions_url":"https:\/\/api.github.com\/users\/bhouston\/subscriptions","node_id":"MDQ6VXNlcjU4ODU0MQ==","repos_url":"https:\/\/api.github.com\/users\/bhouston\/repos","received_events_url":"https:\/\/api.github.com\/users\/bhouston\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/bhouston\/starred{\/owner}{\/repo}","site_admin":false,"login":"bhouston","type":"User","id":588541,"followers_url":"https:\/\/api.github.com\/users\/bhouston\/followers","organizations_url":"https:\/\/api.github.com\/users\/bhouston\/orgs"}},{"index":9,"author_association":"COLLABORATOR","body":"Can you remove the build from the PR?\n\n> My concern is that you are not familiar with the realism that energy conservation adds.\n\nOh, I support your desire to handle energy conservation. But you are not implementing an energy conservation model, IMO. You are mixing materials. That is not the correct math.\n\nI am arguing for now that since the excess energy is maybe 1%, we ignore it until we can figure out how to handle energy conservation correctly.\n\nThe clear coat is only reflecting specular energy, remember. It should look like a gloss or satin finish on top of the bass material.\n","created_at":"2016-05-31T01:02:43.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222571673","id":222571673,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjU3MTY3Mw==","updated_at":"2016-05-31T01:02:43.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222571673","user":{"following_url":"https:\/\/api.github.com\/users\/WestLangley\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/WestLangley\/events{\/privacy}","avatar_url":"https:\/\/avatars2.githubusercontent.com\/u\/1000017?v=4","url":"https:\/\/api.github.com\/users\/WestLangley","gists_url":"https:\/\/api.github.com\/users\/WestLangley\/gists{\/gist_id}","html_url":"https:\/\/github.com\/WestLangley","subscriptions_url":"https:\/\/api.github.com\/users\/WestLangley\/subscriptions","node_id":"MDQ6VXNlcjEwMDAwMTc=","repos_url":"https:\/\/api.github.com\/users\/WestLangley\/repos","received_events_url":"https:\/\/api.github.com\/users\/WestLangley\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/WestLangley\/starred{\/owner}{\/repo}","site_admin":false,"login":"WestLangley","type":"User","id":1000017,"followers_url":"https:\/\/api.github.com\/users\/WestLangley\/followers","organizations_url":"https:\/\/api.github.com\/users\/WestLangley\/orgs"}},{"index":10,"author_association":"CONTRIBUTOR","body":"> I am arguing for now that since the excess energy is maybe 1%, we ignore it until we can figure out how to handle energy conservation correctly.\n\nAt grazing angles the Fresnel term goes to 1.0 right?  Thus the clear coat specular goes to 1.0 at grazing angles and then is multiplied by 0.25.  And the underlying specular lobe will go to 1.0 at grazing angles as well.  Thus together we are at 1.25x incoming energy at grazing angles for a smooth surface based on specular alone (and that excludes diffuse contributions) if we use the Burley parameterization.  It would be at 2x incoming energy based on specular + clear coat at grazing angles on a smooth surface before I switched to the Burley parameterization.\n\nWe are not energy perserving.\n\nPlease see Schlick's paper on energy preserving.  As long as we do not model internal reflections we can actually do layering really easily.\n","created_at":"2016-05-31T01:06:34.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222571969","id":222571969,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjU3MTk2OQ==","updated_at":"2016-05-31T01:07:11.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222571969","user":{"following_url":"https:\/\/api.github.com\/users\/bhouston\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/bhouston\/events{\/privacy}","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/588541?v=4","url":"https:\/\/api.github.com\/users\/bhouston","gists_url":"https:\/\/api.github.com\/users\/bhouston\/gists{\/gist_id}","html_url":"https:\/\/github.com\/bhouston","subscriptions_url":"https:\/\/api.github.com\/users\/bhouston\/subscriptions","node_id":"MDQ6VXNlcjU4ODU0MQ==","repos_url":"https:\/\/api.github.com\/users\/bhouston\/repos","received_events_url":"https:\/\/api.github.com\/users\/bhouston\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/bhouston\/starred{\/owner}{\/repo}","site_admin":false,"login":"bhouston","type":"User","id":588541,"followers_url":"https:\/\/api.github.com\/users\/bhouston\/followers","organizations_url":"https:\/\/api.github.com\/users\/bhouston\/orgs"}},{"index":11,"author_association":"COLLABORATOR","body":"Yes, as I said, the model I implemented is not energy-conserving. (I have no objection to adding energy-conservation, though.)\n\nLet's have a go at adding in a reasonable energy-conserving term.\n\nCan you remove the build from the PR?\n","created_at":"2016-05-31T01:19:19.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222573004","id":222573004,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjU3MzAwNA==","updated_at":"2016-05-31T01:19:19.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222573004","user":{"following_url":"https:\/\/api.github.com\/users\/WestLangley\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/WestLangley\/events{\/privacy}","avatar_url":"https:\/\/avatars2.githubusercontent.com\/u\/1000017?v=4","url":"https:\/\/api.github.com\/users\/WestLangley","gists_url":"https:\/\/api.github.com\/users\/WestLangley\/gists{\/gist_id}","html_url":"https:\/\/github.com\/WestLangley","subscriptions_url":"https:\/\/api.github.com\/users\/WestLangley\/subscriptions","node_id":"MDQ6VXNlcjEwMDAwMTc=","repos_url":"https:\/\/api.github.com\/users\/WestLangley\/repos","received_events_url":"https:\/\/api.github.com\/users\/WestLangley\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/WestLangley\/starred{\/owner}{\/repo}","site_admin":false,"login":"WestLangley","type":"User","id":1000017,"followers_url":"https:\/\/api.github.com\/users\/WestLangley\/followers","organizations_url":"https:\/\/api.github.com\/users\/WestLangley\/orgs"}},{"index":12,"author_association":"CONTRIBUTOR","body":"> Can you remove the build from the PR?\n\nI'll commit the current build in this PR on top, with the new PR collapsing that mrdoob is doing, it will have the effect of removing it from the three.js git repo history.\n","created_at":"2016-05-31T01:21:20.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222573187","id":222573187,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjU3MzE4Nw==","updated_at":"2016-05-31T01:21:20.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222573187","user":{"following_url":"https:\/\/api.github.com\/users\/bhouston\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/bhouston\/events{\/privacy}","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/588541?v=4","url":"https:\/\/api.github.com\/users\/bhouston","gists_url":"https:\/\/api.github.com\/users\/bhouston\/gists{\/gist_id}","html_url":"https:\/\/github.com\/bhouston","subscriptions_url":"https:\/\/api.github.com\/users\/bhouston\/subscriptions","node_id":"MDQ6VXNlcjU4ODU0MQ==","repos_url":"https:\/\/api.github.com\/users\/bhouston\/repos","received_events_url":"https:\/\/api.github.com\/users\/bhouston\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/bhouston\/starred{\/owner}{\/repo}","site_admin":false,"login":"bhouston","type":"User","id":588541,"followers_url":"https:\/\/api.github.com\/users\/bhouston\/followers","organizations_url":"https:\/\/api.github.com\/users\/bhouston\/orgs"}},{"index":13,"author_association":"CONTRIBUTOR","body":"I've removed any energy conservation because even though I think it is important, it will make this PR hard to get accepted.  Thus I've kept it simple and even adopted the 0.5 parameterization of @WestLangley rather then the 0.25 parameterization of Burley.\n\nEnergy conservation will be done as a separate future PR.\n","created_at":"2016-05-31T01:50:48.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222575739","id":222575739,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjU3NTczOQ==","updated_at":"2016-05-31T01:50:48.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222575739","user":{"following_url":"https:\/\/api.github.com\/users\/bhouston\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/bhouston\/events{\/privacy}","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/588541?v=4","url":"https:\/\/api.github.com\/users\/bhouston","gists_url":"https:\/\/api.github.com\/users\/bhouston\/gists{\/gist_id}","html_url":"https:\/\/github.com\/bhouston","subscriptions_url":"https:\/\/api.github.com\/users\/bhouston\/subscriptions","node_id":"MDQ6VXNlcjU4ODU0MQ==","repos_url":"https:\/\/api.github.com\/users\/bhouston\/repos","received_events_url":"https:\/\/api.github.com\/users\/bhouston\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/bhouston\/starred{\/owner}{\/repo}","site_admin":false,"login":"bhouston","type":"User","id":588541,"followers_url":"https:\/\/api.github.com\/users\/bhouston\/followers","organizations_url":"https:\/\/api.github.com\/users\/bhouston\/orgs"}},{"index":14,"author_association":"COLLABORATOR","body":"> Energy conservation will be done as a separate future PR.\n\nOK.\n\nThis PR is good-to-go as far as I am concerned.\n","created_at":"2016-05-31T01:57:45.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222576435","id":222576435,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjU3NjQzNQ==","updated_at":"2016-05-31T01:57:45.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222576435","user":{"following_url":"https:\/\/api.github.com\/users\/WestLangley\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/WestLangley\/events{\/privacy}","avatar_url":"https:\/\/avatars2.githubusercontent.com\/u\/1000017?v=4","url":"https:\/\/api.github.com\/users\/WestLangley","gists_url":"https:\/\/api.github.com\/users\/WestLangley\/gists{\/gist_id}","html_url":"https:\/\/github.com\/WestLangley","subscriptions_url":"https:\/\/api.github.com\/users\/WestLangley\/subscriptions","node_id":"MDQ6VXNlcjEwMDAwMTc=","repos_url":"https:\/\/api.github.com\/users\/WestLangley\/repos","received_events_url":"https:\/\/api.github.com\/users\/WestLangley\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/WestLangley\/starred{\/owner}{\/repo}","site_admin":false,"login":"WestLangley","type":"User","id":1000017,"followers_url":"https:\/\/api.github.com\/users\/WestLangley\/followers","organizations_url":"https:\/\/api.github.com\/users\/WestLangley\/orgs"}},{"index":15,"author_association":"OWNER","body":"Uh oh, seems like my `type:` clean up created conflicts. Do you mind pulling from `dev`?\n","created_at":"2016-05-31T20:12:48.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222805784","id":222805784,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMjgwNTc4NA==","updated_at":"2016-05-31T20:12:48.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/222805784","user":{"following_url":"https:\/\/api.github.com\/users\/mrdoob\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/mrdoob\/events{\/privacy}","avatar_url":"https:\/\/avatars0.githubusercontent.com\/u\/97088?v=4","url":"https:\/\/api.github.com\/users\/mrdoob","gists_url":"https:\/\/api.github.com\/users\/mrdoob\/gists{\/gist_id}","html_url":"https:\/\/github.com\/mrdoob","subscriptions_url":"https:\/\/api.github.com\/users\/mrdoob\/subscriptions","node_id":"MDQ6VXNlcjk3MDg4","repos_url":"https:\/\/api.github.com\/users\/mrdoob\/repos","received_events_url":"https:\/\/api.github.com\/users\/mrdoob\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/mrdoob\/starred{\/owner}{\/repo}","site_admin":false,"login":"mrdoob","type":"User","id":97088,"followers_url":"https:\/\/api.github.com\/users\/mrdoob\/followers","organizations_url":"https:\/\/api.github.com\/users\/mrdoob\/orgs"}},{"index":16,"author_association":"CONTRIBUTOR","body":"I merged in dev, I changed the clearCoat range to 0-1 as @WestLangley suggested [here](https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222570158) and changed the example color to gray from yellow.  It should be good to go.\n","created_at":"2016-06-02T00:09:32.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-223161582","id":223161582,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMzE2MTU4Mg==","updated_at":"2016-06-02T00:09:32.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/223161582","user":{"following_url":"https:\/\/api.github.com\/users\/bhouston\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/bhouston\/events{\/privacy}","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/588541?v=4","url":"https:\/\/api.github.com\/users\/bhouston","gists_url":"https:\/\/api.github.com\/users\/bhouston\/gists{\/gist_id}","html_url":"https:\/\/github.com\/bhouston","subscriptions_url":"https:\/\/api.github.com\/users\/bhouston\/subscriptions","node_id":"MDQ6VXNlcjU4ODU0MQ==","repos_url":"https:\/\/api.github.com\/users\/bhouston\/repos","received_events_url":"https:\/\/api.github.com\/users\/bhouston\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/bhouston\/starred{\/owner}{\/repo}","site_admin":false,"login":"bhouston","type":"User","id":588541,"followers_url":"https:\/\/api.github.com\/users\/bhouston\/followers","organizations_url":"https:\/\/api.github.com\/users\/bhouston\/orgs"}},{"index":17,"author_association":"OWNER","body":"Thanks!\n","created_at":"2016-06-02T04:02:16.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-223190069","id":223190069,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyMzE5MDA2OQ==","updated_at":"2016-06-02T04:02:16.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/223190069","user":{"following_url":"https:\/\/api.github.com\/users\/mrdoob\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/mrdoob\/events{\/privacy}","avatar_url":"https:\/\/avatars0.githubusercontent.com\/u\/97088?v=4","url":"https:\/\/api.github.com\/users\/mrdoob","gists_url":"https:\/\/api.github.com\/users\/mrdoob\/gists{\/gist_id}","html_url":"https:\/\/github.com\/mrdoob","subscriptions_url":"https:\/\/api.github.com\/users\/mrdoob\/subscriptions","node_id":"MDQ6VXNlcjk3MDg4","repos_url":"https:\/\/api.github.com\/users\/mrdoob\/repos","received_events_url":"https:\/\/api.github.com\/users\/mrdoob\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/mrdoob\/starred{\/owner}{\/repo}","site_admin":false,"login":"mrdoob","type":"User","id":97088,"followers_url":"https:\/\/api.github.com\/users\/mrdoob\/followers","organizations_url":"https:\/\/api.github.com\/users\/mrdoob\/orgs"}},{"index":18,"author_association":"COLLABORATOR","body":"@bhouston \n\nEarlier, I wrote:\n\n> You would have to do an integral to see how much total energy is reflected specularly, and then subtract that from the energy that is available for the next layer. I expect the total energy reflected by the clear coat layer is very small (assuming no diffuse reflectance), but I haven't done the math to quantify.\n\nDirectional-hemispherical reflectance, or directional albedo, is the fraction of radiant energy scattered in all directions. (Not just in the direction of the viewer.) It is the integral of the cosine-weighted BRDF over all viewing directions.\n\n```\nalbedo( \u03c9i ) = \u222b fr( \u03c9o, \u03c9i ) cos( \u03b8o ) d\u03c9o      for a given incoming direction \u03c9i\n```\n\nIn the above formula, `fr()` is the BRDF, and the integral is over the hemisphere defined by the surface normal.\n\nDue to energy conservation, albedo \u2264 1.\n\nFor our clear coat GGX BRDF, this integral must be evaluated numerically. It can be parameterized by the clear coat roughness, and the incoming light direction. Here is the surface plot:\n\n![directional albedo](https:\/\/cloud.githubusercontent.com\/assets\/1000017\/16360081\/9bd7c244-3b1c-11e6-8c5c-b2ba723b8a87.png)\n\nThe total energy reflected by the clear coat layer is quite small, except when the clear coat surface is smooth, and the incoming grazing angle is about 70 degrees or greater.\n\nSo we can modify our rendering equation to subtract this reflected energy from that which would normally be available to the base layer.\n\nI have hacked up an example [here](https:\/\/dl.dropboxusercontent.com\/u\/63997063\/Three\/ClearCoatEnergyTest\/Three.JS.ClearCoat.Energy.Testbed.html).\n\nIn the example, there is a checkbox to toggle off clear coat energy conservation. As you can see, the effect is minimal in most cases.\n\nNote that in the example, I approximated the directional albedo (plotted above) with a simple function having a similar shape. In practice, we would have to precompute and save the directional albedo to a data texture, or use MATLAB to find a better functional form.\n","created_at":"2016-06-26T01:58:22.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-228579949","id":228579949,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyODU3OTk0OQ==","updated_at":"2016-06-26T02:30:26.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/228579949","user":{"following_url":"https:\/\/api.github.com\/users\/WestLangley\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/WestLangley\/events{\/privacy}","avatar_url":"https:\/\/avatars2.githubusercontent.com\/u\/1000017?v=4","url":"https:\/\/api.github.com\/users\/WestLangley","gists_url":"https:\/\/api.github.com\/users\/WestLangley\/gists{\/gist_id}","html_url":"https:\/\/github.com\/WestLangley","subscriptions_url":"https:\/\/api.github.com\/users\/WestLangley\/subscriptions","node_id":"MDQ6VXNlcjEwMDAwMTc=","repos_url":"https:\/\/api.github.com\/users\/WestLangley\/repos","received_events_url":"https:\/\/api.github.com\/users\/WestLangley\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/WestLangley\/starred{\/owner}{\/repo}","site_admin":false,"login":"WestLangley","type":"User","id":1000017,"followers_url":"https:\/\/api.github.com\/users\/WestLangley\/followers","organizations_url":"https:\/\/api.github.com\/users\/WestLangley\/orgs"}},{"index":19,"author_association":"CONTRIBUTOR","body":"Sweet.  What equation did you derive in the end?  Others have suggested\nusing the fresnel which has gross similarity to what you described but I\nsuspect the details are fairly different.  Beautiful results, this is a\nreally nice contributions .\n\nBest regards,\nBen Houston\nhttp:\/\/Clara.io Online 3d modeling and rendering\nOn Jun 25, 2016 9:59 PM, \"WestLangley\" notifications@github.com wrote:\n\n> @bhouston https:\/\/github.com\/bhouston\n> \n> Earlier, I wrote:\n> \n> You would have to do an integral to see how much total energy is reflected\n> specularly, and then subtract that from the energy that is available for\n> the next layer. I expect the total energy reflected by the clear coat layer\n> is very small (assuming no diffuse reflectance), but I haven't done the\n> math to quantify.\n> \n> Directional-hemispherical reflectance, or directional albedo, is the\n> fraction of radiant energy scattered. It is the integral of the\n> cosine-weighted BRDF over all viewing directions.\n> \n> albedo( \u03c9i ) = \u222b fr( \u03c9o, \u03c9i ) cos( \u03b8o ) d\u03c9o      for a given incoming direction \u03c9i\n> \n> In the above formula, fr() is the BRDF, and the integral is over the\n> hemisphere defined by the surface normal.\n> \n> Due to energy conservation, albedo \u2264 1.\n> \n> For our clear coat GGX BRDF, this integral must be evaluated numerically.\n> It can be parameterized by the clear coat roughness, and the incoming light\n> direction. Here is the surface plot:\n> \n> [image: directional albedo]\n> https:\/\/cloud.githubusercontent.com\/assets\/1000017\/16360081\/9bd7c244-3b1c-11e6-8c5c-b2ba723b8a87.png\n> \n> The total energy reflected by the clear coat layer is quite small, except\n> when the surface is smooth, and the incoming grazing angle is about 70\n> degrees or greater.\n> \n> So we can modify our rendering equation to subtract this reflected energy\n> from that which would normally be available to the base layer.\n> \n> I have hacked up an example here\n> https:\/\/dl.dropboxusercontent.com\/u\/63997063\/Three\/ClearCoatEnergyTest\/Three.JS.ClearCoat.Energy.Testbed.html\n> .\n> \n> In the example, there is a checkbox to toggle off clear coat energy\n> conservation. As you can see, the effect is minimal in most cases.\n> \n> Note that in the example, I approximated the directional albedo (plotted\n> above) with a simple function. In practice, we would have to save the\n> directional albedo to a data texture, or use MATLAB to find a better\n> functional form.\n> \n> \u2014\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub\n> https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-228579949, or mute\n> the thread\n> https:\/\/github.com\/notifications\/unsubscribe\/AAj6_TVxA788M2cvPtdEW5lnssWstXQzks5qPd0FgaJpZM4Ip2iM\n> .\n","created_at":"2016-06-26T12:48:25.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-228599780","id":228599780,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyODU5OTc4MA==","updated_at":"2016-06-26T12:48:25.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/228599780","user":{"following_url":"https:\/\/api.github.com\/users\/bhouston\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/bhouston\/events{\/privacy}","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/588541?v=4","url":"https:\/\/api.github.com\/users\/bhouston","gists_url":"https:\/\/api.github.com\/users\/bhouston\/gists{\/gist_id}","html_url":"https:\/\/github.com\/bhouston","subscriptions_url":"https:\/\/api.github.com\/users\/bhouston\/subscriptions","node_id":"MDQ6VXNlcjU4ODU0MQ==","repos_url":"https:\/\/api.github.com\/users\/bhouston\/repos","received_events_url":"https:\/\/api.github.com\/users\/bhouston\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/bhouston\/starred{\/owner}{\/repo}","site_admin":false,"login":"bhouston","type":"User","id":588541,"followers_url":"https:\/\/api.github.com\/users\/bhouston\/followers","organizations_url":"https:\/\/api.github.com\/users\/bhouston\/orgs"}},{"index":20,"author_association":"COLLABORATOR","body":"@bhouston \n\n> What equation did you derive in the end?\n\nHere is the approximation I used in the example. It is only meant to be used for our particular clear-coat layer. The approximation should be improved -- or replaced with a texture lookup.\n\n``` glsl\nfloat clearCoatDHRApprox( const in float roughness, const in float dotNL ) {\n\n    return DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n\n}\n```\n\nThe falloff when roughness increases is due to the shadow\/masking effect.\n","created_at":"2016-06-26T16:45:31.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-228610266","id":228610266,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyODYxMDI2Ng==","updated_at":"2016-06-26T16:45:31.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/228610266","user":{"following_url":"https:\/\/api.github.com\/users\/WestLangley\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/WestLangley\/events{\/privacy}","avatar_url":"https:\/\/avatars2.githubusercontent.com\/u\/1000017?v=4","url":"https:\/\/api.github.com\/users\/WestLangley","gists_url":"https:\/\/api.github.com\/users\/WestLangley\/gists{\/gist_id}","html_url":"https:\/\/github.com\/WestLangley","subscriptions_url":"https:\/\/api.github.com\/users\/WestLangley\/subscriptions","node_id":"MDQ6VXNlcjEwMDAwMTc=","repos_url":"https:\/\/api.github.com\/users\/WestLangley\/repos","received_events_url":"https:\/\/api.github.com\/users\/WestLangley\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/WestLangley\/starred{\/owner}{\/repo}","site_admin":false,"login":"WestLangley","type":"User","id":1000017,"followers_url":"https:\/\/api.github.com\/users\/WestLangley\/followers","organizations_url":"https:\/\/api.github.com\/users\/WestLangley\/orgs"}},{"index":21,"author_association":"CONTRIBUTOR","body":"@WestLangley wrote:\n\n```\nfloat clearCoatDHRApprox( const in float roughness, const in float dotNL ) {\n    return DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n```\n\nI notice the above is the Schlick Fresnel equation modified by a `pow2( 1.0 - roughness )`.  Thus I could rewrite it as this if we had a monochromatic Schlick function (which we should totally add):\n\n```\nfloat clearCoatDHRApprox( const in float roughness, const in float dotNL ) {\n    return F_Schlick( DEFAULT_SPECULAR_COEFFICIENT, dotNL ) * pow2( 1.0 - roughness );\n}\n```\n\nI undertand where the Schlick Fresnel comes from, I suggested this as the energy conservation term in [this comment previously](https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-222571658) as it is one of the standard methods to preserve this type of energy in layered materials.\n\nWhat I do not understand is the `pow2( 1.0 - roughness )` term.  I do now know your derivation so I can not follow its introduction.\n\nI actually am a bit confused by this addition it because it seems that the roughness affects the total energy reflected, which if I understand roughness correctly, it should not affect the total energy reflected, rather just in which direction it is reflected -- e.g. how it works when sampling pre-blurred environment maps.  But changes the directionality of reflected energy should not change the results of an integral summation, because the integral should sum across all directions -- thus it comes back to my confusion as to why roughness appears to be changing the total energy reflected.\n\nI'd like to confirm the derivation of this energy conservation function.\n","created_at":"2016-06-27T17:59:33.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-228824474","id":228824474,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyODgyNDQ3NA==","updated_at":"2016-06-27T17:59:57.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/228824474","user":{"following_url":"https:\/\/api.github.com\/users\/bhouston\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/bhouston\/events{\/privacy}","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/588541?v=4","url":"https:\/\/api.github.com\/users\/bhouston","gists_url":"https:\/\/api.github.com\/users\/bhouston\/gists{\/gist_id}","html_url":"https:\/\/github.com\/bhouston","subscriptions_url":"https:\/\/api.github.com\/users\/bhouston\/subscriptions","node_id":"MDQ6VXNlcjU4ODU0MQ==","repos_url":"https:\/\/api.github.com\/users\/bhouston\/repos","received_events_url":"https:\/\/api.github.com\/users\/bhouston\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/bhouston\/starred{\/owner}{\/repo}","site_admin":false,"login":"bhouston","type":"User","id":588541,"followers_url":"https:\/\/api.github.com\/users\/bhouston\/followers","organizations_url":"https:\/\/api.github.com\/users\/bhouston\/orgs"}},{"index":22,"author_association":"COLLABORATOR","body":"@bhouston The approximation is not \"derived\" -- it was defined to approximate the true directional hemispherical reflectance as pictured above. It was only used so I could show something quickly. We need to use the actual directional albedo -- or a better approximation -- in production.\n\n> I actually am a bit confused by this addition it because it seems that the roughness affects the total energy reflected\n\nAs I noted above, it is the shadowing\/masking effect that causes the directional hemispherical reflectance to be reduced as roughness is increased.\n","created_at":"2016-06-27T18:21:56.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-228830961","id":228830961,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyODgzMDk2MQ==","updated_at":"2016-06-27T18:21:56.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/228830961","user":{"following_url":"https:\/\/api.github.com\/users\/WestLangley\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/WestLangley\/events{\/privacy}","avatar_url":"https:\/\/avatars2.githubusercontent.com\/u\/1000017?v=4","url":"https:\/\/api.github.com\/users\/WestLangley","gists_url":"https:\/\/api.github.com\/users\/WestLangley\/gists{\/gist_id}","html_url":"https:\/\/github.com\/WestLangley","subscriptions_url":"https:\/\/api.github.com\/users\/WestLangley\/subscriptions","node_id":"MDQ6VXNlcjEwMDAwMTc=","repos_url":"https:\/\/api.github.com\/users\/WestLangley\/repos","received_events_url":"https:\/\/api.github.com\/users\/WestLangley\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/WestLangley\/starred{\/owner}{\/repo}","site_admin":false,"login":"WestLangley","type":"User","id":1000017,"followers_url":"https:\/\/api.github.com\/users\/WestLangley\/followers","organizations_url":"https:\/\/api.github.com\/users\/WestLangley\/orgs"}},{"index":23,"author_association":"CONTRIBUTOR","body":"@WestLangley, okay I'm good with this, thanks for humoring me.\n\nI'll make a PR that uses a Schlick Fresnel (per eqn 22 and 24 of [Schlick's 1994 paper](http:\/\/igorsklyar.com\/system\/documents\/papers\/28\/Schlick94.pdf) ) combined with your self-shadowing term of `pow2( 1 - roughness)` for energy conservation.\n","created_at":"2016-06-27T18:54:37.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-228840496","id":228840496,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyODg0MDQ5Ng==","updated_at":"2016-06-27T18:54:37.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/228840496","user":{"following_url":"https:\/\/api.github.com\/users\/bhouston\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/bhouston\/events{\/privacy}","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/588541?v=4","url":"https:\/\/api.github.com\/users\/bhouston","gists_url":"https:\/\/api.github.com\/users\/bhouston\/gists{\/gist_id}","html_url":"https:\/\/github.com\/bhouston","subscriptions_url":"https:\/\/api.github.com\/users\/bhouston\/subscriptions","node_id":"MDQ6VXNlcjU4ODU0MQ==","repos_url":"https:\/\/api.github.com\/users\/bhouston\/repos","received_events_url":"https:\/\/api.github.com\/users\/bhouston\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/bhouston\/starred{\/owner}{\/repo}","site_admin":false,"login":"bhouston","type":"User","id":588541,"followers_url":"https:\/\/api.github.com\/users\/bhouston\/followers","organizations_url":"https:\/\/api.github.com\/users\/bhouston\/orgs"}},{"index":24,"author_association":"COLLABORATOR","body":"@bhouston I already have the PR ready-to-go if you are happy with the approximation.\n","created_at":"2016-06-27T18:58:04.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-228841499","id":228841499,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyODg0MTQ5OQ==","updated_at":"2016-06-27T18:58:04.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/228841499","user":{"following_url":"https:\/\/api.github.com\/users\/WestLangley\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/WestLangley\/events{\/privacy}","avatar_url":"https:\/\/avatars2.githubusercontent.com\/u\/1000017?v=4","url":"https:\/\/api.github.com\/users\/WestLangley","gists_url":"https:\/\/api.github.com\/users\/WestLangley\/gists{\/gist_id}","html_url":"https:\/\/github.com\/WestLangley","subscriptions_url":"https:\/\/api.github.com\/users\/WestLangley\/subscriptions","node_id":"MDQ6VXNlcjEwMDAwMTc=","repos_url":"https:\/\/api.github.com\/users\/WestLangley\/repos","received_events_url":"https:\/\/api.github.com\/users\/WestLangley\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/WestLangley\/starred{\/owner}{\/repo}","site_admin":false,"login":"WestLangley","type":"User","id":1000017,"followers_url":"https:\/\/api.github.com\/users\/WestLangley\/followers","organizations_url":"https:\/\/api.github.com\/users\/WestLangley\/orgs"}},{"index":25,"author_association":"CONTRIBUTOR","body":"@WestLangley, go for it!  Clara.io ha been using this Schlick Fresnel energy conservation model (without the self-shadowing) for the last year and it produces great results.\n","created_at":"2016-06-27T19:09:02.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-228844465","id":228844465,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyODg0NDQ2NQ==","updated_at":"2016-06-27T19:09:02.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/228844465","user":{"following_url":"https:\/\/api.github.com\/users\/bhouston\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/bhouston\/events{\/privacy}","avatar_url":"https:\/\/avatars3.githubusercontent.com\/u\/588541?v=4","url":"https:\/\/api.github.com\/users\/bhouston","gists_url":"https:\/\/api.github.com\/users\/bhouston\/gists{\/gist_id}","html_url":"https:\/\/github.com\/bhouston","subscriptions_url":"https:\/\/api.github.com\/users\/bhouston\/subscriptions","node_id":"MDQ6VXNlcjU4ODU0MQ==","repos_url":"https:\/\/api.github.com\/users\/bhouston\/repos","received_events_url":"https:\/\/api.github.com\/users\/bhouston\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/bhouston\/starred{\/owner}{\/repo}","site_admin":false,"login":"bhouston","type":"User","id":588541,"followers_url":"https:\/\/api.github.com\/users\/bhouston\/followers","organizations_url":"https:\/\/api.github.com\/users\/bhouston\/orgs"}},{"index":26,"author_association":"COLLABORATOR","body":"@bhouston Even though what you are doing is not mathematically correct -- the only thing that is correct is\n\n```\nalbedo( \u03c9i ) = \u222b fr( \u03c9o, \u03c9i ) cos( \u03b8o ) d\u03c9o \n```\n\n-- our model does not handle 2nd bounces, so energy is lost. So the truth is somewhere in the middle.\n\nThe approach I have described, which is consistent with our model, will show less of an effect than your approach will. You may not like it if you are used to what you have implemented in-house. We can always change it later. Every implementation is a compromise. : - )\n","created_at":"2016-06-27T19:49:53.000Z","html_url":"https:\/\/github.com\/mrdoob\/three.js\/pull\/9038#issuecomment-228854906","id":228854906,"issue_url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/9038","node_id":"MDEyOklzc3VlQ29tbWVudDIyODg1NDkwNg==","updated_at":"2016-06-27T19:49:53.000Z","url":"https:\/\/api.github.com\/repos\/mrdoob\/three.js\/issues\/comments\/228854906","user":{"following_url":"https:\/\/api.github.com\/users\/WestLangley\/following{\/other_user}","events_url":"https:\/\/api.github.com\/users\/WestLangley\/events{\/privacy}","avatar_url":"https:\/\/avatars2.githubusercontent.com\/u\/1000017?v=4","url":"https:\/\/api.github.com\/users\/WestLangley","gists_url":"https:\/\/api.github.com\/users\/WestLangley\/gists{\/gist_id}","html_url":"https:\/\/github.com\/WestLangley","subscriptions_url":"https:\/\/api.github.com\/users\/WestLangley\/subscriptions","node_id":"MDQ6VXNlcjEwMDAwMTc=","repos_url":"https:\/\/api.github.com\/users\/WestLangley\/repos","received_events_url":"https:\/\/api.github.com\/users\/WestLangley\/received_events","gravatar_id":"","starred_url":"https:\/\/api.github.com\/users\/WestLangley\/starred{\/owner}{\/repo}","site_admin":false,"login":"WestLangley","type":"User","id":1000017,"followers_url":"https:\/\/api.github.com\/users\/WestLangley\/followers","organizations_url":"https:\/\/api.github.com\/users\/WestLangley\/orgs"}}]}