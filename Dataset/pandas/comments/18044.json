[
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/340659395",
    "html_url": "https://github.com/pandas-dev/pandas/issues/18044#issuecomment-340659395",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/18044",
    "id": 340659395,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MDY1OTM5NQ==",
    "user": {
      "login": "gfyoung",
      "id": 9273653,
      "node_id": "MDQ6VXNlcjkyNzM2NTM=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/9273653?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gfyoung",
      "html_url": "https://github.com/gfyoung",
      "followers_url": "https://api.github.com/users/gfyoung/followers",
      "following_url": "https://api.github.com/users/gfyoung/following{/other_user}",
      "gists_url": "https://api.github.com/users/gfyoung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gfyoung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gfyoung/subscriptions",
      "organizations_url": "https://api.github.com/users/gfyoung/orgs",
      "repos_url": "https://api.github.com/users/gfyoung/repos",
      "events_url": "https://api.github.com/users/gfyoung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gfyoung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-10-31T04:51:25Z",
    "updated_at": "2017-10-31T04:51:29Z",
    "author_association": "MEMBER",
    "body": "@ogotaiking : Thanks for reporting this!  For reference, do you mind posting the expected results too?"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/340896897",
    "html_url": "https://github.com/pandas-dev/pandas/issues/18044#issuecomment-340896897",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/18044",
    "id": 340896897,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MDg5Njg5Nw==",
    "user": {
      "login": "selik",
      "id": 1328688,
      "node_id": "MDQ6VXNlcjEzMjg2ODg=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/1328688?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/selik",
      "html_url": "https://github.com/selik",
      "followers_url": "https://api.github.com/users/selik/followers",
      "following_url": "https://api.github.com/users/selik/following{/other_user}",
      "gists_url": "https://api.github.com/users/selik/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/selik/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/selik/subscriptions",
      "organizations_url": "https://api.github.com/users/selik/orgs",
      "repos_url": "https://api.github.com/users/selik/repos",
      "events_url": "https://api.github.com/users/selik/events{/privacy}",
      "received_events_url": "https://api.github.com/users/selik/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-10-31T20:29:32Z",
    "updated_at": "2017-10-31T20:31:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "@gfyoung The skew of a uniform distribution is zero. The kurtosis of the uniform distribution could be -6/5, depending on how you define it. While @ogotaiking says the kurtosis is calculated correctly in the non-rolling case, it's returning zero for me, so that might not be what's desired."
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/340965100",
    "html_url": "https://github.com/pandas-dev/pandas/issues/18044#issuecomment-340965100",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/18044",
    "id": 340965100,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MDk2NTEwMA==",
    "user": {
      "login": "zartbot",
      "id": 5242614,
      "node_id": "MDQ6VXNlcjUyNDI2MTQ=",
      "avatar_url": "https://avatars2.githubusercontent.com/u/5242614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zartbot",
      "html_url": "https://github.com/zartbot",
      "followers_url": "https://api.github.com/users/zartbot/followers",
      "following_url": "https://api.github.com/users/zartbot/following{/other_user}",
      "gists_url": "https://api.github.com/users/zartbot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zartbot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zartbot/subscriptions",
      "organizations_url": "https://api.github.com/users/zartbot/orgs",
      "repos_url": "https://api.github.com/users/zartbot/repos",
      "events_url": "https://api.github.com/users/zartbot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zartbot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-01T03:02:03Z",
    "updated_at": "2017-11-01T03:02:03Z",
    "author_association": "CONTRIBUTOR",
    "body": "\r\nThe issue would be variance numerically unstable in \"calc_skew\" ,  the answer will divide by B , but the code only check B<=0,  during rolling,  add_skew/remove_skew may cause B in range(0,1e-9), so after that uniform distribution will get such large number in skew/kurt.\r\n\r\n #6817 from jaimefrio/rolling_var-welford resolve the roll_var stability , but seems it will also import to skew/kurt.\r\n\r\n```python\r\n# Rolling skewness\r\n\r\ncdef inline double calc_skew(int64_t minp, int64_t nobs, double x, double xx,\r\n                             double xxx) nogil:\r\n    cdef double result, dnobs\r\n    cdef double A, B, C, R\r\n\r\n    if nobs >= minp:\r\n        dnobs = <double>nobs\r\n        A = x / dnobs\r\n        B = xx / dnobs - A * A\r\n        C = xxx / dnobs - A * A * A - 3 * A * B\r\n        if B <= 0 or nobs < 3: <-- B's precision has some issue cause uniform distribution not be ZERO\r\n            result = NaN\r\n        else:\r\n            R = sqrt(B)\r\n            result = ((sqrt(dnobs * (dnobs - 1.)) * C) /\r\n                      ((dnobs - 2) * R * R * R))  <-- here will divde 1e-N\r\n    else:\r\n        result = NaN\r\n\r\n    return result\r\n```"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/341004811",
    "html_url": "https://github.com/pandas-dev/pandas/issues/18044#issuecomment-341004811",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/18044",
    "id": 341004811,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MTAwNDgxMQ==",
    "user": {
      "login": "zartbot",
      "id": 5242614,
      "node_id": "MDQ6VXNlcjUyNDI2MTQ=",
      "avatar_url": "https://avatars2.githubusercontent.com/u/5242614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zartbot",
      "html_url": "https://github.com/zartbot",
      "followers_url": "https://api.github.com/users/zartbot/followers",
      "following_url": "https://api.github.com/users/zartbot/following{/other_user}",
      "gists_url": "https://api.github.com/users/zartbot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zartbot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zartbot/subscriptions",
      "organizations_url": "https://api.github.com/users/zartbot/orgs",
      "repos_url": "https://api.github.com/users/zartbot/repos",
      "events_url": "https://api.github.com/users/zartbot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zartbot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-01T06:50:15Z",
    "updated_at": "2017-11-01T15:40:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "in pandas/_libs/window.pyx\r\nRCA(Root Cause Analysis):\r\nfor uniform distribution, all values are eq.\r\nfunction roll_skew will continues  call add_skew / remove_skew.\r\n\r\n```python\r\nxx  += val * val\r\nxx -= prev* prev\r\n```\r\nbut during rolling, it will cause numerically unstable in xx, \r\npreviously suggest is a bad fix\r\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/341032761",
    "html_url": "https://github.com/pandas-dev/pandas/issues/18044#issuecomment-341032761",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/18044",
    "id": 341032761,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MTAzMjc2MQ==",
    "user": {
      "login": "gfyoung",
      "id": 9273653,
      "node_id": "MDQ6VXNlcjkyNzM2NTM=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/9273653?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gfyoung",
      "html_url": "https://github.com/gfyoung",
      "followers_url": "https://api.github.com/users/gfyoung/followers",
      "following_url": "https://api.github.com/users/gfyoung/following{/other_user}",
      "gists_url": "https://api.github.com/users/gfyoung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gfyoung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gfyoung/subscriptions",
      "organizations_url": "https://api.github.com/users/gfyoung/orgs",
      "repos_url": "https://api.github.com/users/gfyoung/repos",
      "events_url": "https://api.github.com/users/gfyoung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gfyoung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-01T08:30:23Z",
    "updated_at": "2017-11-01T08:30:23Z",
    "author_association": "MEMBER",
    "body": "@ogotaiking : Cool!  Feel free to propose changes in a PR and add a test or two to confirm.  We can look at it in more detail there."
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/341145642",
    "html_url": "https://github.com/pandas-dev/pandas/issues/18044#issuecomment-341145642",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/18044",
    "id": 341145642,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM0MTE0NTY0Mg==",
    "user": {
      "login": "zartbot",
      "id": 5242614,
      "node_id": "MDQ6VXNlcjUyNDI2MTQ=",
      "avatar_url": "https://avatars2.githubusercontent.com/u/5242614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zartbot",
      "html_url": "https://github.com/zartbot",
      "followers_url": "https://api.github.com/users/zartbot/followers",
      "following_url": "https://api.github.com/users/zartbot/following{/other_user}",
      "gists_url": "https://api.github.com/users/zartbot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/zartbot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/zartbot/subscriptions",
      "organizations_url": "https://api.github.com/users/zartbot/orgs",
      "repos_url": "https://api.github.com/users/zartbot/repos",
      "events_url": "https://api.github.com/users/zartbot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/zartbot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-11-01T15:44:18Z",
    "updated_at": "2017-11-01T15:44:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "@gfyoung\r\n\r\njust did more test, the previous fix does not work in some particular numbers, and check  core/nanops.py,\r\n\r\nduring calculate m2 and m3 , it has the following function to validate the float issue.\r\n\r\n```python\r\n_zero_out_fperr(arg):\r\n    if isinstance(arg, np.ndarray):\r\n        with np.errstate(invalid='ignore'):\r\n            return np.where(np.abs(arg) < 1e-14, 0, arg)\r\n    else:\r\n        return arg.dtype.type(0) if np.abs(arg) < 1e-14 else arg\r\n```\r\n\r\nbut in window.pyx it's a cython code , i am not familiar with it to modify or do such validation.\r\n\r\nI just did some simple change \r\n```diff\r\ndiff --git a/pandas/_libs/window.pyx b/pandas/_libs/window.pyx\r\nindex b6bd6f9..64a1a40 100644\r\n--- a/pandas/_libs/window.pyx\r\n+++ b/pandas/_libs/window.pyx\r\n@@ -788,7 +788,7 @@ cdef inline double calc_skew(int64_t minp, int64_t nobs, double x, double xx,\r\n         A = x / dnobs\r\n         B = xx / dnobs - A * A\r\n         C = xxx / dnobs - A * A * A - 3 * A * B\r\n-        if B <= 0 or nobs < 3:\r\n+        if B <= 1e-14 or nobs < 3:\r\n             result = NaN\r\n         else:\r\n             R = sqrt(B)\r\n@@ -915,7 +915,7 @@ cdef inline double calc_kurt(int64_t minp, int64_t nobs, double x, double xx,\r\n         R = R * A\r\n         D = xxxx / dnobs - R - 6 * B * A * A - 4 * C * A\r\n \r\n-        if B == 0 or nobs < 4:\r\n+        if B <= 1e-14 or nobs < 4:\r\n             result = NaN\r\n         else:\r\n             K = (dnobs * dnobs - 1.) * D / (B * B) - 3 * ((dnobs - 1.) ** 2)\r\n```\r\n\r\nand I did more test on random numbers with uniform distribution \r\n```python\r\nc=0.0\r\nfor i in range(0,10000):\r\n    a = pd.Series([np.random.rand(1)]*30)\r\n    b=max(a.rolling(10).skew().fillna(0))\r\n    if b > c :\r\n        c = b\r\n```\r\nthe result looks good , after try 10000 random numbers , c still eq zero.\r\nand also check random distribution skew:\r\n```python\r\ntc=0.0\r\nfor i in range(0,10000):\r\n    test=pd.Series(np.random.rand(500))\r\n    aa = test.rolling(10).skew().fillna(0)\r\n    bb = test.rolling(10).apply(lambda x: pd.Series(x).skew()).fillna(0)\r\n    cc = max(aa - bb)\r\n    if cc > tc:\r\n        tc = cc\r\ntc\r\n```\r\nthe max diff between rolling_skew and nanops.nanskew is : 1.0452083643031074e-11\r\n\r\n\r\n\r\n"
  }
]
