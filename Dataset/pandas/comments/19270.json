[
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/358039079",
    "html_url": "https://github.com/pandas-dev/pandas/issues/19270#issuecomment-358039079",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/19270",
    "id": 358039079,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1ODAzOTA3OQ==",
    "user": {
      "login": "jkornblum",
      "id": 5368903,
      "node_id": "MDQ6VXNlcjUzNjg5MDM=",
      "avatar_url": "https://avatars2.githubusercontent.com/u/5368903?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jkornblum",
      "html_url": "https://github.com/jkornblum",
      "followers_url": "https://api.github.com/users/jkornblum/followers",
      "following_url": "https://api.github.com/users/jkornblum/following{/other_user}",
      "gists_url": "https://api.github.com/users/jkornblum/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jkornblum/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jkornblum/subscriptions",
      "organizations_url": "https://api.github.com/users/jkornblum/orgs",
      "repos_url": "https://api.github.com/users/jkornblum/repos",
      "events_url": "https://api.github.com/users/jkornblum/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jkornblum/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-16T17:27:49Z",
    "updated_at": "2018-01-16T17:27:49Z",
    "author_association": "NONE",
    "body": "Hey @TomAugspurger do you need additional information from me on this problem?"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/358040567",
    "html_url": "https://github.com/pandas-dev/pandas/issues/19270#issuecomment-358040567",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/19270",
    "id": 358040567,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1ODA0MDU2Nw==",
    "user": {
      "login": "TomAugspurger",
      "id": 1312546,
      "node_id": "MDQ6VXNlcjEzMTI1NDY=",
      "avatar_url": "https://avatars3.githubusercontent.com/u/1312546?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TomAugspurger",
      "html_url": "https://github.com/TomAugspurger",
      "followers_url": "https://api.github.com/users/TomAugspurger/followers",
      "following_url": "https://api.github.com/users/TomAugspurger/following{/other_user}",
      "gists_url": "https://api.github.com/users/TomAugspurger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TomAugspurger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TomAugspurger/subscriptions",
      "organizations_url": "https://api.github.com/users/TomAugspurger/orgs",
      "repos_url": "https://api.github.com/users/TomAugspurger/repos",
      "events_url": "https://api.github.com/users/TomAugspurger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TomAugspurger/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-16T17:32:07Z",
    "updated_at": "2018-01-16T17:32:07Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yep, a reproducible example if you're able to.\n\nOn Tue, Jan 16, 2018 at 11:27 AM, Joshua Kornblum <notifications@github.com>\nwrote:\n\n> Hey @TomAugspurger <https://github.com/tomaugspurger> do you need\n> additional information from me on this problem?\n>\n> —\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/pandas-dev/pandas/issues/19270#issuecomment-358039079>,\n> or mute the thread\n> <https://github.com/notifications/unsubscribe-auth/ABQHIhfdlT9M14xt4xM5hoQIy5vlhJ-qks5tLNwagaJpZM4RgDGR>\n> .\n>\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/358054422",
    "html_url": "https://github.com/pandas-dev/pandas/issues/19270#issuecomment-358054422",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/19270",
    "id": 358054422,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1ODA1NDQyMg==",
    "user": {
      "login": "jkornblum",
      "id": 5368903,
      "node_id": "MDQ6VXNlcjUzNjg5MDM=",
      "avatar_url": "https://avatars2.githubusercontent.com/u/5368903?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jkornblum",
      "html_url": "https://github.com/jkornblum",
      "followers_url": "https://api.github.com/users/jkornblum/followers",
      "following_url": "https://api.github.com/users/jkornblum/following{/other_user}",
      "gists_url": "https://api.github.com/users/jkornblum/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jkornblum/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jkornblum/subscriptions",
      "organizations_url": "https://api.github.com/users/jkornblum/orgs",
      "repos_url": "https://api.github.com/users/jkornblum/repos",
      "events_url": "https://api.github.com/users/jkornblum/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jkornblum/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-16T18:12:45Z",
    "updated_at": "2018-01-16T18:12:45Z",
    "author_association": "NONE",
    "body": "Using attached csv file this will reproduce\r\n\r\n```python\r\n(pd.read_csv('jmk_gh_ex.txt')\r\n .pipe(filter_non_electrical_tests)\r\n .groupby('test_name').apply(filter_outlier_robust_simga).reset_index(drop=True)\r\n .groupby('test_name')['value'].mean()\r\n)\r\n```\r\n\r\nAnd this will give you the correct output\r\n\r\n```python\r\n(pd.read_csv('jmk_gh_ex.txt')\r\n .groupby('test_name').apply(filter_outlier_robust_simga).reset_index(drop=True)\r\n .pipe(filter_non_electrical_tests)\r\n .groupby('test_name')['value'].mean()\r\n)\r\n```\r\nThe other needed functions are in my original question\r\n\r\n[jmk_gh_ex.txt](https://github.com/pandas-dev/pandas/files/1636262/jmk_gh_ex.txt)\r\n\r\n\r\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/358055297",
    "html_url": "https://github.com/pandas-dev/pandas/issues/19270#issuecomment-358055297",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/19270",
    "id": 358055297,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1ODA1NTI5Nw==",
    "user": {
      "login": "TomAugspurger",
      "id": 1312546,
      "node_id": "MDQ6VXNlcjEzMTI1NDY=",
      "avatar_url": "https://avatars3.githubusercontent.com/u/1312546?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TomAugspurger",
      "html_url": "https://github.com/TomAugspurger",
      "followers_url": "https://api.github.com/users/TomAugspurger/followers",
      "following_url": "https://api.github.com/users/TomAugspurger/following{/other_user}",
      "gists_url": "https://api.github.com/users/TomAugspurger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TomAugspurger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TomAugspurger/subscriptions",
      "organizations_url": "https://api.github.com/users/TomAugspurger/orgs",
      "repos_url": "https://api.github.com/users/TomAugspurger/repos",
      "events_url": "https://api.github.com/users/TomAugspurger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TomAugspurger/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-16T18:15:19Z",
    "updated_at": "2018-01-16T18:15:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "Any chance you could narrow it down to something simpler that reproduces\nthe buggy behavior?\nIf this is a bug, we'll need a unit test for it, and we don't want to read\nin a CSV for the test.\n\nOn Tue, Jan 16, 2018 at 12:12 PM, Joshua Kornblum <notifications@github.com>\nwrote:\n\n> Using attached csv file this will reproduce\n>\n> (pd.read_csv('jmk_gh_ex.txt')\n>  .pipe(filter_non_electrical_tests)\n>  .groupby('test_name').apply(filter_outlier_robust_simga).reset_index(drop=True)\n>  .groupby('test_name')['value'].mean()\n> )\n>\n> And this will give you the correct output\n>\n> (pd.read_csv('jmk_gh_ex.txt')\n>  .groupby('test_name').apply(filter_outlier_robust_simga).reset_index(drop=True)\n>  .pipe(filter_non_electrical_tests)\n>  .groupby('test_name')['value'].mean()\n> )\n>\n> The other needed functions are in my original question\n>\n> jmk_gh_ex.txt\n> <https://github.com/pandas-dev/pandas/files/1636262/jmk_gh_ex.txt>\n>\n> —\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/pandas-dev/pandas/issues/19270#issuecomment-358054422>,\n> or mute the thread\n> <https://github.com/notifications/unsubscribe-auth/ABQHIpk3420AIzV8LHX4Q0BSOYE2gGH7ks5tLOahgaJpZM4RgDGR>\n> .\n>\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/358091552",
    "html_url": "https://github.com/pandas-dev/pandas/issues/19270#issuecomment-358091552",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/19270",
    "id": 358091552,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM1ODA5MTU1Mg==",
    "user": {
      "login": "jkornblum",
      "id": 5368903,
      "node_id": "MDQ6VXNlcjUzNjg5MDM=",
      "avatar_url": "https://avatars2.githubusercontent.com/u/5368903?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jkornblum",
      "html_url": "https://github.com/jkornblum",
      "followers_url": "https://api.github.com/users/jkornblum/followers",
      "following_url": "https://api.github.com/users/jkornblum/following{/other_user}",
      "gists_url": "https://api.github.com/users/jkornblum/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jkornblum/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jkornblum/subscriptions",
      "organizations_url": "https://api.github.com/users/jkornblum/orgs",
      "repos_url": "https://api.github.com/users/jkornblum/repos",
      "events_url": "https://api.github.com/users/jkornblum/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jkornblum/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-01-16T20:18:43Z",
    "updated_at": "2018-01-16T20:38:46Z",
    "author_association": "NONE",
    "body": "Sure playing around with this I couldn't exactly replicate my previous behavior where switching order gave the correct result but I did come up with same error. It seems to be tied to datatype and adding columns in `groupby().apply()` e.g. if you change the `np.linspace` stuff to `range(20)` it works fine in all conditions. \r\n\r\nI am changing the width of dataframe on `groupby().apply()` which maybe is no-no?\r\n\r\nWhen I change width of `groupby().apply()` dataframe it incorrectly repeats `float` columns for first group. I do not observe this behavior with `int` data.\r\n\r\n```python\r\nimport pandas as pd\r\nimport numpy as np\r\n\r\ndef filter_outlier_robust_simga(grp):\r\n    q1 = grp.value.quantile(.25)\r\n    q3 = grp.value.quantile(.75)\r\n    iqr = q3 - q1\r\n    f = 3.948  # robust 6 sigma f value\r\n\r\n    lol = q1 - f*iqr  # lower outlier limit\r\n    uol = q3 + f*iqr  # upper outlier limit\r\n\r\n    grp['lol'] = lol\r\n    grp['uol'] = uol\r\n\r\n    fil = (grp.value < uol) & (grp.value > lol)\r\n\r\n    return grp[fil]\r\n\r\ndef filter_a_d_tests(df):\r\n    return df[~df['test_name'].isin([\"a\", \"d\"])]\r\n\r\ndf = pd.DataFrame({\r\n        'value': np.append(np.linspace(10, 15, 10), np.linspace(20, 25, 10)),\r\n        'test_name': list(\"a\"*5 + \"b\"*5 + \"c\"*5 + \"d\"*5)})\r\n\r\n# 1 - This will give mean for b and d to be ~13.9 which is correct for b not d\r\n(df.pipe(filter_a_d_tests)\r\n   .groupby('test_name').apply(filter_outlier_robust_simga).reset_index(drop=True)\r\n   .groupby('test_name')['value'].mean())\r\n\r\n# 2 - This will give mean for b and d to be ~11.1 which is correct for a not b or d\r\n(df.groupby('test_name').apply(filter_outlier_robust_simga).reset_index(drop=True)\r\n   .pipe(filter_a_d_tests)\r\n   .groupby('test_name')['value'].mean())\r\n\r\n# 3- If I don't include the pipe(filter) step than it gives correct mean for a, b, c, and d\r\n(df.groupby('test_name').apply(filter_outlier_robust_simga).reset_index(drop=True)\r\n   .groupby('test_name')['value'].mean())\r\n\r\n# 4 - The result of this line is a dataframe where test_name is correct but value, uol, lol columns\r\n# for a, b, c, and d are a repeat of a\r\n(df.groupby('test_name').apply(filter_outlier_robust_simga).reset_index(drop=True))\r\n\r\n# 5 - If I add the uol and lol columns before the groupby-apply then everything works\r\ndf['uol'] = np.nan  # if you make this int it still breaks\r\ndf['lol'] = np.nan  # if you make this int it still breaks\r\n\r\n(df.groupby('test_name').apply(filter_outlier_robust_simga).reset_index(drop=True)\r\n   .pipe(filter_a_d_tests)\r\n   .groupby('test_name')['value'].mean())\r\n```"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/400701861",
    "html_url": "https://github.com/pandas-dev/pandas/issues/19270#issuecomment-400701861",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/19270",
    "id": 400701861,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwMDcwMTg2MQ==",
    "user": {
      "login": "TomAugspurger",
      "id": 1312546,
      "node_id": "MDQ6VXNlcjEzMTI1NDY=",
      "avatar_url": "https://avatars3.githubusercontent.com/u/1312546?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TomAugspurger",
      "html_url": "https://github.com/TomAugspurger",
      "followers_url": "https://api.github.com/users/TomAugspurger/followers",
      "following_url": "https://api.github.com/users/TomAugspurger/following{/other_user}",
      "gists_url": "https://api.github.com/users/TomAugspurger/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TomAugspurger/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TomAugspurger/subscriptions",
      "organizations_url": "https://api.github.com/users/TomAugspurger/orgs",
      "repos_url": "https://api.github.com/users/TomAugspurger/repos",
      "events_url": "https://api.github.com/users/TomAugspurger/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TomAugspurger/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-27T14:52:59Z",
    "updated_at": "2018-06-27T14:52:59Z",
    "author_association": "CONTRIBUTOR",
    "body": "@jkornblum could you update the original post with your example?\r\n\r\nIt'd be best to narrow things down to the smallest possible single example, and then just show the actual output and the expected output.\r\n\r\nDid you make any progress on debugging this?\r\n\r\nYou try copying the dataframe before modifying it in `apply`, though I don't think that should matter."
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/400905241",
    "html_url": "https://github.com/pandas-dev/pandas/issues/19270#issuecomment-400905241",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/19270",
    "id": 400905241,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwMDkwNTI0MQ==",
    "user": {
      "login": "jkornblum",
      "id": 5368903,
      "node_id": "MDQ6VXNlcjUzNjg5MDM=",
      "avatar_url": "https://avatars2.githubusercontent.com/u/5368903?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jkornblum",
      "html_url": "https://github.com/jkornblum",
      "followers_url": "https://api.github.com/users/jkornblum/followers",
      "following_url": "https://api.github.com/users/jkornblum/following{/other_user}",
      "gists_url": "https://api.github.com/users/jkornblum/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jkornblum/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jkornblum/subscriptions",
      "organizations_url": "https://api.github.com/users/jkornblum/orgs",
      "repos_url": "https://api.github.com/users/jkornblum/repos",
      "events_url": "https://api.github.com/users/jkornblum/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jkornblum/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-06-28T04:12:37Z",
    "updated_at": "2018-06-28T04:12:37Z",
    "author_association": "NONE",
    "body": "It's been a bit since I've looked at this. \r\nLet me try to dig back in tomorrow. \r\nI'll edit my posts here."
  }
]
