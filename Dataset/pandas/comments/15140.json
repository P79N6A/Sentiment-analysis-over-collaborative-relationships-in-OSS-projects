[
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/272782423",
    "html_url": "https://github.com/pandas-dev/pandas/issues/15140#issuecomment-272782423",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/15140",
    "id": 272782423,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI3Mjc4MjQyMw==",
    "user": {
      "login": "Rufflewind",
      "id": 6571068,
      "node_id": "MDQ6VXNlcjY1NzEwNjg=",
      "avatar_url": "https://avatars3.githubusercontent.com/u/6571068?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Rufflewind",
      "html_url": "https://github.com/Rufflewind",
      "followers_url": "https://api.github.com/users/Rufflewind/followers",
      "following_url": "https://api.github.com/users/Rufflewind/following{/other_user}",
      "gists_url": "https://api.github.com/users/Rufflewind/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Rufflewind/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Rufflewind/subscriptions",
      "organizations_url": "https://api.github.com/users/Rufflewind/orgs",
      "repos_url": "https://api.github.com/users/Rufflewind/repos",
      "events_url": "https://api.github.com/users/Rufflewind/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Rufflewind/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-01-16T06:20:17Z",
    "updated_at": "2017-01-16T06:38:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "It appears to have died [while trying to read the thread state](https://github.com/python/cpython/blob/a967fce5f634e5c90e3951887d27cfd3bb70e2f2/Python/errors.c#L42):\r\n\r\n~~~c\r\noldtype = tstate->curexc_type;\r\n~~~\r\n\r\n`tstate` is null because [the global interpreter lock has been released](https://github.com/pandas-dev/pandas/blob/52aee10acc390fc230eead4287e3341692a3500a/pandas/src/parser/tokenizer.c#L2292-L2300):\r\n\r\n~~~py\r\nwith nogil:\r\n    error = _try_double_nogil(parser, col, line_start, line_end,\r\n                              na_filter, na_hashset, use_na_flist,\r\n                              na_fset, NA, data, &na_count)\r\n~~~\r\n\r\nThis is problematic, as the `round_trip` converter does [call back into Python](https://github.com/pandas-dev/pandas/blob/52aee10acc390fc230eead4287e3341692a3500a/pandas/src/parser/tokenizer.c#L1774-L1781):\r\n\r\n~~~c\r\ndouble round_trip(const char *p, char **q, char decimal, char sci, char tsep,\r\n                  int skip_trailing) {\r\n#if PY_VERSION_HEX >= 0x02070000\r\n    return PyOS_string_to_double(p, q, 0);\r\n#else\r\n    return strtod(p, q);\r\n#endif\r\n}\r\n~~~\r\n\r\nThe funny thing is that even if I delete `with nogil:`, it still fails with a Python exception, because the code in [_try_double_nogil](https://github.com/pandas-dev/pandas/blob/7ad6c65c3ce6c8fd5e3b82306c028d4fb115483c/pandas/parser.pyx#L1744) was never even designed to handle Python exceptions to begin with."
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/272783915",
    "html_url": "https://github.com/pandas-dev/pandas/issues/15140#issuecomment-272783915",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/15140",
    "id": 272783915,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI3Mjc4MzkxNQ==",
    "user": {
      "login": "Rufflewind",
      "id": 6571068,
      "node_id": "MDQ6VXNlcjY1NzEwNjg=",
      "avatar_url": "https://avatars3.githubusercontent.com/u/6571068?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Rufflewind",
      "html_url": "https://github.com/Rufflewind",
      "followers_url": "https://api.github.com/users/Rufflewind/followers",
      "following_url": "https://api.github.com/users/Rufflewind/following{/other_user}",
      "gists_url": "https://api.github.com/users/Rufflewind/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Rufflewind/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Rufflewind/subscriptions",
      "organizations_url": "https://api.github.com/users/Rufflewind/orgs",
      "repos_url": "https://api.github.com/users/Rufflewind/repos",
      "events_url": "https://api.github.com/users/Rufflewind/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Rufflewind/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-01-16T06:32:26Z",
    "updated_at": "2017-01-16T06:32:26Z",
    "author_association": "CONTRIBUTOR",
    "body": "This appears to work around the problem (kept the GIL and silenced the Python exception):\r\n\r\n~~~diff\r\ndiff --git a/pandas/parser.pyx b/pandas/parser.pyx\r\nindex bd793c98e..dc0292e5b 100644\r\n--- a/pandas/parser.pyx\r\n+++ b/pandas/parser.pyx\r\n@@ -1699,10 +1699,9 @@ cdef _try_double(parser_t *parser, int col, int line_start, int line_end,\r\n     result = np.empty(lines, dtype=np.float64)\r\n     data = <double *> result.data\r\n     na_fset = kset_float64_from_list(na_flist)\r\n-    with nogil:\r\n-        error = _try_double_nogil(parser, col, line_start, line_end,\r\n-                                  na_filter, na_hashset, use_na_flist,\r\n-                                  na_fset, NA, data, &na_count)\r\n+    error = _try_double_nogil(parser, col, line_start, line_end,\r\n+                              na_filter, na_hashset, use_na_flist,\r\n+                              na_fset, NA, data, &na_count)\r\n     kh_destroy_float64(na_fset)\r\n     if error != 0:\r\n         return None, None\r\ndiff --git a/pandas/src/parser/tokenizer.c b/pandas/src/parser/tokenizer.c\r\nindex 87e17fe5f..77c36ef8a 100644\r\n--- a/pandas/src/parser/tokenizer.c\r\n+++ b/pandas/src/parser/tokenizer.c\r\n@@ -1774,7 +1774,9 @@ double precise_xstrtod(const char *str, char **endptr, char decimal, char sci,\r\n double round_trip(const char *p, char **q, char decimal, char sci, char tsep,\r\n                   int skip_trailing) {\r\n #if PY_VERSION_HEX >= 0x02070000\r\n-    return PyOS_string_to_double(p, q, 0);\r\n+    double r = PyOS_string_to_double(p, q, 0);\r\n+    PyErr_Clear();\r\n+    return r;\r\n #else\r\n     return strtod(p, q);\r\n #endif\r\n~~~"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/273150755",
    "html_url": "https://github.com/pandas-dev/pandas/issues/15140#issuecomment-273150755",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/15140",
    "id": 273150755,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI3MzE1MDc1NQ==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-01-17T13:12:05Z",
    "updated_at": "2017-01-17T13:12:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "yeah this looks to be violating gil holding. Welcome for you to add a test / fix.\r\n\r\nprob simply best just hold the gil if float precision is specified, since this is not the default."
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/273300161",
    "html_url": "https://github.com/pandas-dev/pandas/issues/15140#issuecomment-273300161",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/15140",
    "id": 273300161,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI3MzMwMDE2MQ==",
    "user": {
      "login": "Rufflewind",
      "id": 6571068,
      "node_id": "MDQ6VXNlcjY1NzEwNjg=",
      "avatar_url": "https://avatars3.githubusercontent.com/u/6571068?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Rufflewind",
      "html_url": "https://github.com/Rufflewind",
      "followers_url": "https://api.github.com/users/Rufflewind/followers",
      "following_url": "https://api.github.com/users/Rufflewind/following{/other_user}",
      "gists_url": "https://api.github.com/users/Rufflewind/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Rufflewind/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Rufflewind/subscriptions",
      "organizations_url": "https://api.github.com/users/Rufflewind/orgs",
      "repos_url": "https://api.github.com/users/Rufflewind/repos",
      "events_url": "https://api.github.com/users/Rufflewind/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Rufflewind/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-01-17T21:09:15Z",
    "updated_at": "2017-01-17T21:09:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "I made a pull request here: https://github.com/pandas-dev/pandas/pull/15148"
  }
]
