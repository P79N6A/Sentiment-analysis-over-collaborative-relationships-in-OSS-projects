[
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/415952557",
    "html_url": "https://github.com/pandas-dev/pandas/issues/22501#issuecomment-415952557",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/22501",
    "id": 415952557,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNTk1MjU1Nw==",
    "user": {
      "login": "gfyoung",
      "id": 9273653,
      "node_id": "MDQ6VXNlcjkyNzM2NTM=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/9273653?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gfyoung",
      "html_url": "https://github.com/gfyoung",
      "followers_url": "https://api.github.com/users/gfyoung/followers",
      "following_url": "https://api.github.com/users/gfyoung/following{/other_user}",
      "gists_url": "https://api.github.com/users/gfyoung/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gfyoung/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gfyoung/subscriptions",
      "organizations_url": "https://api.github.com/users/gfyoung/orgs",
      "repos_url": "https://api.github.com/users/gfyoung/repos",
      "events_url": "https://api.github.com/users/gfyoung/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gfyoung/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-25T08:17:46Z",
    "updated_at": "2018-08-25T08:17:46Z",
    "author_association": "MEMBER",
    "body": "@kmax12 : That indeed looks buggy to me!  Investigation and patch are welcome!\r\n\r\nOne quick thing: mind posting what you get as output on the last merge?"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/415982538",
    "html_url": "https://github.com/pandas-dev/pandas/issues/22501#issuecomment-415982538",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/22501",
    "id": 415982538,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNTk4MjUzOA==",
    "user": {
      "login": "kmax12",
      "id": 371792,
      "node_id": "MDQ6VXNlcjM3MTc5Mg==",
      "avatar_url": "https://avatars1.githubusercontent.com/u/371792?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kmax12",
      "html_url": "https://github.com/kmax12",
      "followers_url": "https://api.github.com/users/kmax12/followers",
      "following_url": "https://api.github.com/users/kmax12/following{/other_user}",
      "gists_url": "https://api.github.com/users/kmax12/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kmax12/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kmax12/subscriptions",
      "organizations_url": "https://api.github.com/users/kmax12/orgs",
      "repos_url": "https://api.github.com/users/kmax12/repos",
      "events_url": "https://api.github.com/users/kmax12/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kmax12/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-25T16:56:09Z",
    "updated_at": "2018-08-25T16:56:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "@gfyoung updated with the stack trace of the error on the last merge. \r\n\r\nI will investigate around and see if I can figure it out"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/417143010",
    "html_url": "https://github.com/pandas-dev/pandas/issues/22501#issuecomment-417143010",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/22501",
    "id": 417143010,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNzE0MzAxMA==",
    "user": {
      "login": "kmax12",
      "id": 371792,
      "node_id": "MDQ6VXNlcjM3MTc5Mg==",
      "avatar_url": "https://avatars1.githubusercontent.com/u/371792?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kmax12",
      "html_url": "https://github.com/kmax12",
      "followers_url": "https://api.github.com/users/kmax12/followers",
      "following_url": "https://api.github.com/users/kmax12/following{/other_user}",
      "gists_url": "https://api.github.com/users/kmax12/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kmax12/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kmax12/subscriptions",
      "organizations_url": "https://api.github.com/users/kmax12/orgs",
      "repos_url": "https://api.github.com/users/kmax12/repos",
      "events_url": "https://api.github.com/users/kmax12/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kmax12/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-29T23:42:31Z",
    "updated_at": "2018-08-29T23:44:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "after some investigation, it noticed that `df3` and `df4` take different code paths due to a monotonic index in `df4` after the categorical values are converted to ints. \r\n\r\nhttps://github.com/pandas-dev/pandas/blob/bf6763458d08067edb43e83caf64661f3b968188/pandas/core/indexes/base.py#L3884\r\n\r\nBased on this observation, I was able to create a more minimal example to reproduce the same error as above that uses just one set of categories.\r\n\r\n```\r\nimport pandas as pd\r\nfrom pandas.api.types import CategoricalDtype\r\n\r\ncat_type1 = CategoricalDtype(categories=[\"a\", \"b\", \"c\"], ordered=False)\r\n\r\n# Test Data\r\ndf1 = pd.DataFrame({\r\n    'foo': pd.Series([\"a\", \"b\"]).astype(cat_type1),\r\n    'left': [1, 2],\r\n}).set_index(\"foo\")\r\n\r\ndf2 = pd.DataFrame({\r\n    'foo': pd.Series([\"a\", \"b\", \"c\"]).astype(cat_type1),\r\n    'right': [3, 2, 1],\r\n}).set_index(\"foo\")\r\n\r\ndf1.merge(df2, left_index=True, right_index=True)\r\n```\r\n\r\nand the error is \r\n\r\n```\r\n/Users/kanter/Documents/pandas/pandas/core/indexes/base.py in join(self, other, how, level, return_indexers, sort)\r\n   3882             try:\r\n   3883                 return self._join_monotonic(other, how=how,\r\n-> 3884                                             return_indexers=return_indexers)\r\n   3885             except TypeError:\r\n   3886                 pass\r\n\r\n/Users/kanter/Documents/pandas/pandas/core/indexes/base.py in _join_monotonic(self, other, how, return_indexers)\r\n   4128                 ridx = None\r\n   4129             elif how == 'inner':\r\n-> 4130                 join_index, lidx, ridx = self._inner_indexer(sv, ov)\r\n   4131                 join_index = self._wrap_joined_index(join_index, other)\r\n   4132             elif how == 'outer':\r\n\r\n/Users/kanter/Documents/pandas/pandas/_libs/join_helper.pxi in pandas._libs.join.inner_join_indexer_object()\r\n    922 @cython.wraparound(False)\r\n    923 @cython.boundscheck(False)\r\n--> 924 def inner_join_indexer_object(ndarray[object] left,\r\n    925                                 ndarray[object] right):\r\n    926     \"\"\"\r\n\r\nValueError: Buffer dtype mismatch, expected 'Python object' but got 'signed char'\r\n```\r\n\r\nThe last line in python is\r\n\r\nhttps://github.com/pandas-dev/pandas/blob/bf6763458d08067edb43e83caf64661f3b968188/pandas/core/indexes/base.py#L4131\r\n\r\nsv is `array([0, 1], dtype=int8)`\r\nov is `array([0, 1, 2], dtype=int8)`\r\n\r\nAt this, point I'm not exactly sure what to do fix or how to workaround even. Any suggestions on how to proceed @gfyoung? "
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/467703806",
    "html_url": "https://github.com/pandas-dev/pandas/issues/22501#issuecomment-467703806",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/22501",
    "id": 467703806,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ2NzcwMzgwNg==",
    "user": {
      "login": "jschendel",
      "id": 5332445,
      "node_id": "MDQ6VXNlcjUzMzI0NDU=",
      "avatar_url": "https://avatars3.githubusercontent.com/u/5332445?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jschendel",
      "html_url": "https://github.com/jschendel",
      "followers_url": "https://api.github.com/users/jschendel/followers",
      "following_url": "https://api.github.com/users/jschendel/following{/other_user}",
      "gists_url": "https://api.github.com/users/jschendel/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jschendel/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jschendel/subscriptions",
      "organizations_url": "https://api.github.com/users/jschendel/orgs",
      "repos_url": "https://api.github.com/users/jschendel/repos",
      "events_url": "https://api.github.com/users/jschendel/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jschendel/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-02-27T02:56:23Z",
    "updated_at": "2019-02-27T02:56:23Z",
    "author_association": "MEMBER",
    "body": "This looks to have been fixed in the 0.24.0 release.  Using the second more minimal example:\r\n```python\r\nIn [1]: import pandas as pd\r\n   ...: from pandas.api.types import CategoricalDtype\r\n   ...: pd.__version__\r\nOut[1]: '0.24.0'\r\n\r\nIn [2]: cat_type1 = CategoricalDtype(categories=[\"a\", \"b\", \"c\"], ordered=False)\r\n\r\nIn [3]: df1 = pd.DataFrame({\r\n   ...:     'foo': pd.Series([\"a\", \"b\"]).astype(cat_type1),\r\n   ...:     'left': [1, 2],\r\n   ...: }).set_index(\"foo\")\r\n\r\nIn [4]: df2 = pd.DataFrame({\r\n   ...:     'foo': pd.Series([\"a\", \"b\", \"c\"]).astype(cat_type1),\r\n   ...:     'right': [3, 2, 1],\r\n   ...: }).set_index(\"foo\")\r\n\r\nIn [5]: df1.merge(df2, left_index=True, right_index=True)\r\nOut[5]:\r\n     left  right\r\nfoo\r\na       1      3\r\nb       2      2\r\n```\r\nI've also confirmed that the original example produces the expected output on 0.24.0, and that this is all still working on master.\r\n\r\nI'm not sure which commit was responsible for the fix, but I don't immediately see any tests that recreate the issue.  At this point I think we just need a test for this issue to ensure that there's not a regression."
  }
]
