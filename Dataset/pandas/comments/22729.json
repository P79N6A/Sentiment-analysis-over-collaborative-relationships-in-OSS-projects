[
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/422097039",
    "html_url": "https://github.com/pandas-dev/pandas/issues/22729#issuecomment-422097039",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/22729",
    "id": 422097039,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjA5NzAzOQ==",
    "user": {
      "login": "mroeschke",
      "id": 10647082,
      "node_id": "MDQ6VXNlcjEwNjQ3MDgy",
      "avatar_url": "https://avatars0.githubusercontent.com/u/10647082?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mroeschke",
      "html_url": "https://github.com/mroeschke",
      "followers_url": "https://api.github.com/users/mroeschke/followers",
      "following_url": "https://api.github.com/users/mroeschke/following{/other_user}",
      "gists_url": "https://api.github.com/users/mroeschke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mroeschke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mroeschke/subscriptions",
      "organizations_url": "https://api.github.com/users/mroeschke/orgs",
      "repos_url": "https://api.github.com/users/mroeschke/repos",
      "events_url": "https://api.github.com/users/mroeschke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mroeschke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-17T17:14:16Z",
    "updated_at": "2018-09-17T17:14:16Z",
    "author_association": "MEMBER",
    "body": "Looked at the related thread briefly; how many unique groups are created when `df.groupby([column_id, column_kind])` is called?\r\n\r\nMy guess from the returned stack trace is that `pd.factorize` is trying to create integer labels for each group, and the total number of groups is more that what int64 can represent?"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/422130385",
    "html_url": "https://github.com/pandas-dev/pandas/issues/22729#issuecomment-422130385",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/22729",
    "id": 422130385,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjEzMDM4NQ==",
    "user": {
      "login": "yuval-nardi",
      "id": 34504826,
      "node_id": "MDQ6VXNlcjM0NTA0ODI2",
      "avatar_url": "https://avatars0.githubusercontent.com/u/34504826?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/yuval-nardi",
      "html_url": "https://github.com/yuval-nardi",
      "followers_url": "https://api.github.com/users/yuval-nardi/followers",
      "following_url": "https://api.github.com/users/yuval-nardi/following{/other_user}",
      "gists_url": "https://api.github.com/users/yuval-nardi/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/yuval-nardi/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/yuval-nardi/subscriptions",
      "organizations_url": "https://api.github.com/users/yuval-nardi/orgs",
      "repos_url": "https://api.github.com/users/yuval-nardi/repos",
      "events_url": "https://api.github.com/users/yuval-nardi/events{/privacy}",
      "received_events_url": "https://api.github.com/users/yuval-nardi/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-17T18:56:42Z",
    "updated_at": "2018-09-17T19:08:21Z",
    "author_association": "NONE",
    "body": "@MaxBenChrist @mroeschke \r\nIt fails on `table = hash_klass(size_hint or len(values))`. \r\nWhen I do `hash_klass(363951638*3)` it succeeds:\r\n```\r\n> hash_klass(363951638*3)\r\n<pandas._libs.hashtable.StringHashTable at 0x1227f0cf0>\r\n```\r\nWhen I do  `hash_klass(363951638*7)` it fails:\r\n```\r\n> hash_klass(363951638*7)\r\nTraceback (most recent call last):\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/IPython/core/interactiveshell.py\", line 2910, in run_code\r\n    exec(code_obj, self.user_global_ns, self.user_ns)\r\n  File \"<ipython-input-28-10a57ee47b42>\", line 1, in <module>\r\n    hash_klass(363951638*7)\r\n  File \"pandas/_libs/hashtable_class_helper.pxi\", line 1229, in pandas._libs.hashtable.StringHashTable.__init__\r\nOverflowError: value too large to convert to int\r\n```\r\nThe 3 and 7 here relate to the 3 and 7 columns mentioned in the above tsfresh thread (https://github.com/blue-yonder/tsfresh/issues/418). `363951638` is the number of rows in my `df_rolled` dataframe (also mentioned in the thread).\r\n\r\nAnyhow, it seems that `len(values)` is not the number of unique groups but the number of rows of `df_rolled` times the number of columns to extract. This is also why the extraction succeeded when I did it sequentially, taking 3 columns at a time."
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/422312857",
    "html_url": "https://github.com/pandas-dev/pandas/issues/22729#issuecomment-422312857",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/22729",
    "id": 422312857,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjMxMjg1Nw==",
    "user": {
      "login": "MaxBenChrist",
      "id": 13162426,
      "node_id": "MDQ6VXNlcjEzMTYyNDI2",
      "avatar_url": "https://avatars3.githubusercontent.com/u/13162426?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MaxBenChrist",
      "html_url": "https://github.com/MaxBenChrist",
      "followers_url": "https://api.github.com/users/MaxBenChrist/followers",
      "following_url": "https://api.github.com/users/MaxBenChrist/following{/other_user}",
      "gists_url": "https://api.github.com/users/MaxBenChrist/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MaxBenChrist/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MaxBenChrist/subscriptions",
      "organizations_url": "https://api.github.com/users/MaxBenChrist/orgs",
      "repos_url": "https://api.github.com/users/MaxBenChrist/repos",
      "events_url": "https://api.github.com/users/MaxBenChrist/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MaxBenChrist/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-18T08:56:51Z",
    "updated_at": "2018-09-18T08:57:21Z",
    "author_association": "NONE",
    "body": "@yuval-nardi \r\n\r\nWe internally stack the columns. E.g.\r\n\r\n| id  | x   | y   |\r\n| --- | --- | --- |\r\n| a   | 3   | 10  |\r\n| a   | 4   | 11  |\r\n\r\nbecomes\r\n\r\n| id  | kind | value |\r\n| --- | ---- | ----- |\r\n| a   | x    | 3     |\r\n| a   | x    | 4     |\r\n| a   | y    | 10    |\r\n| a   | y    | 11    |\r\n\r\nin our internal representation.\r\n\r\nHence, we hit `hash_klass(363951638*7)` with the 7 columns. So the maximal number of `pd.factorize` is the issue in this case.\r\n\r\n@mroeschke \r\n\r\nis there any way we can circumvent that threshold or replace the `df.groupby([column_id, column_kind])` with an equivalent expression?\r\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/422466223",
    "html_url": "https://github.com/pandas-dev/pandas/issues/22729#issuecomment-422466223",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/22729",
    "id": 422466223,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjQ2NjIyMw==",
    "user": {
      "login": "mroeschke",
      "id": 10647082,
      "node_id": "MDQ6VXNlcjEwNjQ3MDgy",
      "avatar_url": "https://avatars0.githubusercontent.com/u/10647082?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mroeschke",
      "html_url": "https://github.com/mroeschke",
      "followers_url": "https://api.github.com/users/mroeschke/followers",
      "following_url": "https://api.github.com/users/mroeschke/following{/other_user}",
      "gists_url": "https://api.github.com/users/mroeschke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mroeschke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mroeschke/subscriptions",
      "organizations_url": "https://api.github.com/users/mroeschke/orgs",
      "repos_url": "https://api.github.com/users/mroeschke/repos",
      "events_url": "https://api.github.com/users/mroeschke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mroeschke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-18T16:46:26Z",
    "updated_at": "2018-09-18T16:46:26Z",
    "author_association": "MEMBER",
    "body": "Why does the data need to be pivoted to a long format?\r\n\r\nThe size of the data seem to already be pushing the limits of pandas already unfortunately; I would imagine processing this data need something like dask: http://dask.pydata.org/en/latest/\r\n\r\ncc @jreback "
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/422520889",
    "html_url": "https://github.com/pandas-dev/pandas/issues/22729#issuecomment-422520889",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/22729",
    "id": 422520889,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjUyMDg4OQ==",
    "user": {
      "login": "chris-b1",
      "id": 1924092,
      "node_id": "MDQ6VXNlcjE5MjQwOTI=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/1924092?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chris-b1",
      "html_url": "https://github.com/chris-b1",
      "followers_url": "https://api.github.com/users/chris-b1/followers",
      "following_url": "https://api.github.com/users/chris-b1/following{/other_user}",
      "gists_url": "https://api.github.com/users/chris-b1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chris-b1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chris-b1/subscriptions",
      "organizations_url": "https://api.github.com/users/chris-b1/orgs",
      "repos_url": "https://api.github.com/users/chris-b1/repos",
      "events_url": "https://api.github.com/users/chris-b1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chris-b1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-18T19:34:30Z",
    "updated_at": "2018-09-18T19:34:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "khash, our hash table implementation, uses an 32 bit integer throughout for its sizes.  maybe could change that, but would be quite invasive.\r\n\r\nBut as as long as your number of distinct values fits into 32 bit space, the current implementation should work.  So as a fix, want to try capping the size hint (to something like `INT32_MAX - 1`) and see if that fixes?\r\n\r\nhttps://github.com/pandas-dev/pandas/blob/1a12c41d201f56439510e683fadfed1218ea9067/pandas/core/algorithms.py#L473\r\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/422711739",
    "html_url": "https://github.com/pandas-dev/pandas/issues/22729#issuecomment-422711739",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/22729",
    "id": 422711739,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjcxMTczOQ==",
    "user": {
      "login": "MaxBenChrist",
      "id": 13162426,
      "node_id": "MDQ6VXNlcjEzMTYyNDI2",
      "avatar_url": "https://avatars3.githubusercontent.com/u/13162426?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MaxBenChrist",
      "html_url": "https://github.com/MaxBenChrist",
      "followers_url": "https://api.github.com/users/MaxBenChrist/followers",
      "following_url": "https://api.github.com/users/MaxBenChrist/following{/other_user}",
      "gists_url": "https://api.github.com/users/MaxBenChrist/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MaxBenChrist/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MaxBenChrist/subscriptions",
      "organizations_url": "https://api.github.com/users/MaxBenChrist/orgs",
      "repos_url": "https://api.github.com/users/MaxBenChrist/repos",
      "events_url": "https://api.github.com/users/MaxBenChrist/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MaxBenChrist/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-19T08:41:09Z",
    "updated_at": "2018-09-19T08:42:29Z",
    "author_association": "NONE",
    "body": "> But as as long as your number of distinct values fits into 32 bit space, the current implementation should work. So as a fix, want to try capping the size hint (to something like INT32_MAX - 1) and see if that fixes?\r\n\r\nI am pretty sure that this is the reason for the bug. However, we can deal with that. We can split the stacked dataframe into pieces and then calculate the chunk list. \r\n\r\nThanks for the help 👍 \r\n\r\n> khash, our hash table implementation, uses an 32 bit integer throughout for its sizes. maybe could change that, but would be quite invasive.\r\n\r\nDo you see this happening in the near future? \r\n\r\nI will check the performance of dask for this dask, we already use it in tsfresh anyway\r\n\r\nmarking blue-yonder/tsfresh#418\r\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/422807292",
    "html_url": "https://github.com/pandas-dev/pandas/issues/22729#issuecomment-422807292",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/22729",
    "id": 422807292,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjgwNzI5Mg==",
    "user": {
      "login": "chris-b1",
      "id": 1924092,
      "node_id": "MDQ6VXNlcjE5MjQwOTI=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/1924092?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chris-b1",
      "html_url": "https://github.com/chris-b1",
      "followers_url": "https://api.github.com/users/chris-b1/followers",
      "following_url": "https://api.github.com/users/chris-b1/following{/other_user}",
      "gists_url": "https://api.github.com/users/chris-b1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chris-b1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chris-b1/subscriptions",
      "organizations_url": "https://api.github.com/users/chris-b1/orgs",
      "repos_url": "https://api.github.com/users/chris-b1/repos",
      "events_url": "https://api.github.com/users/chris-b1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chris-b1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-19T13:39:21Z",
    "updated_at": "2018-09-19T13:39:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "Cool, in case it's not clear, we'd probably take a PR into pandas that caps the `size_hint`.  As the name implies, it's only a hint to khash to pre-allocate a bunch of memory, ultimately khash will reallocate as necessary based on the actual data."
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/423550378",
    "html_url": "https://github.com/pandas-dev/pandas/issues/22729#issuecomment-423550378",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/22729",
    "id": 423550378,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyMzU1MDM3OA==",
    "user": {
      "login": "MaxBenChrist",
      "id": 13162426,
      "node_id": "MDQ6VXNlcjEzMTYyNDI2",
      "avatar_url": "https://avatars3.githubusercontent.com/u/13162426?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MaxBenChrist",
      "html_url": "https://github.com/MaxBenChrist",
      "followers_url": "https://api.github.com/users/MaxBenChrist/followers",
      "following_url": "https://api.github.com/users/MaxBenChrist/following{/other_user}",
      "gists_url": "https://api.github.com/users/MaxBenChrist/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MaxBenChrist/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MaxBenChrist/subscriptions",
      "organizations_url": "https://api.github.com/users/MaxBenChrist/orgs",
      "repos_url": "https://api.github.com/users/MaxBenChrist/repos",
      "events_url": "https://api.github.com/users/MaxBenChrist/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MaxBenChrist/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-21T14:26:47Z",
    "updated_at": "2018-09-21T14:26:47Z",
    "author_association": "NONE",
    "body": "So, to sum up, the current maximal number of groups in an pandas groupby object is \r\n\r\n`2^31-1 = 2,147,483,647`. \r\n\r\nIf one creates an groupby object with more groups, it will fail with \"OverflowError: value too large to convert to int\".\r\n\r\nRegarding a PR: I am not really versatile in C, so I have no idea where I would start. I am not even sure I understand what would have to be changed inside pandas, you probably don't want to change that constant for a corner case (extremly large groupby objects)\r\n\r\n> Cool, in case it's not clear, we'd probably take a PR into pandas that caps the size_hint. As the name implies, it's only a hint to khash to pre-allocate a bunch of memory, ultimately khash will reallocate as necessary based on the actual data. \r\n\r\ncan you clarify this a little bit, what is `size_hint` ? a c method?\r\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/423745397",
    "html_url": "https://github.com/pandas-dev/pandas/issues/22729#issuecomment-423745397",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/22729",
    "id": 423745397,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyMzc0NTM5Nw==",
    "user": {
      "login": "chris-b1",
      "id": 1924092,
      "node_id": "MDQ6VXNlcjE5MjQwOTI=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/1924092?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/chris-b1",
      "html_url": "https://github.com/chris-b1",
      "followers_url": "https://api.github.com/users/chris-b1/followers",
      "following_url": "https://api.github.com/users/chris-b1/following{/other_user}",
      "gists_url": "https://api.github.com/users/chris-b1/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/chris-b1/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/chris-b1/subscriptions",
      "organizations_url": "https://api.github.com/users/chris-b1/orgs",
      "repos_url": "https://api.github.com/users/chris-b1/repos",
      "events_url": "https://api.github.com/users/chris-b1/events{/privacy}",
      "received_events_url": "https://api.github.com/users/chris-b1/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-22T13:47:06Z",
    "updated_at": "2018-09-22T13:47:06Z",
    "author_association": "CONTRIBUTOR",
    "body": "@MaxBenChrist, could you or a user try the PR #22805?  I think it should fix, but I don't have a machine with enough memory to do a full reproducing case.\r\n\r\nTo expand a bit, the underlying limitation is that the number of buckets (~distinct values + some empty space) in the hash table is limited to UINT32_MAX (2^32).  But your code wasn't making it that far, it was overflowing on the `size_hint` parameter, which is only used for initial allocation.  So capping that won't impact the normal use case."
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/424322580",
    "html_url": "https://github.com/pandas-dev/pandas/issues/22729#issuecomment-424322580",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/22729",
    "id": 424322580,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQyNDMyMjU4MA==",
    "user": {
      "login": "MaxBenChrist",
      "id": 13162426,
      "node_id": "MDQ6VXNlcjEzMTYyNDI2",
      "avatar_url": "https://avatars3.githubusercontent.com/u/13162426?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MaxBenChrist",
      "html_url": "https://github.com/MaxBenChrist",
      "followers_url": "https://api.github.com/users/MaxBenChrist/followers",
      "following_url": "https://api.github.com/users/MaxBenChrist/following{/other_user}",
      "gists_url": "https://api.github.com/users/MaxBenChrist/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MaxBenChrist/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MaxBenChrist/subscriptions",
      "organizations_url": "https://api.github.com/users/MaxBenChrist/orgs",
      "repos_url": "https://api.github.com/users/MaxBenChrist/repos",
      "events_url": "https://api.github.com/users/MaxBenChrist/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MaxBenChrist/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-09-25T12:27:36Z",
    "updated_at": "2018-09-25T12:27:36Z",
    "author_association": "NONE",
    "body": "@chris-b1 Thanks for the pr! I am also lacking a big memory machine, maybe @yuval-nardi can try it? \r\n\r\nOtherwise I have to setup a vm this weekend. "
  }
]
