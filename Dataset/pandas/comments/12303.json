[
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/183130480",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-183130480",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 183130480,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4MzEzMDQ4MA==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-12T00:47:16Z",
    "updated_at": "2016-02-12T00:47:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "can you show an example w/o all of the custom builds. Just stock numpy and latest pandas (or a version).\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/183133272",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-183133272",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 183133272,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4MzEzMzI3Mg==",
    "user": {
      "login": "vonosmas",
      "id": 8649250,
      "node_id": "MDQ6VXNlcjg2NDkyNTA=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/8649250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vonosmas",
      "html_url": "https://github.com/vonosmas",
      "followers_url": "https://api.github.com/users/vonosmas/followers",
      "following_url": "https://api.github.com/users/vonosmas/following{/other_user}",
      "gists_url": "https://api.github.com/users/vonosmas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vonosmas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vonosmas/subscriptions",
      "organizations_url": "https://api.github.com/users/vonosmas/orgs",
      "repos_url": "https://api.github.com/users/vonosmas/repos",
      "events_url": "https://api.github.com/users/vonosmas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vonosmas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-12T00:52:57Z",
    "updated_at": "2016-02-12T00:52:57Z",
    "author_association": "NONE",
    "body": "No: you need to recompile C code in NumPy for the error to be reported (otherwise NaN is somehow silently converted to a long under the hood when you're running `pandas/tests/test_groupby.py:TestGroupBy.test_agg_nested_dicts`. I can try to pinpoint the exact place in pandas source code which causes this behavior.\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/183136246",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-183136246",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 183136246,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4MzEzNjI0Ng==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-12T00:59:15Z",
    "updated_at": "2016-02-12T00:59:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "so what exactly is the problem, are these crashing for you?\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/183150504",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-183150504",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 183150504,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4MzE1MDUwNA==",
    "user": {
      "login": "vonosmas",
      "id": 8649250,
      "node_id": "MDQ6VXNlcjg2NDkyNTA=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/8649250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vonosmas",
      "html_url": "https://github.com/vonosmas",
      "followers_url": "https://api.github.com/users/vonosmas/followers",
      "following_url": "https://api.github.com/users/vonosmas/following{/other_user}",
      "gists_url": "https://api.github.com/users/vonosmas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vonosmas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vonosmas/subscriptions",
      "organizations_url": "https://api.github.com/users/vonosmas/orgs",
      "repos_url": "https://api.github.com/users/vonosmas/repos",
      "events_url": "https://api.github.com/users/vonosmas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vonosmas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-12T02:14:43Z",
    "updated_at": "2016-02-12T02:14:43Z",
    "author_association": "NONE",
    "body": "They are crashing in a custom setup, where I build everything from source with Clang and `-fsanitize=float-cast-overflow` enabled. I understand it's not the way people usually numpy/pandas (i.e. not what you get from `easy_install`). However, the bug report shows an actual undefined behavior, and the result of casting NaN to int can be different under different compilers/versions, and is known to be different on different architectures.\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/183154081",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-183154081",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 183154081,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4MzE1NDA4MQ==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-12T02:42:27Z",
    "updated_at": "2016-02-12T02:42:27Z",
    "author_association": "CONTRIBUTOR",
    "body": "well you shouldn't _ever_ use `easy_install`, that is really old, at the very least use `pip` or much better is using `conda`. \n\nIn any event would need an actual reproducible example on a stock install. As these tests work just fine at a glance. maybe I am missing something here.\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/183338038",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-183338038",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 183338038,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4MzMzODAzOA==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-12T13:52:07Z",
    "updated_at": "2016-02-12T13:52:07Z",
    "author_association": "CONTRIBUTOR",
    "body": "if you can provide a reproducible example that demonstrates a failure on stock numpy and pandas master, pls reopen.\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/184859839",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-184859839",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 184859839,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NDg1OTgzOQ==",
    "user": {
      "login": "vonosmas",
      "id": 8649250,
      "node_id": "MDQ6VXNlcjg2NDkyNTA=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/8649250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vonosmas",
      "html_url": "https://github.com/vonosmas",
      "followers_url": "https://api.github.com/users/vonosmas/followers",
      "following_url": "https://api.github.com/users/vonosmas/following{/other_user}",
      "gists_url": "https://api.github.com/users/vonosmas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vonosmas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vonosmas/subscriptions",
      "organizations_url": "https://api.github.com/users/vonosmas/orgs",
      "repos_url": "https://api.github.com/users/vonosmas/repos",
      "events_url": "https://api.github.com/users/vonosmas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vonosmas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-16T20:14:50Z",
    "updated_at": "2016-02-16T20:14:50Z",
    "author_association": "NONE",
    "body": "Your call - I totally understand it's hard to deal with the \"issues\" that are exposed in non-standard build configurations.\n\nHowever, undefined behavior is tricky and dangerous - and if we can reliably detect it, it's worth fixing it sooner rather than later, when compilers gets smarter and will break your code in unexpected ways.\n\nI'd argue that converting NaN to integer is never correct, and usually indicates an error in logic - even if the code currently generated in the stock builds happens to work for all the use cases - this is happening by accident. I've installed faulthandler to collect the stack trace of pandas triggering the issue:\n\n  File \"/pandas/pandas/core/common.py\", line 1362 in _possibly_downcast_to_dtype\n  File \"/pandas/pandas/core/groupby.py\", line 715 in _try_cast\n  File \"/pandas/pandas/core/groupby.py\", line 748 in _cython_agg_general\n  File \"/pandas/pandas/core/groupby.py\", line 996 in var\n  File \"/pandas/pandas/core/groupby.py\", line 979 in std\n  File \"/pandas/pandas/core/groupby.py\", line 2526 in aggregate\n  File \"/pandas/pandas/core/groupby.py\", line 2595 in _aggregate_multiple_funcs\n  File \"/pandas/pandas/core/groupby.py\", line 2529 in aggregate\n  File \"/pandas/pandas/core/groupby.py\", line 2595 in _aggregate_multiple_funcs\n  File \"/pandas/pandas/core/groupby.py\", line 2529 in aggregate\n  File \"/pandas/pandas/core/base.py\", line 475 in _agg_1dim\n  File \"/pandas/pandas/core/base.py\", line 492 in _agg\n  File \"/pandas/pandas/core/base.py\", line 501 in _aggregate\n  File \"/pandas/pandas/core/groupby.py\", line 3052 in aggregate\n  File \"/pandas/pandas/core/groupby.py\", line 3535 in aggregate\n\nSo, it seems that _possibly_downcast_to_dtype calls `np.allclose` on NaN, and NaN converted to integral data type. I'd argue that NaN should be special-cased here: as converting NaN to int gives unpredictable results.\n\nIf you don't want to deal with these issues now (while everything \"works\") - fine, let's just leave the bug. If you want to - I can provide help with building/testing code or patches against UB.\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/184860768",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-184860768",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 184860768,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NDg2MDc2OA==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-16T20:18:25Z",
    "updated_at": "2016-02-16T20:18:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "@vonosmas you would have to show what this is being called. `np.allclose` in that function is NEVER called with anything but bool/int dtype.\n\nAs I said, need a reproducible example.\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/184874743",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-184874743",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 184874743,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NDg3NDc0Mw==",
    "user": {
      "login": "vonosmas",
      "id": 8649250,
      "node_id": "MDQ6VXNlcjg2NDkyNTA=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/8649250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vonosmas",
      "html_url": "https://github.com/vonosmas",
      "followers_url": "https://api.github.com/users/vonosmas/followers",
      "following_url": "https://api.github.com/users/vonosmas/following{/other_user}",
      "gists_url": "https://api.github.com/users/vonosmas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vonosmas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vonosmas/subscriptions",
      "organizations_url": "https://api.github.com/users/vonosmas/orgs",
      "repos_url": "https://api.github.com/users/vonosmas/repos",
      "events_url": "https://api.github.com/users/vonosmas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vonosmas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-16T21:07:33Z",
    "updated_at": "2016-02-16T21:07:33Z",
    "author_association": "NONE",
    "body": "`dtype` is integral, but result is not:\n\n``` python\n$ git diff pandas/core/common.py\n--- a/pandas/core/common.py\n+++ b/pandas/core/common.py\n@@ -1359,6 +1359,7 @@ def _possibly_downcast_to_dtype(result, dtype):\n             # do a test on the first element, if it fails then we are done\n             r = result.ravel()\n             arr = np.array([r[0]])\n+            print arr, dtype\n             if not np.allclose(arr, trans(arr).astype(dtype)):\n                 return result\n$ cat test.py\nimport numpy as np\nfrom pandas import DataFrame\n\nif __name__ == '__main__':\n  df = DataFrame({'A': ['foo', 'bar', 'foo', 'bar',\n                        'foo', 'bar', 'foo', 'foo'],\n                  'B': ['one', 'one', 'two', 'two',\n                        'two', 'two', 'one', 'two'],\n                  'C': np.random.randn(8) + 1.0,\n                  'D': np.arange(8)})\n\n  g = df.groupby(['A', 'B'])\n\n  result = g.agg({'C': {'ra': ['mean', 'std']},\n                  'D': {'rb': ['mean', 'std']}})\n$ python test.py\n[ 1.] int64\n[ nan] int64\n```\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/184885297",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-184885297",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 184885297,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NDg4NTI5Nw==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-16T21:42:09Z",
    "updated_at": "2016-02-16T21:42:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "This should patch it.\n\n```\ndiff --git a/pandas/core/common.py b/pandas/core/common.py\nindex 6165297..dee566a 100644\n--- a/pandas/core/common.py\n+++ b/pandas/core/common.py\n@@ -1359,7 +1359,8 @@ def _possibly_downcast_to_dtype(result, dtype):\n             # do a test on the first element, if it fails then we are done\n             r = result.ravel()\n             arr = np.array([r[0]])\n-            if not np.allclose(arr, trans(arr).astype(dtype)):\n+            if isnull(arr).any() or not np.allclose(arr,\n+                                                    trans(arr).astype(dtype)):\n                 return result\n\n             # a comparable, e.g. a Decimal may slip in here\n```\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/184916802",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-184916802",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 184916802,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NDkxNjgwMg==",
    "user": {
      "login": "vonosmas",
      "id": 8649250,
      "node_id": "MDQ6VXNlcjg2NDkyNTA=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/8649250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vonosmas",
      "html_url": "https://github.com/vonosmas",
      "followers_url": "https://api.github.com/users/vonosmas/followers",
      "following_url": "https://api.github.com/users/vonosmas/following{/other_user}",
      "gists_url": "https://api.github.com/users/vonosmas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vonosmas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vonosmas/subscriptions",
      "organizations_url": "https://api.github.com/users/vonosmas/orgs",
      "repos_url": "https://api.github.com/users/vonosmas/repos",
      "events_url": "https://api.github.com/users/vonosmas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vonosmas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-16T23:21:12Z",
    "updated_at": "2016-02-16T23:21:12Z",
    "author_association": "NONE",
    "body": "Thank you, confirmed! Another failure (extracted from `pandas/tests/test_groupby.py:TestGroupBy.test_count_cross_type`):\n\n``` python\n$ cat test.py\nimport numpy as np\nfrom pandas import DataFrame\nimport faulthandler\n\nif __name__ == '__main__':\n  faulthandler.enable()\n  vals = np.hstack((np.random.randint(0, 5, (100, 2)), np.random.randint(\n      0, 2, (100, 2))))\n\n  df = DataFrame(vals, columns=['a', 'b', 'c', 'd'])\n  df[df == 2] = np.nan\n```\n\nwhich yields:\n\n```\n$ python test.py\nnumpy/core/src/multiarray/lowlevel_strided_loops.c.src:867:22: runtime error: value nan is outside the range of representable values of type 'long'\nFatal Python error: Aborted\n\nCurrent thread 0x00007f5eec71a7c0 (most recent call first):\n  File \"/pandas/pandas/core/internals.py\", line 4393 in _putmask_smart\n  File \"/pandas/pandas/core/internals.py\", line 809 in putmask\n  File \"/pandas/pandas/core/internals.py\", line 2801 in apply\n  File \"/pandas/pandas/core/internals.py\", line 2824 in putmask\n  File \"/pandas/pandas/pandas/core/generic.py\", line 4406 in where\n  File \"/pandas/pandas/pandas/core/frame.py\", line 2374 in _setitem_frame\n  File \"/pandas/pandas/pandas/core/frame.py\", line 2336 in __setitem__\n  File \"test.py\", line 11 in <module>\n```\n\nI don't know if assignment `df[df == 2] = np.nan` is in fact valid here, or the problem is in the test case. Same applies to the code in `test_cython_group_transform_algos`:\n\n``` python\nactual = np.zeros_like(data, dtype='int64')\nactual.fill(np.nan)\n```\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/184931336",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-184931336",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 184931336,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NDkzMTMzNg==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-17T00:00:52Z",
    "updated_at": "2016-02-17T00:00:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "ok, will close it with the PR\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/184935911",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-184935911",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 184935911,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NDkzNTkxMQ==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-17T00:14:46Z",
    "updated_at": "2016-02-17T00:14:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "see #12360 should fix all of the issues you have reported..\n\nunfort I cannot really test with these, but at least added some comments\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/184943940",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-184943940",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 184943940,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NDk0Mzk0MA==",
    "user": {
      "login": "vonosmas",
      "id": 8649250,
      "node_id": "MDQ6VXNlcjg2NDkyNTA=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/8649250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vonosmas",
      "html_url": "https://github.com/vonosmas",
      "followers_url": "https://api.github.com/users/vonosmas/followers",
      "following_url": "https://api.github.com/users/vonosmas/following{/other_user}",
      "gists_url": "https://api.github.com/users/vonosmas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vonosmas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vonosmas/subscriptions",
      "organizations_url": "https://api.github.com/users/vonosmas/orgs",
      "repos_url": "https://api.github.com/users/vonosmas/repos",
      "events_url": "https://api.github.com/users/vonosmas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vonosmas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-17T00:45:37Z",
    "updated_at": "2016-02-17T00:45:37Z",
    "author_association": "NONE",
    "body": "Another example, where you might consider removing `fill(np.nan)` calls in `_cython_operation`:\n\n``` python\n$ git diff pandas/core/groupby.diff\n--- a/pandas/core/groupby.py\n+++ b/pandas/core/groupby.py\n@@ -1732,6 +1732,7 @@ class BaseGrouper(object):\n                 result, counts, values, labels, func, is_numeric)\n         elif kind == 'transform':\n             result = np.empty_like(values, dtype=out_dtype)\n+            print out_dtype\n             result.fill(np.nan)\n             # temporary storange for running-total type tranforms\n             accum = np.empty(out_shape, dtype=out_dtype)\n$ cat test.py\nimport numpy as np\nfrom pandas import DataFrame\nimport faulthandler\n\nif __name__ == '__main__':\n  faulthandler.enable()\n\n  df = DataFrame({'int': [1, 1, 1, 1, 2] * 200})\n  labels = np.random.randint(0, 50, size=1000).astype(float)\n  gb_target = dict(by=labels)\n  gb = df.groupby(**gb_target)\n  gb.transform('cumsum', *()).sort_index(axis=1)\n$ python test.py\ni8\nnumpy/core/src/multiarray/lowlevel_strided_loops.c.src:867:22: runtime error: value nan is outside the range of representable values of type 'long'\n\n  File \"/pandas/pandas/core/groupby.py\", line 1735 in _cython_operation\n  File \"/pandas/pandas/core/groupby.py\", line 1777 in transform\n  File \"/pandas/pandas/core/groupby.py\", line 727 in _cython_transform\n  File \"/pandas/pandas/core/groupby.py\", line 1283 in cumsum\n  File \"/pandas/pandas/core/groupby.py\", line 3390 in transform\n  File \"test.py\", line 12 in <module>\n```\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/184957845",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-184957845",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 184957845,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NDk1Nzg0NQ==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-17T01:07:10Z",
    "updated_at": "2016-02-17T01:07:10Z",
    "author_association": "CONTRIBUTOR",
    "body": "updated. lmk if any more!\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/184958220",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-184958220",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 184958220,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NDk1ODIyMA==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-17T01:07:50Z",
    "updated_at": "2016-02-17T01:07:50Z",
    "author_association": "CONTRIBUTOR",
    "body": "these are indeed edge cases where we shouldn't be doing something, but numpy 'allows'  as just casts it to the min int, generally not what we want.\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/185201596",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-185201596",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 185201596,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NTIwMTU5Ng==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-17T13:19:16Z",
    "updated_at": "2016-02-17T13:19:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "@vonosmas thanks for the reports, this is now merged. If you find any more you can post here.\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/185348815",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-185348815",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 185348815,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NTM0ODgxNQ==",
    "user": {
      "login": "vonosmas",
      "id": 8649250,
      "node_id": "MDQ6VXNlcjg2NDkyNTA=",
      "avatar_url": "https://avatars0.githubusercontent.com/u/8649250?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vonosmas",
      "html_url": "https://github.com/vonosmas",
      "followers_url": "https://api.github.com/users/vonosmas/followers",
      "following_url": "https://api.github.com/users/vonosmas/following{/other_user}",
      "gists_url": "https://api.github.com/users/vonosmas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vonosmas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vonosmas/subscriptions",
      "organizations_url": "https://api.github.com/users/vonosmas/orgs",
      "repos_url": "https://api.github.com/users/vonosmas/repos",
      "events_url": "https://api.github.com/users/vonosmas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vonosmas/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-17T18:57:53Z",
    "updated_at": "2016-02-17T18:57:53Z",
    "author_association": "NONE",
    "body": "Thank you for fixing these! I've rebased and ran the entire test suite (sorry for not doing this earlier). Six test cases indicated errors, I've extracted the code patterns that trigger them (see below):\n\n``` python\n$ cat test.py\nimport numpy as np\nimport pandas as pd\nfrom pandas import DataFrame\nfrom pandas import Series\nfrom pandas import RangeIndex\nfrom pandas.tests.frame.common import TestData\nimport faulthandler\nimport sys\n\nif __name__ == '__main__':\n  faulthandler.enable()\n\n  # Test case 1 (test_groupby_cumprod)\n  # (pandas.tests.test_groupby.TestGroupBy)\n  # Overflow: casting floating-point 2^63 to int64.\n  if sys.argv[1] == '1':\n    df = DataFrame({'key': ['b'] * 100, 'value': 2})\n    actual = df.groupby('key')['value'].cumprod()\n\n  # Test case 2 (test_timedelta_ops_with_missing_values)\n  # (pandas.tseries.tests.test_timedeltas.TestTimedeltas)\n  # Casting NaN to long.\n  if sys.argv[1] == '2':\n    df1 = DataFrame(['00:00:01']).apply(pd.to_timedelta)\n    timedelta_NaT = pd.to_timedelta('NaT')\n    actual = df1 + timedelta_NaT\n\n  # Test case 3 (test_NaT_cast)\n  # (pandas.tseries.tests.test_timeseries.TestSeriesDatetime64)\n  # Casting NaN to long.\n  if sys.argv[1] == '3':\n    s = Series([np.nan]).astype('M8[ns]')\n\n  # Test case 4 (test_constructor_maskedarray)\n  # (pandas.tests.frame.test_constructors.TestDataFrameConstructors)\n  # Casting NaN to long.\n  if sys.argv[1] == '4':\n    mat = np.ma.masked_all((2, 3), dtype=float)\n    df = DataFrame(mat, columns=['A', 'B', 'C'],\n                   index=[1, 2], dtype=np.int64)\n\n  # Test case 5 (test_astype)\n  # (pandas.tests.frame.test_dtypes.TestDataFrameDataTypes)\n  # Overflow: casting large floating-point (>1e14) to int32.\n  if sys.argv[1] == '5':\n    mn = TestData().all_mixed._get_numeric_data().copy()\n    mn['big_float'] = np.array(123456789101112., dtype='float64')\n    casted = mn.astype('int32')\n\n  # Test case 6 (test_binops)\n  # (pandas.tests.indexes.test_range.TestRangeIndex)\n  # Casting \"inf\" to long.\n  if sys.argv[1] == '6':\n    a = RangeIndex(0, 20, 2)\n    b = RangeIndex(-10, 10, 2)\n    result = pow(a, b)\n```\n\nRunning them with float-cast-overflow detection yields:\n\n```\n$ python test.py 1\nnumpy/core/src/multiarray/lowlevel_strided_loops.c.src:867:22: runtime error: value 9.22337e+18 is outside the range of representable values of type 'long'\n  File \"/pandas/pandas/core/common.py\", line 1402 in _possibly_downcast_to_dtype\n  File \"/pandas/pandas/core/groupby.py\", line 716 in _try_cast\n  File \"/pandas/pandas/core/groupby.py\", line 731 in _cython_transform\n  File \"/pandas/pandas/core/groupby.py\", line 1275 in cumprod\n  File \"test.py\", line 18 in <module>\n\n$ python test.py 2\nnumpy/core/src/multiarray/arraytypes.c.src:1020:17: runtime error: value nan is outside the range of representable values of type 'long'\n  File \"/pandas/pandas/core/internals.py\", line 1510 in _try_coerce_result\n  File \"/pandas/pandas/core/internals.py\", line 1086 in get_result\n  File \"/pandas/pandas/core/internals.py\", line 1102 in eval\n  File \"/pandas/pandas/core/internals.py\", line 2814 in apply\n  File \"/pandas/pandas/core/internals.py\", line 2831 in eval\n  File \"/pandas/pandas/core/frame.py\", line 3533 in _combine_const\n  File \"/pandas/pandas/core/ops.py\", line 1089 in f\n  File \"test.py\", line 26 in <module>\n\n$ python test.py 3\nnumpy/core/src/multiarray/arraytypes.c.src:1020:17: runtime error: value nan is outside the range of representable values of type 'long'\n  File \"/pandas/pandas/core/common.py\", line 2631 in _astype_nansafe\n  File \"/pandas/pandas/core/internals.py\", line 465 in _astype\n  File \"/pandas/pandas/core/internals.py\", line 422 in astype\n  File \"/pandas/pandas/core/internals.py\", line 2814 in apply\n  File \"/pandas/pandas/core/internals.py\", line 2855 in astype\n  File \"/pandas/pandas/core/generic.py\", line 2887 in astype\n  File \"test.py\", line 32 in <module>\n\n$ python test.py 4\nnumpy/core/src/multiarray/lowlevel_strided_loops.c.src:867:22: runtime error: value nan is outside the range of representable values of type 'long'\n  File \"/pandas/pandas/core/frame.py\", line 417 in _init_ndarray\n  File \"/pandas/pandas/core/frame.py\", line 240 in __init__\n  File \"test.py\", line 40 in <module>\n\n$ python test.py 5\nnumpy/core/src/multiarray/lowlevel_strided_loops.c.src:867:22: runtime error: value 1.23457e+14 is outside the range of representable values of type 'int'\n  File \"/pandas/pandas/core/common.py\", line 2631 in _astype_nansafe\n  File \"/pandas/pandas/core/internals.py\", line 465 in _astype\n  File \"/pandas/pandas/core/internals.py\", line 422 in astype\n  File \"/pandas/pandas/core/internals.py\", line 2814 in apply\n  File \"/pandas/pandas/core/internals.py\", line 2855 in astype\n  File \"/pandas/pandas/core/generic.py\", line 2887 in astype\n  File \"test.py\", line 48 in <module>\n\n$ python test.py 6\nnumpy/core/src/umath/loops.c.src:918:30: runtime error: value inf is outside the range of representable values of type 'long'\n  File \"/pandas/pandas/indexes/base.py\", line 3152 in _evaluate_numeric_binop\n  File \"test.py\", line 56 in <module>\n```\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/185351347",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-185351347",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 185351347,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NTM1MTM0Nw==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-17T19:02:36Z",
    "updated_at": "2016-02-17T19:02:36Z",
    "author_association": "CONTRIBUTOR",
    "body": "@vonosmas gr8 thanks. I'll take a look.\n"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/185352746",
    "html_url": "https://github.com/pandas-dev/pandas/issues/12303#issuecomment-185352746",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/12303",
    "id": 185352746,
    "node_id": "MDEyOklzc3VlQ29tbWVudDE4NTM1Mjc0Ng==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-02-17T19:05:25Z",
    "updated_at": "2016-02-17T19:05:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "let me reopen so won't forget\n"
  }
]
