[
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/402662263",
    "html_url": "https://github.com/pandas-dev/pandas/issues/21741#issuecomment-402662263",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/21741",
    "id": 402662263,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwMjY2MjI2Mw==",
    "user": {
      "login": "sschuldenzucker",
      "id": 1100776,
      "node_id": "MDQ6VXNlcjExMDA3NzY=",
      "avatar_url": "https://avatars3.githubusercontent.com/u/1100776?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sschuldenzucker",
      "html_url": "https://github.com/sschuldenzucker",
      "followers_url": "https://api.github.com/users/sschuldenzucker/followers",
      "following_url": "https://api.github.com/users/sschuldenzucker/following{/other_user}",
      "gists_url": "https://api.github.com/users/sschuldenzucker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sschuldenzucker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sschuldenzucker/subscriptions",
      "organizations_url": "https://api.github.com/users/sschuldenzucker/orgs",
      "repos_url": "https://api.github.com/users/sschuldenzucker/repos",
      "events_url": "https://api.github.com/users/sschuldenzucker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sschuldenzucker/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-05T09:26:39Z",
    "updated_at": "2018-07-05T09:26:39Z",
    "author_association": "NONE",
    "body": "FYI, as for the question why pandas creates such a HDF5, I think I figured it out:\r\n\r\nIn my code, I was doing some data conversions that turned out to be ultimately akin to something like:\r\n\r\n```\r\ns = pd.Series(['foo', nan, 'bar', 'foo']).astype(str).astype('category')\r\n```\r\n\r\nTurned out that this creates a regular category `'nan'` (not `nan`, mind the quotes!). This is then written to HDF. `'nan'` also happens to be the default `nan_rep` used by pytables, so when pytables reads the categories in the HDF file back in, it's converted into `nan` (without quotes). So we now have a `nan` category, which leads to the offending code being executed."
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/402663730",
    "html_url": "https://github.com/pandas-dev/pandas/issues/21741#issuecomment-402663730",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/21741",
    "id": 402663730,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwMjY2MzczMA==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-05T09:31:46Z",
    "updated_at": "2018-07-05T09:31:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "pls show a reproducible example "
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/402682587",
    "html_url": "https://github.com/pandas-dev/pandas/issues/21741#issuecomment-402682587",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/21741",
    "id": 402682587,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwMjY4MjU4Nw==",
    "user": {
      "login": "sschuldenzucker",
      "id": 1100776,
      "node_id": "MDQ6VXNlcjExMDA3NzY=",
      "avatar_url": "https://avatars3.githubusercontent.com/u/1100776?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sschuldenzucker",
      "html_url": "https://github.com/sschuldenzucker",
      "followers_url": "https://api.github.com/users/sschuldenzucker/followers",
      "following_url": "https://api.github.com/users/sschuldenzucker/following{/other_user}",
      "gists_url": "https://api.github.com/users/sschuldenzucker/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sschuldenzucker/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sschuldenzucker/subscriptions",
      "organizations_url": "https://api.github.com/users/sschuldenzucker/orgs",
      "repos_url": "https://api.github.com/users/sschuldenzucker/repos",
      "events_url": "https://api.github.com/users/sschuldenzucker/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sschuldenzucker/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-05T10:44:53Z",
    "updated_at": "2018-07-05T10:44:53Z",
    "author_association": "NONE",
    "body": "MWE:\r\n\r\n```python\r\nimport pandas as pd\r\nimport numpy as np\r\n\r\n# Note: We need a repeated entry here. It happens to not crash if #rows = #categories. \r\n# (coincidentally; it's still doing the wrong thing of course.)\r\ns = pd.Series(['foo', 'foo', 'nan']).astype('category')\r\n# Alternatively:\r\n# s = pd.Series(['foo', 'foo', np.nan]).astype(str).astype('category')\r\n\r\ndf = pd.DataFrame({'A': s})\r\ndf.to_hdf('test.h5', key='data', format='table')\r\ndf_back = pd.read_hdf('test.h5', key='data') # This crashes\r\n```\r\n\r\nI'm on pandas 0.20.1 btw, but I don't think the issue is fixed in more recent versions."
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/402794843",
    "html_url": "https://github.com/pandas-dev/pandas/issues/21741#issuecomment-402794843",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/21741",
    "id": 402794843,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQwMjc5NDg0Mw==",
    "user": {
      "login": "jreback",
      "id": 953992,
      "node_id": "MDQ6VXNlcjk1Mzk5Mg==",
      "avatar_url": "https://avatars2.githubusercontent.com/u/953992?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jreback",
      "html_url": "https://github.com/jreback",
      "followers_url": "https://api.github.com/users/jreback/followers",
      "following_url": "https://api.github.com/users/jreback/following{/other_user}",
      "gists_url": "https://api.github.com/users/jreback/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jreback/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jreback/subscriptions",
      "organizations_url": "https://api.github.com/users/jreback/orgs",
      "repos_url": "https://api.github.com/users/jreback/repos",
      "events_url": "https://api.github.com/users/jreback/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jreback/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-07-05T17:23:33Z",
    "updated_at": "2018-07-05T17:23:33Z",
    "author_association": "CONTRIBUTOR",
    "body": "you need to use ``nan_rep`` http://pandas.pydata.org/pandas-docs/stable/io.html#string-columns\r\n\r\nI guess you could detect this issue though, a PR to fix is welcome!"
  },
  {
    "url": "https://api.github.com/repos/pandas-dev/pandas/issues/comments/458419485",
    "html_url": "https://github.com/pandas-dev/pandas/issues/21741#issuecomment-458419485",
    "issue_url": "https://api.github.com/repos/pandas-dev/pandas/issues/21741",
    "id": 458419485,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1ODQxOTQ4NQ==",
    "user": {
      "login": "joseortiz3",
      "id": 18585219,
      "node_id": "MDQ6VXNlcjE4NTg1MjE5",
      "avatar_url": "https://avatars3.githubusercontent.com/u/18585219?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/joseortiz3",
      "html_url": "https://github.com/joseortiz3",
      "followers_url": "https://api.github.com/users/joseortiz3/followers",
      "following_url": "https://api.github.com/users/joseortiz3/following{/other_user}",
      "gists_url": "https://api.github.com/users/joseortiz3/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/joseortiz3/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/joseortiz3/subscriptions",
      "organizations_url": "https://api.github.com/users/joseortiz3/orgs",
      "repos_url": "https://api.github.com/users/joseortiz3/repos",
      "events_url": "https://api.github.com/users/joseortiz3/events{/privacy}",
      "received_events_url": "https://api.github.com/users/joseortiz3/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-01-29T06:09:51Z",
    "updated_at": "2019-01-29T06:22:12Z",
    "author_association": "NONE",
    "body": "Ran into this problem today, same exact scenario where the string `'nan'` is a value in the column due to using `df[col_name] = df[col_name].astype(str).astype('category')`.\r\n\r\n```python\r\n>>> df_mixed = pd.DataFrame({'A': np.random.randn(8),\r\n... 'B': np.random.randn(8),\r\n... 'C': np.array(np.random.randn(8), dtype='float32'),\r\n... 'string': 'string',\r\n... 'int': 1,\r\n... 'bool': True,\r\n... 'datetime64': pd.Timestamp('20010102')},\r\n... index=list(range(8)))\r\n>>> df_mixed\r\n          A         B         C  string  int  bool datetime64\r\n0 -0.833346 -0.598527  1.013500  string    1  True 2001-01-02\r\n1 -0.823901 -0.118210  0.793684  string    1  True 2001-01-02\r\n2  0.725413 -0.867698  1.478408  string    1  True 2001-01-02\r\n3 -0.246141  0.786121  1.483667  string    1  True 2001-01-02\r\n4  1.760388  1.675248  1.169727  string    1  True 2001-01-02\r\n5 -0.000398  0.039454  1.514879  string    1  True 2001-01-02\r\n6 -2.815542 -0.539987 -1.873862  string    1  True 2001-01-02\r\n7  0.791794 -0.031423  1.250562  string    1  True 2001-01-02\r\n>>> df_mixed.loc[df_mixed.index[3:5],\r\n... ['A', 'B', 'string', 'datetime64']] = np.nan\r\n>>> df_mixed\r\n          A         B         C  string  int  bool datetime64\r\n0 -0.833346 -0.598527  1.013500  string    1  True 2001-01-02\r\n1 -0.823901 -0.118210  0.793684  string    1  True 2001-01-02\r\n2  0.725413 -0.867698  1.478408  string    1  True 2001-01-02\r\n3       NaN       NaN  1.483667     NaN    1  True        NaT\r\n4       NaN       NaN  1.169727     NaN    1  True        NaT\r\n5 -0.000398  0.039454  1.514879  string    1  True 2001-01-02\r\n6 -2.815542 -0.539987 -1.873862  string    1  True 2001-01-02\r\n7  0.791794 -0.031423  1.250562  string    1  True 2001-01-02\r\n>>> df_mixed['string'].iloc[4]\r\nnan\r\n>>> type(df_mixed['string'].iloc[4])\r\n<class 'float'>\r\n>>> df_mixed['string'] = df_mixed['string'].astype(str).astype('category')\r\n>>> df_mixed\r\n          A         B         C  string  int  bool datetime64\r\n0 -0.833346 -0.598527  1.013500  string    1  True 2001-01-02\r\n1 -0.823901 -0.118210  0.793684  string    1  True 2001-01-02\r\n2  0.725413 -0.867698  1.478408  string    1  True 2001-01-02\r\n3       NaN       NaN  1.483667     nan    1  True        NaT\r\n4       NaN       NaN  1.169727     nan    1  True        NaT\r\n5 -0.000398  0.039454  1.514879  string    1  True 2001-01-02\r\n6 -2.815542 -0.539987 -1.873862  string    1  True 2001-01-02\r\n7  0.791794 -0.031423  1.250562  string    1  True 2001-01-02\r\n>>> df_mixed['string'].iloc[4]\r\n'nan'\r\n>>> df_mixed.to_hdf(dir+'hdf.hdf',key='df_mixed',format='table')\r\n>>> df_mixed2 = pd.read_hdf(dir+'hdf.hdf',key='df_mixed',format='table')\r\n```\r\nresults in the error\r\n```\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"C:\\Users\\Joey\\AppData\\Local\\Programs\\Python\\Python37\\lib\\site-packages\\pandas\\io\\pytables.py\", line 394, in read_hdf\r\n    return store.select(key, auto_close=auto_close, **kwargs)\r\n  File \"C:\\Users\\Joey\\AppData\\Local\\Programs\\Python\\Python37\\lib\\site-packages\\pandas\\io\\pytables.py\", line 741, in select\r\n    return it.get_result()\r\n  File \"C:\\Users\\Joey\\AppData\\Local\\Programs\\Python\\Python37\\lib\\site-packages\\pandas\\io\\pytables.py\", line 1483, in get_result\r\n    results = self.func(self.start, self.stop, where)\r\n  File \"C:\\Users\\Joey\\AppData\\Local\\Programs\\Python\\Python37\\lib\\site-packages\\pandas\\io\\pytables.py\", line 734, in func\r\n    columns=columns)\r\n  File \"C:\\Users\\Joey\\AppData\\Local\\Programs\\Python\\Python37\\lib\\site-packages\\pandas\\io\\pytables.py\", line 4180, in read\r\n    if not self.read_axes(where=where, **kwargs):\r\n  File \"C:\\Users\\Joey\\AppData\\Local\\Programs\\Python\\Python37\\lib\\site-packages\\pandas\\io\\pytables.py\", line 3383, in read_axes\r\n    errors=self.errors)\r\n  File \"C:\\Users\\Joey\\AppData\\Local\\Programs\\Python\\Python37\\lib\\site-packages\\pandas\\io\\pytables.py\", line 2177, in convert\r\n    codes[codes != -1] -= mask.astype(int).cumsum().values\r\nValueError: operands could not be broadcast together with shapes (8,) (2,) (8,) \r\n```\r\nHow to [temporarily until a PR] fix it using `nan_rep=np.nan` (not `nan_rep='nan'`, also this parameter's documentation is lacking)\r\n```python\r\n>>> df_mixed.to_hdf(dir+'hdf.hdf',key='df_mixed',format='table',nan_rep=np.nan)\r\n>>> df_mixed2 = pd.read_hdf(dir+'hdf.hdf',key='df_mixed',format='table')\r\n```"
  }
]
