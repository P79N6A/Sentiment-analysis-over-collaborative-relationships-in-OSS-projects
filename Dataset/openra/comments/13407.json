[
  {
    "url": "https://api.github.com/repos/OpenRA/OpenRA/issues/comments/315557937",
    "html_url": "https://github.com/OpenRA/OpenRA/pull/13407#issuecomment-315557937",
    "issue_url": "https://api.github.com/repos/OpenRA/OpenRA/issues/13407",
    "id": 315557937,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTU1NzkzNw==",
    "user": {
      "login": "forcecore",
      "id": 632278,
      "node_id": "MDQ6VXNlcjYzMjI3OA==",
      "avatar_url": "https://avatars0.githubusercontent.com/u/632278?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/forcecore",
      "html_url": "https://github.com/forcecore",
      "followers_url": "https://api.github.com/users/forcecore/followers",
      "following_url": "https://api.github.com/users/forcecore/following{/other_user}",
      "gists_url": "https://api.github.com/users/forcecore/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/forcecore/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/forcecore/subscriptions",
      "organizations_url": "https://api.github.com/users/forcecore/orgs",
      "repos_url": "https://api.github.com/users/forcecore/repos",
      "events_url": "https://api.github.com/users/forcecore/events{/privacy}",
      "received_events_url": "https://api.github.com/users/forcecore/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-15T19:52:15Z",
    "updated_at": "2017-07-15T19:52:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "Probable cause is reuse of \"this\" in the activities through SequenceActivities and with the extensive rewrite of activities is on the way, this should do for now, I think."
  },
  {
    "url": "https://api.github.com/repos/OpenRA/OpenRA/issues/comments/315917036",
    "html_url": "https://github.com/OpenRA/OpenRA/pull/13407#issuecomment-315917036",
    "issue_url": "https://api.github.com/repos/OpenRA/OpenRA/issues/13407",
    "id": 315917036,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTkxNzAzNg==",
    "user": {
      "login": "reaperrr",
      "id": 2857877,
      "node_id": "MDQ6VXNlcjI4NTc4Nzc=",
      "avatar_url": "https://avatars3.githubusercontent.com/u/2857877?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/reaperrr",
      "html_url": "https://github.com/reaperrr",
      "followers_url": "https://api.github.com/users/reaperrr/followers",
      "following_url": "https://api.github.com/users/reaperrr/following{/other_user}",
      "gists_url": "https://api.github.com/users/reaperrr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/reaperrr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/reaperrr/subscriptions",
      "organizations_url": "https://api.github.com/users/reaperrr/orgs",
      "repos_url": "https://api.github.com/users/reaperrr/repos",
      "events_url": "https://api.github.com/users/reaperrr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/reaperrr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-17T23:47:15Z",
    "updated_at": "2017-07-17T23:47:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "@pchote Any objections about merging this before the playtest (or merging it at all)?"
  },
  {
    "url": "https://api.github.com/repos/OpenRA/OpenRA/issues/comments/317185813",
    "html_url": "https://github.com/OpenRA/OpenRA/pull/13407#issuecomment-317185813",
    "issue_url": "https://api.github.com/repos/OpenRA/OpenRA/issues/13407",
    "id": 317185813,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNzE4NTgxMw==",
    "user": {
      "login": "pchote",
      "id": 167819,
      "node_id": "MDQ6VXNlcjE2NzgxOQ==",
      "avatar_url": "https://avatars1.githubusercontent.com/u/167819?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pchote",
      "html_url": "https://github.com/pchote",
      "followers_url": "https://api.github.com/users/pchote/followers",
      "following_url": "https://api.github.com/users/pchote/following{/other_user}",
      "gists_url": "https://api.github.com/users/pchote/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pchote/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pchote/subscriptions",
      "organizations_url": "https://api.github.com/users/pchote/orgs",
      "repos_url": "https://api.github.com/users/pchote/repos",
      "events_url": "https://api.github.com/users/pchote/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pchote/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-22T14:05:02Z",
    "updated_at": "2017-07-22T14:05:02Z",
    "author_association": "MEMBER",
    "body": "@reaperrr: returning `NextActivity` effectively cancels the `DeliverResources` activity.  The old behaviour was to wait a bit and then run `NextInQueue` which I assume should have been what `OnDock` queued.  I would need to spend more time trying to understand the spaghetti of the unload logic before I could comment on whether this is the best fix for the problem, or whether it is likely to regress other things."
  },
  {
    "url": "https://api.github.com/repos/OpenRA/OpenRA/issues/comments/317284882",
    "html_url": "https://github.com/OpenRA/OpenRA/pull/13407#issuecomment-317284882",
    "issue_url": "https://api.github.com/repos/OpenRA/OpenRA/issues/13407",
    "id": 317284882,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNzI4NDg4Mg==",
    "user": {
      "login": "obrakmann",
      "id": 4331210,
      "node_id": "MDQ6VXNlcjQzMzEyMTA=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/4331210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/obrakmann",
      "html_url": "https://github.com/obrakmann",
      "followers_url": "https://api.github.com/users/obrakmann/followers",
      "following_url": "https://api.github.com/users/obrakmann/following{/other_user}",
      "gists_url": "https://api.github.com/users/obrakmann/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/obrakmann/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/obrakmann/subscriptions",
      "organizations_url": "https://api.github.com/users/obrakmann/orgs",
      "repos_url": "https://api.github.com/users/obrakmann/repos",
      "events_url": "https://api.github.com/users/obrakmann/events{/privacy}",
      "received_events_url": "https://api.github.com/users/obrakmann/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-23T21:53:48Z",
    "updated_at": "2017-07-23T21:53:48Z",
    "author_association": "CONTRIBUTOR",
    "body": "The problem here is that `Refinery.OnDock()` queues its activities onto the wrong activity. `harv.CurrentActivity` is still the initial `FindResources` that gets queued when the \"Harvest\" order is given.\r\n\r\nThe block of the `harv.IsFull` check in `FindResources` however breaks the queue (it just returns a fresh `DeliverResources` activity, and `FindResources.NextActivity` is usually null at that point). This is a nice example why [this comment](https://github.com/OpenRA/OpenRA/blob/bleed/OpenRA.Game/Activities/Activity.cs#L37) exists.\r\n\r\nBut the `iao.OnDock()` call in `DeliverResources` causes the activities to be queued to the harvester's `CurrentActivity`, which is still `FindResources`, and essentially a dead end. When the tick ends, that `FindResources` activity will be left behind, and `DeliverResources` will be the `CurrentActivity`.\r\n\r\nThe patch below fixes it. I'm going to leave the wrong queuing behaviour after the `harv.IsFull` check in, just because I don't particularly feel like messing with the potential fallout of changing that.\r\n\r\n```diff\r\ndiff --git a/OpenRA.Mods.Common/Traits/Buildings/Refinery.cs b/OpenRA.Mods.Common/Traits/Buildings/Refinery.cs\r\nindex 97d4c47..497f958 100644\r\n--- a/OpenRA.Mods.Common/Traits/Buildings/Refinery.cs\r\n+++ b/OpenRA.Mods.Common/Traits/Buildings/Refinery.cs\r\n@@ -139,12 +139,12 @@ public void OnDock(Actor harv, DeliverResources dockOrder)\r\n                {\r\n                        if (!preventDock)\r\n                        {\r\n-                               harv.QueueActivity(new CallFunc(() => dockedHarv = harv, false));\r\n-                               harv.QueueActivity(DockSequence(harv, self));\r\n-                               harv.QueueActivity(new CallFunc(() => dockedHarv = null, false));\r\n+                               dockOrder.Queue(new CallFunc(() => dockedHarv = harv, false));\r\n+                               dockOrder.Queue(DockSequence(harv, self));\r\n+                               dockOrder.Queue(new CallFunc(() => dockedHarv = null, false));\r\n                        }\r\n \r\n-                       harv.QueueActivity(new CallFunc(() => harv.Trait<Harvester>().ContinueHarvesting(harv)));\r\n+                       dockOrder.Queue(new CallFunc(() => harv.Trait<Harvester>().ContinueHarvesting(harv)));\r\n                }\r\n \r\n                void INotifyOwnerChanged.OnOwnerChanged(Actor self, Player oldOwner, Player newOwner)\r\n```"
  },
  {
    "url": "https://api.github.com/repos/OpenRA/OpenRA/issues/comments/317285017",
    "html_url": "https://github.com/OpenRA/OpenRA/pull/13407#issuecomment-317285017",
    "issue_url": "https://api.github.com/repos/OpenRA/OpenRA/issues/13407",
    "id": 317285017,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNzI4NTAxNw==",
    "user": {
      "login": "forcecore",
      "id": 632278,
      "node_id": "MDQ6VXNlcjYzMjI3OA==",
      "avatar_url": "https://avatars0.githubusercontent.com/u/632278?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/forcecore",
      "html_url": "https://github.com/forcecore",
      "followers_url": "https://api.github.com/users/forcecore/followers",
      "following_url": "https://api.github.com/users/forcecore/following{/other_user}",
      "gists_url": "https://api.github.com/users/forcecore/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/forcecore/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/forcecore/subscriptions",
      "organizations_url": "https://api.github.com/users/forcecore/orgs",
      "repos_url": "https://api.github.com/users/forcecore/repos",
      "events_url": "https://api.github.com/users/forcecore/events{/privacy}",
      "received_events_url": "https://api.github.com/users/forcecore/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-23T21:55:56Z",
    "updated_at": "2017-07-23T21:55:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "I'm planning a BIG one that almost eliminates SequenceActivities from the harvesting activities and changes reservation/dock stuff radically. It is stabilized by 1000 games of AI vs AI games and I've been waiting for the Playtest, which is the best time window to make a PR for this."
  },
  {
    "url": "https://api.github.com/repos/OpenRA/OpenRA/issues/comments/317285402",
    "html_url": "https://github.com/OpenRA/OpenRA/pull/13407#issuecomment-317285402",
    "issue_url": "https://api.github.com/repos/OpenRA/OpenRA/issues/13407",
    "id": 317285402,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNzI4NTQwMg==",
    "user": {
      "login": "obrakmann",
      "id": 4331210,
      "node_id": "MDQ6VXNlcjQzMzEyMTA=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/4331210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/obrakmann",
      "html_url": "https://github.com/obrakmann",
      "followers_url": "https://api.github.com/users/obrakmann/followers",
      "following_url": "https://api.github.com/users/obrakmann/following{/other_user}",
      "gists_url": "https://api.github.com/users/obrakmann/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/obrakmann/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/obrakmann/subscriptions",
      "organizations_url": "https://api.github.com/users/obrakmann/orgs",
      "repos_url": "https://api.github.com/users/obrakmann/repos",
      "events_url": "https://api.github.com/users/obrakmann/events{/privacy}",
      "received_events_url": "https://api.github.com/users/obrakmann/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-23T22:02:08Z",
    "updated_at": "2017-07-23T22:02:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "That sounds nice, looking forward to it. We should probably still try to get this small fix into the next release, IMO."
  },
  {
    "url": "https://api.github.com/repos/OpenRA/OpenRA/issues/comments/317445879",
    "html_url": "https://github.com/OpenRA/OpenRA/pull/13407#issuecomment-317445879",
    "issue_url": "https://api.github.com/repos/OpenRA/OpenRA/issues/13407",
    "id": 317445879,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNzQ0NTg3OQ==",
    "user": {
      "login": "obrakmann",
      "id": 4331210,
      "node_id": "MDQ6VXNlcjQzMzEyMTA=",
      "avatar_url": "https://avatars1.githubusercontent.com/u/4331210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/obrakmann",
      "html_url": "https://github.com/obrakmann",
      "followers_url": "https://api.github.com/users/obrakmann/followers",
      "following_url": "https://api.github.com/users/obrakmann/following{/other_user}",
      "gists_url": "https://api.github.com/users/obrakmann/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/obrakmann/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/obrakmann/subscriptions",
      "organizations_url": "https://api.github.com/users/obrakmann/orgs",
      "repos_url": "https://api.github.com/users/obrakmann/repos",
      "events_url": "https://api.github.com/users/obrakmann/events{/privacy}",
      "received_events_url": "https://api.github.com/users/obrakmann/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-24T14:45:26Z",
    "updated_at": "2017-07-24T14:45:26Z",
    "author_association": "CONTRIBUTOR",
    "body": "Opened #13714 to supersede this one for the next release then"
  }
]
